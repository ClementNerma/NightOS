<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Inter-process communication - NightOS documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design and specification documents for NightOS">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NightOS documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ClementNerma/NightOS" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="inter-process-communication"><a class="header" href="#inter-process-communication">Inter-Process Communication</a></h1>
<p>This document describes the way <a href="../../technical/ipc.html">Inter-Process Communication (IPC)</a> works.</p>
<ul>
<li><a href="#pipes">Pipes</a>
<ul>
<li><a href="#opening-pipes">Opening pipes</a></li>
<li><a href="#pipes-pending-data">Pipes' pending data</a></li>
<li><a href="#pipes-locking">Pipes locking</a></li>
<li><a href="#closing-pipes">Closing pipes</a></li>
<li><a href="#message-pipes">Message pipes</a></li>
<li><a href="#interactive-usage">Interactive usage</a></li>
</ul>
</li>
<li><a href="#service-sockets">Service sockets</a>
<ul>
<li><a href="#opening">Opening</a></li>
<li><a href="#exchanges-and-messages">Exchanges and messages</a></li>
<li><a href="#concluding-exchanges">Concluding exchanges</a></li>
<li><a href="#methods-and-notifications">Methods and notifications</a></li>
<li><a href="#closing-service-sockets">Closing service sockets</a></li>
</ul>
</li>
<li><a href="#shared-memory">Shared Memory</a></li>
</ul>
<h2 id="pipes"><a class="header" href="#pipes">Pipes</a></h2>
<p><em>Inter-process Uni-directional Channels</em> (IUC), also called <em>pipes</em>, allow two distinct processes to communicate.</p>
<p>Pipes are made of two uni-directional parts:</p>
<ul>
<li>A <em>sender channel</em> (SC) which can only be written to (write-only)</li>
<li>A <em>receiver channel</em> (RC), which can only be read from (read-only)</li>
</ul>
<p>The two processes sharing a pipes are:</p>
<ul>
<li>The <em>sender process</em>, which uses the SC to send data to the other process</li>
<li>The <em>receiver process</em>, which uses the RC to retrieve data sent by the other process</li>
</ul>
<p>The process that creates the pipe gets both the SC and the RC, and is expected to provide one of them to another process.</p>
<p>Each SC and RC has a unique identifier, which is binded to the process that created it.<br />
The process receiving an SC or RC receives another identifier for it, unique to that process, which prevents IDs collisions.</p>
<h3 id="opening-pipes"><a class="header" href="#opening-pipes">Opening pipes</a></h3>
<p>A process can open a pipe with another process using the <a href="syscalls.html#0x20-open_pipe"><code>OPEN_PIPE</code></a> syscall.</p>
<p>The other process will then receive the <a href="signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal. If no handler is set when the signal is sent, the opening syscall fails.</p>
<h3 id="pipes-pending-data"><a class="header" href="#pipes-pending-data">Pipes' pending data</a></h3>
<p>When a pipe is written to, the data is written to a memory zone. This zone is called the <em>pipe's buffer</em> and it's content is called the <em>pending data</em>.<br />
When a pipe is read from, the pending data is progressively retrieved, erased as the read progresses.</p>
<p>The default size of the pipe's buffer is 64 KB, but this can be extended to up to 16 MB during its creation.
When it is reached, no data can be written to the pipe anymore, meaning the other process must read data from it in order to free space to write it.</p>
<h3 id="pipes-locking"><a class="header" href="#pipes-locking">Pipes locking</a></h3>
<p>When a pipe is being written to or read from, it is <em>locked</em>, which means no other writing or reading can happen during this time. This prevents data races which are a common source of bugs which are complex to debug, while not compromising performances.</p>
<h3 id="closing-pipes"><a class="header" href="#closing-pipes">Closing pipes</a></h3>
<p>Any of the two processes (be it the receiver or the sender) can close a pipe using the <a href="syscalls.html#0x25-close_pipe"><code>CLOSE_PIPE</code></a> syscall, providing its SC or RC identifier. The pipe is immediatly closed on both sides, and the other process receives the <a href="signals.html#0x21-pipe_closed"><code>PIPE_CLOSED</code></a> signal.</p>
<h3 id="message-pipes"><a class="header" href="#message-pipes">Message pipes</a></h3>
<p>Pipes are designed to transmit streams of data, but sometimes we need to use them to transmit messages. This is why there are specific <a href="syscalls.html">syscalls</a> and <a href="signals.html">signals</a> to deal with this problem.</p>
<p>A <em>message pipe</em> is a pipe that only sends and receives dynamic-sized messages instead of a stream of bytes.<br />
They have a maximum length of 64 KB, which is the pipes' buffer's minimal capacity. Messages must always be sent at once and cannot be sent partially.<br />
Their length is determined when the message is sent which, coupled to <a href="#pipes-locking">pipes locking</a>, allows to retrieve complete messages directly.</p>
<p>It's not possible to send "non-message" data through a message pipe, as the action of writing to a pipe will automatically check if it's a message pipe and ensure the size and "send at once" requirement are met.</p>
<h3 id="interactive-usage"><a class="header" href="#interactive-usage">Interactive usage</a></h3>
<p>You can find more informations on interactive usage in the <a href="../shell.html#interactivity">shell specifications</a>.</p>
<h2 id="service-sockets"><a class="header" href="#service-sockets">Service sockets</a></h2>
<p>The downside of message pipes is that they are not designed to handle responses from the receiver process, and they also don't have built-in errors handling.</p>
<p>To solve this, it's possible to use <em>service sockets</em>, which as their name indicate are mainly used to communicate with <a href="../services.html">services</a>. A socket is caracterized by the process opening it, called the <em>service</em>, and the process receiving it, the <em>client</em>.</p>
<h3 id="opening"><a class="header" href="#opening">Opening</a></h3>
<p>Sockets are opened with the <a href="syscalls.html#0x26-open_serv_sock"><code>OPEN_SERV_SOCK</code></a> syscall. The other process receives the <a href="signals.html#0x26-recv_serv_sock"><code>RECV_SERV_SOCK</code></a> signal on its side.</p>
<h3 id="exchanges-and-messages"><a class="header" href="#exchanges-and-messages">Exchanges and messages</a></h3>
<p>Service sockets are based on <em>exchanges</em>, which are sets of messages. An exchange is described by a structure made of the following:</p>
<ul>
<li>Identifier (8 bytes)</li>
<li>Method or notification code (2 bytes)</li>
<li>Status (1 byte): <code>0x01</code> if the exchange must be closed, <code>0x00</code> otherwise</li>
<li>Error code (on 2 bytes) - only valid if the exchange is closed by this message</li>
<li>Message counter for this exchange (2 bytes)</li>
<li>Message's length (2 bytes)</li>
</ul>
<p>This structure is handled by the kernel itself and can be managed using a set of system calls and signals.</p>
<p>Messages can then be sent using the <a href="syscalls.html#0x27-send_sock_msg"><code>SEND_SOCK_MSG</code></a> syscall and received through the <a href="signals.html#0x27-recv_sock_msg"><code>RECV_SOCK_MSG</code></a> signal. To be read, the receiver process must use the <a href="syscalls.html#0x28-read_sock_msg"><code>READ_SOCK_MSG</code></a> syscall.</p>
<p>They must be sent at once, like in message pipes. The maximum size is 4 KB by default, but can be extended through the opening syscall up to 256 MB.</p>
<p>A message can either <em>initiate</em> an exchange or <em>answer</em> to an existing one: in the first case, an identifier will be generated by the kernel and returned by the sending syscall, and in the latter the message will receive an incremented identifier that allows to track where in the exchange the message is. This also prevents a process to send two messages before the other one answers.</p>
<h3 id="concluding-exchanges"><a class="header" href="#concluding-exchanges">Concluding exchanges</a></h3>
<p>Exchanges can be either be <em>concluded</em> either by sending an error message or by sending a message with a close indicator to indicate this message will be the last one in the socket and no answer will be accepted.</p>
<p>Sending a message in a concluded exchange will result in a syscall error.</p>
<h3 id="methods-and-notifications"><a class="header" href="#methods-and-notifications">Methods and notifications</a></h3>
<p>An exchange can be opened by a client to request something to the service, it is then called a <em>method</em>. In that case, the message's body is called the <em>arguments</em>.</p>
<p>When the server opens itself an exchange with the client, it's called a <em>notification</em>. A notification message's body is called its <em>data</em>.</p>
<h3 id="closing-service-sockets"><a class="header" href="#closing-service-sockets">Closing service sockets</a></h3>
<p>Service sockets can be closed with the <a href="syscalls.html#0x29-close_serv_sock"><code>CLOSE_SERV_SOCK</code></a> syscall, which triggers the <a href="signals.html#0x29-serv_sock_closed"><code>SERV_SOCK_CLOSED</code></a> signal on the other process' side.</p>
<p>Although exchanges are based on signals which are asynchronous by design, the answer mechanism and messages tracking which ensures the receiver process answers before sending another message allows for simplier communications and synchronization between the two processes.</p>
<h2 id="shared-memory"><a class="header" href="#shared-memory">Shared Memory</a></h2>
<p>Shared memory allows a process to share a part of its memory with another process. It has multiple advantages over pipes:</p>
<ul>
<li>Data is not copied twice, as the sender process directly shares a part of its own memory</li>
<li>There is no pipe management, which results in saving operations and less memory accesses</li>
<li>There is no pipe buffer to manage which means all the data can be sent at once</li>
</ul>
<p>Its main disadvantage being that all data is shared at once, so there is no synchronization or "asynchronous sending" mechanism, which is the purpose of pipes.</p>
<p>It works by asking the kernel to share the memory through the <a href="syscalls.html#0x42-share_ams"><code>SHARE_AMS</code></a> syscall, the target process receiving the <a href="signals.html#0x35-recv_shared_ams"><code>RECV_SHARED_AMS</code></a> signal.</p>
<p>There are two types of sharing:</p>
<ul>
<li><em>Mutual</em> sharing allows both the sharer and the receiver processes to access the shared memory ;</li>
<li><em>Exclusive</em> sharing unmaps the shared memory from the sharer and only allows the receiver process to access it</li>
</ul>
<p>Exclusive mode has several advantages: the sender process to not have to care about managing this memory and avoid overwriting it by accident, but it also ensures the receiving process that the sender will not perform malicious modifications on the shared buffer while the data is processed on its side.</p>
<p>Mutual memory sharing can be stopped using the <a href="syscalls.html#0x44-unshare_ams"><code>UNSHARE_AMS</code></a> syscall, while exclusive sharing are left to the receiver process.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../specs/kernel/kpc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../specs/kernel/signals.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../specs/kernel/kpc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../specs/kernel/signals.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

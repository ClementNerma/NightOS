<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Services - NightOS documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Design and specification documents for NightOS">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NightOS documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ClementNerma/NightOS" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="services"><a class="header" href="#services">Services</a></h1>
<p>This document describes the architecture of <a href="../technical/services.html">services</a>, as well as the list of all system services and their main features.</p>
<ul>
<li><a href="#types-of-services">Types of services</a></li>
<li><a href="#architecture-of-a-service">Architecture of a service</a>
<ul>
<li><a href="#connections">Connections</a></li>
<li><a href="#communication">Communication</a></li>
<li><a href="#thread-types">Thread types</a></li>
<li><a href="#closing-a-connection">Closing a connection</a></li>
</ul>
</li>
<li><a href="#system-services">System services</a></li>
<li><a href="#third-party-communication">Third-party communication</a></li>
</ul>
<h2 id="types-of-services"><a class="header" href="#types-of-services">Types of services</a></h2>
<p>An application can expose four types of service:</p>
<ul>
<li>A <em>main service</em>, which is used as the default one</li>
<li><em>Scoped services</em>, which are used as interfaces for conventional tasks between applications which are not specific to the current one</li>
<li><em>Integration services</em>, which are used to interact with the system in specific ways (see <a href="services/integration/README.html">the complete list</a>)</li>
<li><em>Driver services</em>, which are used to interact with hardware devices through the <a href="services/system/hw.html"><code>sys::hw</code></a> service.</li>
</ul>
<p>A scope's name is made of up to 8 extended ASCII characters.</p>
<p>Applications exposing integration services get special recognition for the tasks associated to these services. These services are not available directly to the end applications ; they can only be used through <a href="services/system/README.html">system services</a>.</p>
<h2 id="architecture-of-a-service"><a class="header" href="#architecture-of-a-service">Architecture of a service</a></h2>
<p>Applications have exactly one running process per service, and each service has exactly one running instance per active user, to prevent a user to connect to the service of a user with more privileges than itself. System services, on their side, only have one global instance.</p>
<p>An application process can tell if it was started as a service or not by looking at its <a href="applications.html#execution-context">execution context</a>.</p>
<p>Once a service process indicates it's ready using the <a href="kernel/syscalls.html#0x04-ready"><code>READY</code></a> syscall, other processes will be able to <em>connect</em> to this service.</p>
<h3 id="connections"><a class="header" href="#connections">Connections</a></h3>
<p>A <em>connection</em> essentially consists of a <a href="kernel/ipc.html#service-sockets">service socket</a> between a service and another process called its <em>client</em>.</p>
<p>When a process wants to connect to a service, it uses the <a href="kernel/syscalls.html#0x2a-connect_service"><code>CONNECT_SERVICE</code></a> to send a <em>connection request</em> to this service.</p>
<p>The service process then receives the request through the <a href="kernel/signals.html#0x2a-service_conn_request"><code>SERVICE_CONN_REQUEST</code></a>.</p>
<p>It is expected to answer under a short delay specified in the <a href="registry.html">registry</a>'s <code>system.processes.service_answer_delay</code> key (2000 ms by default).</p>
<p>If the service refuses the connection, it provides its answer through the <a href="kernel/syscalls.html#0x2d-reject_service_conn"><code>REJECT_SERVICE_CONN</code></a> syscall, and the procedure stops here.</p>
<p>Else, it accepts it through the <a href="kernel/syscalls.html#0x2c-accept_service_conn"><code>ACCEPT_SERVICE_CONN</code></a> syscall. A new thread is then created in the service's process, and the signal returns with a code indicating if the current thread is the one that was just created.</p>
<h3 id="communication"><a class="header" href="#communication">Communication</a></h3>
<p>The service and its client(s) communicate through the service socket created during the connection.</p>
<p>The different message formats a client can send to a service are a called the service's <em>methods</em>, while the different message formats the service may send to a client are called the service's <em>notifications</em>.</p>
<h3 id="thread-types"><a class="header" href="#thread-types">Thread types</a></h3>
<p>A service process' main thread is called its <em>dispatcher threads</em>, while threads created using the <a href="kernel/syscalls.html#0x2c-accept_service_conn"><code>ACCEPT_SERVICE_CONN</code></a> syscall are called <em>client threads</em>.</p>
<h3 id="closing-a-connection"><a class="header" href="#closing-a-connection">Closing a connection</a></h3>
<p>The service cannot terminate a connection by itself.
If a client thread terminates brutally, the <a href="kernel/signals.html#0x2d-service_server_quitted"><code>SERVICE_SERVER_QUITTED</code></a> signal will be sent to its client.</p>
<p>Only clients can properly close a connection to a service, using the <a href="kernel/syscalls.html#0x2b-end_service_conn"><code>END_SERVICE_CONN</code></a> syscall. The service socket is then immediatly closed (on both the client and the thread's side).</p>
<p>The service then receives the <a href="kernel/signals.html#0x2c-service_client_quitted"><code>SERVICE_CLIENT_QUITTED</code></a> signal.</p>
<p>If the client terminates brutally (before the connection was properly ended), the client thread receives the <a href="kernel/signals.html#0x2b-service_client_closed"><code>SERVICE_CLIENT_CLOSED</code></a> signal.</p>
<p>When a client thread receives on these two signals, it is expected to end as soon as possible (though there is no time limit).</p>
<h2 id="system-services"><a class="header" href="#system-services">System services</a></h2>
<p>System services are run by the system and get access to special <a href="kernel/syscalls.html">system calls</a> and <a href="kernel/signals.html">signals</a> that aren't available otherwise.</p>
<p>They also have a specific process identifier (PID) to identify them easily.</p>
<p>You can find the list of all system services in the <a href="services/system/README.html">related directory</a>.</p>
<h2 id="third-party-communication"><a class="header" href="#third-party-communication">Third-party communication</a></h2>
<p>An application can enable communication to and from other applications using a service.</p>
<p>For instance, let's consider two applications, A and B. If A wants to be able to be contacted by other applications (such as B), it sets up a service and subscribes to it. Then, when B sends a message to the service, it is forwarded to A through a notification by the service itself.</p>
<p>It can also work the other way: B subscribes to the service, and when A wants to contact B, it simply sends a message to B.</p>
<p>The downside of this structure is that latency is approximately doubled compared to a direct A-B communication. But as they use messages and notifications, which are based on hardware interrupts, the latency is extremely low, mainly composed of the time the kernel spends to ensure the communication between A and the service and then the service and B (or the other way around) is allowed.</p>
<p>Although this method works fine for small pieces of data, it isn't suited for transmitting large chunks in a performant way. For that purpose, A can <a href="kernel/memory.html#abstract-memory-segments">share a memory segment</a> with the service, who shares it in turn to B (with restricted permissions if required).</p>
<p>Note that this only applies to different applications ; processes from a same application can communicate directly through <a href="kernel/ipc.html">IPC</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../specs/crash-saves.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../specs/translations.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../specs/crash-saves.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../specs/translations.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

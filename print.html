<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NightOS documentation</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Design and specification documents for NightOS">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="FOREWORD.html"><strong aria-hidden="true">1.</strong> Foreword</a></li><li class="chapter-item expanded "><a href="FAQ.html"><strong aria-hidden="true">2.</strong> Frequently-asked questions</a></li><li class="chapter-item expanded "><a href="project/index.html"><strong aria-hidden="true">3.</strong> Project</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="project/roadmap.html"><strong aria-hidden="true">3.1.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="project/development.html"><strong aria-hidden="true">3.2.</strong> Development</a></li><li class="chapter-item expanded "><a href="project/hw-requirements.html"><strong aria-hidden="true">3.3.</strong> Hardware requirements</a></li></ol></li><li class="chapter-item expanded "><a href="concepts/index.html"><strong aria-hidden="true">4.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="concepts/applications.html"><strong aria-hidden="true">4.1.</strong> What are applications?</a></li><li class="chapter-item expanded "><a href="concepts/libraries.html"><strong aria-hidden="true">4.2.</strong> What are libraries?</a></li><li class="chapter-item expanded "><a href="concepts/users.html"><strong aria-hidden="true">4.3.</strong> What are users?</a></li></ol></li><li class="chapter-item expanded "><a href="features/index.html"><strong aria-hidden="true">5.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="features/balancer.html"><strong aria-hidden="true">5.1.</strong> The balancer</a></li><li class="chapter-item expanded "><a href="features/crash-saves.html"><strong aria-hidden="true">5.2.</strong> Crash saves</a></li><li class="chapter-item expanded "><a href="features/domains.html"><strong aria-hidden="true">5.3.</strong> Domains</a></li><li class="chapter-item expanded "><a href="features/encryption.html"><strong aria-hidden="true">5.4.</strong> Encryption</a></li><li class="chapter-item expanded "><a href="features/freeze-prevention.html"><strong aria-hidden="true">5.5.</strong> Freeze-prevention system</a></li><li class="chapter-item expanded "><a href="features/parental-control.html"><strong aria-hidden="true">5.6.</strong> Parental control</a></li><li class="chapter-item expanded "><a href="features/sandboxes.html"><strong aria-hidden="true">5.7.</strong> Sandboxes</a></li><li class="chapter-item expanded "><a href="features/synchronization.html"><strong aria-hidden="true">5.8.</strong> Synchronization</a></li></ol></li><li class="chapter-item expanded "><a href="technical/index.html"><strong aria-hidden="true">6.</strong> Technical</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="technical/controller.html"><strong aria-hidden="true">6.1.</strong> The controller</a></li><li class="chapter-item expanded "><a href="technical/dev-mode.html"><strong aria-hidden="true">6.2.</strong> Developer mode</a></li><li class="chapter-item expanded "><a href="technical/devices.html"><strong aria-hidden="true">6.3.</strong> Devices</a></li><li class="chapter-item expanded "><a href="technical/file-formats.html"><strong aria-hidden="true">6.4.</strong> File formats</a></li><li class="chapter-item expanded "><a href="technical/integrity-checker.html"><strong aria-hidden="true">6.5.</strong> Integrity checker</a></li><li class="chapter-item expanded "><a href="technical/io-manager.html"><strong aria-hidden="true">6.6.</strong> I/O manager</a></li><li class="chapter-item expanded "><a href="technical/multi-platform.html"><strong aria-hidden="true">6.7.</strong> Multi-platform management</a></li><li class="chapter-item expanded "><a href="technical/performances.html"><strong aria-hidden="true">6.8.</strong> Performances</a></li><li class="chapter-item expanded "><a href="technical/pre-compiling.html"><strong aria-hidden="true">6.9.</strong> Pre-compiling applications</a></li><li class="chapter-item expanded "><a href="technical/processes.html"><strong aria-hidden="true">6.10.</strong> Processes</a></li><li class="chapter-item expanded "><a href="technical/registry.html"><strong aria-hidden="true">6.11.</strong> The registry</a></li><li class="chapter-item expanded "><a href="technical/services.html"><strong aria-hidden="true">6.12.</strong> Services</a></li><li class="chapter-item expanded "><a href="technical/shell.html"><strong aria-hidden="true">6.13.</strong> The shell</a></li></ol></li><li class="chapter-item expanded "><a href="specs/index.html"><strong aria-hidden="true">7.</strong> Specifications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="specs/applications/context.html"><strong aria-hidden="true">7.1.</strong> Application context</a></li><li class="chapter-item expanded "><a href="specs/applications/package.html"><strong aria-hidden="true">7.2.</strong> Applications package</a></li><li class="chapter-item expanded "><a href="specs/applications/manifest.html"><strong aria-hidden="true">7.3.</strong> Applications manifest</a></li><li class="chapter-item expanded "><a href="specs/filesystem.html"><strong aria-hidden="true">7.4.</strong> Filesystem</a></li><li class="chapter-item expanded "><a href="specs/libraries.html"><strong aria-hidden="true">7.5.</strong> Libraries</a></li><li class="chapter-item expanded "><a href="specs/registry.html"><strong aria-hidden="true">7.6.</strong> The registry</a></li><li class="chapter-item expanded "><a href="specs/vocabulary.html"><strong aria-hidden="true">7.7.</strong> Vocabulary</a></li><li class="chapter-item expanded "><a href="specs/shell.html"><strong aria-hidden="true">7.8.</strong> The shell</a></li><li class="chapter-item expanded "><a href="specs/shell-scripting.html"><strong aria-hidden="true">7.9.</strong> Shell scripting</a></li><li class="chapter-item expanded "><a href="specs/services.html"><strong aria-hidden="true">7.10.</strong> Services</a></li><li class="chapter-item expanded "><a href="specs/kernel/index.html"><strong aria-hidden="true">7.11.</strong> Kernel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="specs/kernel/hardware.html"><strong aria-hidden="true">7.11.1.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="specs/kernel/memory.html"><strong aria-hidden="true">7.11.2.</strong> Memory</a></li><li class="chapter-item expanded "><a href="specs/kernel/processes.html"><strong aria-hidden="true">7.11.3.</strong> Processes</a></li><li class="chapter-item expanded "><a href="specs/kernel/data-structures.html"><strong aria-hidden="true">7.11.4.</strong> Data structures</a></li><li class="chapter-item expanded "><a href="specs/kernel/kpc.html"><strong aria-hidden="true">7.11.5.</strong> Kernel-process communication</a></li><li class="chapter-item expanded "><a href="specs/kernel/ipc.html"><strong aria-hidden="true">7.11.6.</strong> Inter-process communication</a></li><li class="chapter-item expanded "><a href="specs/kernel/signals.html"><strong aria-hidden="true">7.11.7.</strong> Signals</a></li><li class="chapter-item expanded "><a href="specs/kernel/syscalls.html"><strong aria-hidden="true">7.11.8.</strong> System calls</a></li></ol></li><li class="chapter-item expanded "><a href="specs/services/index.html"><strong aria-hidden="true">7.12.</strong> System services</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="specs/services/fs.html"><strong aria-hidden="true">7.12.1.</strong> sys::fs</a></li><li class="chapter-item expanded "><a href="specs/services/hw.html"><strong aria-hidden="true">7.12.2.</strong> sys::hw</a></li><li class="chapter-item expanded "><a href="specs/services/perm.html"><strong aria-hidden="true">7.12.3.</strong> sys::perm</a></li><li class="chapter-item expanded "><a href="specs/services/net.html"><strong aria-hidden="true">7.12.4.</strong> sys::net</a></li><li class="chapter-item expanded "><a href="specs/services/crypto.html"><strong aria-hidden="true">7.12.5.</strong> sys::crypto</a></li><li class="chapter-item expanded "><a href="specs/services/crashsave.html"><strong aria-hidden="true">7.12.6.</strong> sys::crashsave</a></li><li class="chapter-item expanded "><a href="specs/services/flow.html"><strong aria-hidden="true">7.12.7.</strong> sys::flow</a></li><li class="chapter-item expanded "><a href="specs/services/hydre.html"><strong aria-hidden="true">7.12.8.</strong> sys::hydre</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="applications/index.html"><strong aria-hidden="true">8.</strong> Applications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="applications/Astral.html"><strong aria-hidden="true">8.1.</strong> Astral</a></li><li class="chapter-item expanded "><a href="applications/BareEnv.html"><strong aria-hidden="true">8.2.</strong> BareEnv</a></li><li class="chapter-item expanded "><a href="applications/Blackhole.html"><strong aria-hidden="true">8.3.</strong> Blackhole</a></li><li class="chapter-item expanded "><a href="applications/Central.html"><strong aria-hidden="true">8.4.</strong> Central</a></li><li class="chapter-item expanded "><a href="applications/Cloudy.html"><strong aria-hidden="true">8.5.</strong> Cloudy</a></li><li class="chapter-item expanded "><a href="applications/Comet.html"><strong aria-hidden="true">8.6.</strong> Comet</a></li><li class="chapter-item expanded "><a href="applications/Gravity.html"><strong aria-hidden="true">8.7.</strong> Gravity</a></li><li class="chapter-item expanded "><a href="applications/Locky.html"><strong aria-hidden="true">8.8.</strong> Locky</a></li><li class="chapter-item expanded "><a href="applications/Milkshake.html"><strong aria-hidden="true">8.9.</strong> Milkshake</a></li><li class="chapter-item expanded "><a href="applications/Monitor.html"><strong aria-hidden="true">8.10.</strong> Monitor</a></li><li class="chapter-item expanded "><a href="applications/Nova.html"><strong aria-hidden="true">8.11.</strong> Nova</a></li><li class="chapter-item expanded "><a href="applications/Particle.html"><strong aria-hidden="true">8.12.</strong> Particle</a></li><li class="chapter-item expanded "><a href="applications/Pluton.html"><strong aria-hidden="true">8.13.</strong> Pluton</a></li><li class="chapter-item expanded "><a href="applications/Postal.html"><strong aria-hidden="true">8.14.</strong> Postal</a></li><li class="chapter-item expanded "><a href="applications/Reader.html"><strong aria-hidden="true">8.15.</strong> Reader</a></li><li class="chapter-item expanded "><a href="applications/Registry.html"><strong aria-hidden="true">8.16.</strong> Registry</a></li><li class="chapter-item expanded "><a href="applications/Rocket.html"><strong aria-hidden="true">8.17.</strong> Rocket</a></li><li class="chapter-item expanded "><a href="applications/ShootingStar.html"><strong aria-hidden="true">8.18.</strong> ShootingStar</a></li><li class="chapter-item expanded "><a href="applications/Skyer.html"><strong aria-hidden="true">8.19.</strong> Skyer</a></li><li class="chapter-item expanded "><a href="applications/Sonata.html"><strong aria-hidden="true">8.20.</strong> Sonata</a></li><li class="chapter-item expanded "><a href="applications/Stellar.html"><strong aria-hidden="true">8.21.</strong> Stellar</a></li><li class="chapter-item expanded "><a href="applications/Thinker.html"><strong aria-hidden="true">8.22.</strong> Thinker</a></li><li class="chapter-item expanded "><a href="applications/TimeTravel.html"><strong aria-hidden="true">8.23.</strong> TimeTravel</a></li><li class="chapter-item expanded "><a href="applications/Vortex.html"><strong aria-hidden="true">8.24.</strong> Vortex</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">NightOS documentation</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/ClementNerma/NightOS" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#foreword" id="foreword">Foreword</a></h1>
<h2><a class="header" href="#welcome" id="welcome">Welcome!</a></h2>
<p>Welcome to NightOS' documentation! This book will show you how the system is designed, how it works, and all the little things it can offer to the end user as well as the features availables for application developers.</p>
<p><strong>Before reading this documentation, please note that</strong> I'm developing this project on my own and I'm by no mean an operating system expert. I do not even as a professional low-level developer though I have some knowledge on how low-level software and hardware work to some extent.</p>
<p>This means there are surely many flaws in the very low-level aspects, especially in the microkernel, like the way hardware devices are handled and mapped in memory. If you find a flaw, feel free to fill an <a href="https://github.com/ClementNerma/NightOS/issues/new">issue</a>.</p>
<p>The main point of this project is the many middle-level/high-level aspects, not the very low-level ones which will take quite a lot of time to design completely and surely require the knowledge of people more experimented in this field than I am.</p>
<p>On the other hand, specification documents are not like specification documents you may have seen from, let's say, WhatWG or other consortiums. As NightOS is only a prototypal O.S., the documents you will find here are meant to be easily understandable. Specification documents are meant to describe completely a specific concept or part of the system, but without being hard to read. Some will argue it's not close enough to a &quot;real&quot; specification, but I think it's enough for now, regarding the very early state of the project.</p>
<p>Also, this project is far from being finished, so many things are still missing from the documentation. I frequently add new design documents and complete existing ones, but feel free to create a new issue if you think something should be added to the project :)</p>
<p>By the way, you can also find answers to the most <a href="FAQ.html">frequently-asked questions here</a>.</p>
<h2><a class="header" href="#what-is-nightos" id="what-is-nightos">What is NightOS?</a></h2>
<p>NightOS is an operating system aiming to replace ancient systems like Windows, Linux or MacOS. Well, this is the <em>ideal</em> goal but given how much Windows/Linux/MacOS and other systems are deeply installed in today's computers, NightOS is more of a theorical operating system that shows what we could get if we hadn't to maintain legacy compatibility with ancient architectures.</p>
<h2><a class="header" href="#what-another-os-why" id="what-another-os-why">What? Another O.S.? Why?</a></h2>
<p>The problem with current OSes like Windows, Linux or MacOS is they were built on bad roots. At the time they were created, security wasn't a concern like today, and computers weren't nearly as powerful as they are now. Which means a lot of things we have to deal with today in order to maintain a good level of security or performance isn't met at all with these systems, because they can't just be rewritten from scratch or break compatibility with older pieces of software.</p>
<p>NightOS, on its side, starts from a blank page. There is no compatibility to maintain on the software level, and everything is designed from the start to be future-proof, meaning it will be easy to add new security features for instance, without breaking any software compatibility.</p>
<h2><a class="header" href="#whats-the-projects-structure" id="whats-the-projects-structure">What's the project's structure?</a></h2>
<p>The project is composed of three distinct parts: the kernel, the system, and the desktop environment.</p>
<p>The first one is the part that allows the software to access the hardware, like writing files to the disk or making network requests. It's a microkernel, meaning it's easier to maintain and has a reduced attack surface for potential security issues than a monolithic kernel like Linux.
In its early stages though, we will use a the Linux kernel as a base, and the microkernel will be last &quot;brick&quot; to the project.</p>
<p>The system is the higher-level component that deals with everything that is not directly related to hardware or graphical interface. For instance, applications, user accounts and permissions are all managed by the system. It's a read-only part the user cannot modify by itself.</p>
<p>The desktop environment, finally, is the part the user sees when launching NightOS. It noteably contains the status bar, the windows manager, the notifications panel, and all graphical-related things.</p>
<p>The goal of NightOS is to provide an operating system that is far more <strong>secure, robust and performant</strong> than existing systems, and this for all users.</p>
<h2><a class="header" href="#what-license-is-this-project-distributed-under" id="what-license-is-this-project-distributed-under">What license is this project distributed under?</a></h2>
<p>The NightOS project uses the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>.</p>
<h2><a class="header" href="#special-thanks" id="special-thanks">Special thanks</a></h2>
<p>Thanks to <strong><a href="https://www.deviantart.com/rmradev">rmRander</a></strong> for providing the image that served as a base for this <a href="https://raw.githubusercontent.com/ClementNerma/NightOS/main/logo.png">project's logo</a>.
You can find the original picture <a href="https://www.deviantart.com/rmradev/art/Moon-sunset-landscape-825321054">here</a>.</p>
<h1><a class="header" href="#frequently-asked-questions" id="frequently-asked-questions">Frequently-Asked Questions</a></h1>
<p>Welcome to NightOS' FAQ. This document answers to common questions about the project, completing the <a href="FOREWORD.html">foreword</a>.</p>
<ul>
<li><a href="FAQ.html#this-project-seems-too-good-to-be-true">This project seems too good to be true</a></li>
<li><a href="FAQ.html#whats-the-current-state-of-the-project">What's the current state of the project?</a></li>
<li><a href="FAQ.html#will-this-project-replace-windowsmacoslinux-one-day">Will this project replace Windows/MacOS/Linux/... one day?</a></li>
<li><a href="FAQ.html#how-does-this-project-relates-to-nightos-v1-v2-and-v3">How does this project relates to NightOS v1, v2 and v3?</a></li>
<li><a href="FAQ.html#who-are-you">Who are you?</a></li>
<li><a href="FAQ.html#why-did-you-create-nightos">Why did you create NightOS?</a></li>
<li><a href="FAQ.html#how-can-i-help">How can I help?</a></li>
</ul>
<h2><a class="header" href="#this-project-seems-too-good-to-be-true" id="this-project-seems-too-good-to-be-true">This project seems too good to be true</a></h2>
<p>Well, it is in a way. NightOS can be designed as such a secure and robust O.S. because we chose to not maintain any backward compatibility with existing software - understand that existing applications from Linux, MacOS or Windows will <strong>not be compatible with NightOS</strong>. This is why we can afford to introduce so many new features and requirements current operating systems cannot.</p>
<p>The problem is that backward compatibility is absolutely mandatory when it comes to creating a general-purpose operating system. All applications would have to be developed again (in fact, they would just have to be <em>adapted</em> for NightOS, but that's still quite a bit of work) in order to run on this system, which is of course unfeasable today.</p>
<p>This is why NightOS will probably never be completed. The current goal of this project is to build a <strong>theorical O.S.</strong> that demonstrates how good of an O.S. we could make if we hadn't to worry about backward compatibility. When the theorical specifications will be complete, we shall start to develop the O.S. itself but that will require a lot of work beforehand.</p>
<p>Still, we do all we can to maintain as much compatibility as we can. For instance, we are currently investigating how existing Linux applications may be ran on NightOS, with a system call wrapper that would allow them to run correctly on the system, without compromising security, but with lacking features of course.</p>
<h2><a class="header" href="#whats-the-current-state-of-the-project" id="whats-the-current-state-of-the-project">What's the current state of the project?</a></h2>
<p>The project is currently in its very early stages. You can find more informations about this in the <a href="project/roadmap.html">ROADMAP</a>.</p>
<h2><a class="header" href="#will-this-project-replace-windowsmacoslinux-one-day" id="will-this-project-replace-windowsmacoslinux-one-day">Will this project replace Windows/MacOS/Linux/... one day?</a></h2>
<p>No. Absolutely not. Because, as I said in sooner, it's not viable for an operating system today to just get rid of all backward compatibility with existing software, simply because what users are interested in is applications first, and <strong>then</strong> the system itself - is it secure, stable, performant, and so on.</p>
<p>Imagine someone introducing the perfect operating system, but with almost no application on it. Would you get rid of your Windows/MacOS/Linux/... system for this one? Surely not, at least not as your everyday system.</p>
<p>This is why this project is for now purely <em>theorical</em>. It aims to describe how great an OS could be if we did not have to care about backward compatibility. Changes to see it in a usable state one day are like very low.</p>
<h2><a class="header" href="#how-does-this-project-relates-to-nightos-v1-v2-and-v3" id="how-does-this-project-relates-to-nightos-v1-v2-and-v3">How does this project relates to NightOS v1, v2 and v3?</a></h2>
<p>The current NightOS project is very different from its previous versions (<a href="https://github.com/ClementNerma/NightOS-v1">v1</a>, <a href="https://github.com/ClementNerma/NightOS-v2">v2</a> and <a href="https://github.com/ClementNerma/NightOS-v3">v3</a>). Originally, it only intended to be a robust and secure <em>desktop environment</em>, written in JavaScript. Performances would of course be very bad, but it was more of a challenge than a serious project. Also, the project was meant to be a Linux kernel under the hood to get rid of the &quot;low-level part&quot;. I seriously lacked of knowledge about low-level concepts at this point in time.</p>
<p>This project does not use JavaScript anymore, but Rust, which is both performant and very robust to the most common memory-related bugs (unless you use <code>unsafe</code> code). There is no more &quot;challenge&quot; idea involved in this new version, only the aim to make the best possible (theorical) system.</p>
<p>In terms of similarities:</p>
<ul>
<li>The <a href="https://github.com/ClementNerma/NightOS-v1">v1</a> was more of a draft, which had a lot of problems up to its roots. It was a pretty bad version overall, and was created when I did not have a real knowledge about how an operating system actually worked ;</li>
<li>The <a href="https://github.com/ClementNerma/NightOS-v2">v2</a> was a bit more realistic, but still far from being mature enough ;</li>
<li>The <a href="https://github.com/ClementNerma/NightOS-v3">v3</a> was more serious and ambitious, but it was still a desktop environment and not designed to be a full operating system, plus it was not designed for optimal performances</li>
</ul>
<h2><a class="header" href="#who-are-you" id="who-are-you">Who are you?</a></h2>
<p>My name is Cl√©ment Nerma (my last name is a pseudonym). I'm a back-end developer that makes stuff since I'm 10-year old and I love to touch to low-level concepts, like operating systems.</p>
<h2><a class="header" href="#why-did-you-create-nightos" id="why-did-you-create-nightos">Why did you create NightOS?</a></h2>
<p>I created it as an answer to the frustration modern OSes provided me. All modern systems have many stability and security problems that cannot be resolved easily because they need to maintain backward compatibility with older pieces of software.
This is where I had the idea of creating NightOS: an operating system that is both robust (understand stable, with mechanisms to minimize data loss in case something goes wrong) and secure, with many security features available to the average user and some more complex ones for advanced users.</p>
<h2><a class="header" href="#how-can-i-help" id="how-can-i-help">How can I help?</a></h2>
<p>Help is very welcome but there's not many things to help with currently, as the system is still being designed. You can still help by suggesting improvements or fixing an error (whatever it is, a design problem or a simple typo) by <a href="https://github.com/ClementNerma/NightOS/issues/new">submitting an issue</a>.</p>
<h1><a class="header" href="#project" id="project">Project</a></h1>
<p>This folder contains the documentation about the project itself - how is will be developed, maintained, its release schedule, etc.
<strong>Please note that this part is far from being complete</strong>, and many informations will be missing and/or incomplete.</p>
<ul>
<li><a href="project/roadmap.html">Roadmap</a> - the project's roadmap</li>
<li><a href="project/development.html">Development</a> - how the project will be developped</li>
<li><a href="project/hw-requirements.html">Hardware requirements</a> - hardware required in order to install and run NightOS</li>
</ul>
<h1><a class="header" href="#projects-roadmap" id="projects-roadmap">Project's ROADMAP</a></h1>
<p><strong>WARNING: This document is only a draft and as such far from being complete. All informations described here are subject to change anytime.</strong></p>
<p>The project will be cut in the four phases described below.</p>
<ul>
<li><a href="project/roadmap.html#conception">Conception</a></li>
<li><a href="project/roadmap.html#validation">Validation</a></li>
<li><a href="project/roadmap.html#implementation">Implementation</a>
<ul>
<li><a href="project/roadmap.html#phase-1-unoptimized-kernel">Phase 1: Unoptimized kernel</a></li>
<li><a href="project/roadmap.html#phase-2-low-level-implementation">Phase 2: Low-level implementation</a></li>
<li><a href="project/roadmap.html#phase-3-applications--system-optimization">Phase 3: Applications &amp; System optimization</a></li>
<li><a href="project/roadmap.html#phase-4-completion">Phase 4: Completion</a></li>
</ul>
</li>
<li><a href="project/roadmap.html#evolution-optimization--maintenance">Evolution, Optimization &amp; Maintenance</a></li>
</ul>
<h2><a class="header" href="#conception" id="conception">Conception</a></h2>
<p>The first part is to write conception documents about how the system work, both at a high-level (concepts, features, native applications etc.) and low-level (processes management, kernel design...).</p>
<p>This project is currently in this state.</p>
<h2><a class="header" href="#validation" id="validation">Validation</a></h2>
<p>Once all conception documents are ready, they will be validated one by one, and frozen. Breaking changes after validation are still possible but should be avoided as much as possible.</p>
<h2><a class="header" href="#implementation" id="implementation">Implementation</a></h2>
<p>Once all documents have been validated, the different project's pieces can be implemented.</p>
<p>It may happen that, during implementation, some validated documents get modifications in order to improve or fix some specific points. Each modification will need to be validated in order to preserve the stability of these documents.</p>
<p>Below are described the different phases of the implementation.</p>
<h3><a class="header" href="#phase-1-unoptimized-kernel" id="phase-1-unoptimized-kernel">Phase 1: Unoptimized kernel</a></h3>
<p>The first piece to be implemented will be the kernel. This is required as the kernel is needed in order to implement higher-level pieces like processes. Still, as not everything is needed right from the start, it will developed with no special matter of performances. In this state, it will be referred to as the name of <em>unoptimized kernel</em>.</p>
<h3><a class="header" href="#phase-2-low-level-implementation" id="phase-2-low-level-implementation">Phase 2: Low-level implementation</a></h3>
<p>Once the unoptimized kernel is ready, two implementations will start in parallel:</p>
<ul>
<li>Kernel optimization (as the unoptimized kernel will be really, really slow)</li>
<li>System development</li>
</ul>
<p>The system development will consist in building the following pieces successively:</p>
<ol>
<li>The BIOS/UEFI bootloader</li>
<li>The system bootloader</li>
<li>The process manager</li>
<li>The native process manager</li>
</ol>
<h3><a class="header" href="#phase-3-applications--system-optimization" id="phase-3-applications--system-optimization">Phase 3: Applications &amp; System optimization</a></h3>
<p>The third phase consists in developing the <a href="project/../applications/">native applications</a>, which are meant to be used by the end user, as well as optimizing the system in parallel and improving its stability.</p>
<p>Starting from this point, all conception documents are definitively validated, which means they cannot receive breaking changes anymore, only new points/features.</p>
<p>This also coincides with the system's <strong>first alpha release</strong>, which will allow persons who are external to the project to test it and suggest improvements.</p>
<h3><a class="header" href="#phase-4-completion" id="phase-4-completion">Phase 4: Completion</a></h3>
<p>The last phase's purpose is to ensure the system is in a fully usable state, in other words to <em>stabilize</em> it.</p>
<p>The kernel and system will also need to be properly optimized, and once all these things are done a <strong>first beta release</strong> will be deployed.</p>
<h2><a class="header" href="#evolution-optimization--maintenance" id="evolution-optimization--maintenance">Evolution, Optimization &amp; Maintenance</a></h2>
<p>The <em>Evolution, Optimization &amp; Maintenance</em> (EPM) part is pretty explicit: it's all about improving NightOS' existing features, introducing new ones as needed, improving performances and stability, and fixing new bugs.</p>
<p>This part will last forever, as for all operating systems - or until the project dies.</p>
<h1><a class="header" href="#project-development" id="project-development">Project development</a></h1>
<p><strong>WARNING: This document is only a draft and as such far from being complete. All informations described here are subject to change anytime.</strong></p>
<ul>
<li><a href="project/development.html#languages">Languages</a></li>
</ul>
<h2><a class="header" href="#languages" id="languages">Languages</a></h2>
<p>The project will be developped in <a href="https://rust-lang.org/">Rust</a>, with first-class support for this language.
API interopability will be assured for <a href="https://www.typescriptlang.org/">TypeScript</a> in the future.</p>
<p>Usage of architecture-specific assembly will be reduced as much as possible, being only used in two cases:</p>
<ul>
<li>The desired behaviour cannot be reached without assembly (e.g. direct register or stack manipulation)</li>
<li>Extremely performances-critical pieces</li>
</ul>
<h1><a class="header" href="#hardware-requirements" id="hardware-requirements">Hardware requirements</a></h1>
<p><strong>WARNING: This document is only a draft and as such far from being complete. All informations described here are subject to change anytime.</strong></p>
<p>This document presents the minimal hardware requirements required by NightOS in order to work. This is also means NightOS will work on any computer with these attributes.</p>
<ul>
<li><strong>Processor</strong>: 64-bit <code>amd64</code> processor</li>
<li><strong>Memory</strong>: at least 256 MB or RAM</li>
<li><strong>Storage</strong>: <em>to be determined</em></li>
</ul>
<h2><a class="header" href="#recommanded-configuration" id="recommanded-configuration">Recommanded configuration</a></h2>
<ul>
<li>A modern process with a built-in cryptography module</li>
<li>An <em>I/O Memory Management Unit</em> (IOMMU) for DMA access</li>
</ul>
<h1><a class="header" href="#concepts" id="concepts">Concepts</a></h1>
<p>This folder contains documentation for each high-level concept of NightOS. They are designed to be easily readable and understandable.</p>
<ul>
<li><a href="concepts/applications.html">What are applications?</a> - the way to run software on NightOS</li>
<li><a href="concepts/libraries.html">What are libraries?</a> - sharing identical behaviours between multiple applications</li>
<li><a href="concepts/users.html">What are users?</a> - sharing a computer between multiple persons</li>
</ul>
<h1><a class="header" href="#applications" id="applications">Applications</a></h1>
<p><em>Applications</em> are the system's way to handle software.</p>
<p><strong>NOTE :</strong> This document is only an <em>introduction</em> to how applications work.</p>
<ul>
<li><a href="concepts/applications.html#how-applications-work">How applications work</a></li>
<li><a href="concepts/applications.html#installation-methods">Installation methods</a>
<ul>
<li><a href="concepts/applications.html#from-the-store">From the store</a></li>
<li><a href="concepts/applications.html#sideloading">Sideloading</a></li>
<li><a href="concepts/applications.html#volatile-applications">Volatile applications</a></li>
</ul>
</li>
<li><a href="concepts/applications.html#permissions">Permissions</a></li>
<li><a href="concepts/applications.html#name-and-slug">Name and slug</a></li>
<li><a href="concepts/applications.html#application-identifier">Application Identifier</a></li>
<li><a href="concepts/applications.html#application-context">Application Context</a></li>
<li><a href="concepts/applications.html#commands">Commands</a></li>
<li><a href="concepts/applications.html#system-applications">System applications</a></li>
<li><a href="concepts/applications.html#services">Services</a></li>
</ul>
<h2><a class="header" href="#how-applications-work" id="how-applications-work">How applications work</a></h2>
<p>An application is a set of executable files and resources. They are the only way to execute code, as direct binary programs are not supported.</p>
<p>Any user can install applications, which will only be available from his account.
Administrator users can install global applications, which are available to every user.</p>
<h2><a class="header" href="#installation-methods" id="installation-methods">Installation methods</a></h2>
<p>Applications are installed through an <a href="concepts/../specs/applications/package.html"><em>application package</em></a> via <a href="concepts/../applications/Skyer.html">Skyer</a>, the applications manager. There are several installation methods:</p>
<ul>
<li>From the store</li>
<li>Directly from the application's package (<a href="concepts/applications.html#sideloading"><em>sideloading</em></a>)</li>
<li>As a volatile application</li>
</ul>
<h3><a class="header" href="#from-the-store" id="from-the-store">From the store</a></h3>
<p>Applications can be downloaded from NightOS' official applications store (available via <a href="concepts/../applications/Stellar.html"><em>Stellar</em></a>).</p>
<ul>
<li>For closed-source applications, the store only provides <a href="concepts/../technical/pre-compiling.html"><em>pre-compiled programs</em></a></li>
<li>For open-source applications, the store provides both pre-built programs as well as the source code</li>
</ul>
<p>For the latter, user can choose either to build the program from source, using the appropriated build tools in order to optimize performances, or to simply use the pre-built programs (which is the option by default).</p>
<h3><a class="header" href="#sideloading" id="sideloading">Sideloading</a></h3>
<p>Applications sideloading (installing an application directly from its <a href="concepts/../specs/applications/package.html">package</a>) follows strict rules determined by the <em>sideloading mode</em>, which is either &quot;disabled&quot;, &quot;secure&quot; or &quot;unsecure&quot;.</p>
<p><strong>Disable mode</strong> prevents all sideloading ; it's not possible to install applications from their package in this mode. <a href="concepts/applications.html#volatile-applications">Volatile applications</a> can stil be run, though.</p>
<p><strong>Secure mode</strong> allows sideloading but will first make the system check if the application's <a href="concepts/applications.html#application-identifier">AID</a> matches an existing application on the Store. If so, it compares the application's signature to the Store application's one. If they don't match, the application is considered malicious and won't be installed.<br />
Note that this mode only works while connected to internet, as the system needs to check the Store to ensure the application is not malicious. If the computer is offline, sideloading will be disabled.</p>
<p><strong>Unsecure mode</strong> allows sideloading without any checking, which is highly dangerous as it allows spoofing.</p>
<p>The sideloading mode can be changed in the <a href="concepts/../applications/Central.html">control center</a>.</p>
<h3><a class="header" href="#volatile-applications" id="volatile-applications">Volatile applications</a></h3>
<p>Applications can be also be ran as <em>volatile applications</em>, which means they are not installed on the disk. There are three methods:</p>
<ul>
<li><em>Full-volatile</em>: the app's data are removed when the application closes</li>
<li><em>Session-scoped</em>: the app's data are stored on disk until the system shuts down</li>
<li><em>Local-persistent</em>: the app's data are stored within a data file located in the same folder</li>
<li><em>Persistent</em>: the app's data are stored in a dedicated folder, also enabling common data between users</li>
</ul>
<p>By default, volatile applications are ran in <em>local-persistent</em> mode. In this mode, the system first checks if a file with the same name as the application's package but with the <em>.vad</em> (Volatile Application's Data) exists. If so, it opens this file as the application's storage. Then, when the application wants to store some data, it is stored inside this data file.</p>
<p>Note that VAD files are disguised <a href="concepts/../technical/file-formats.html#virtual-storages">VST</a> files.</p>
<p>Volatile applications running as persistent do not appear in the applications list and can only be managed through a specific option in the <em>Control Center</em>. Their executable files are not stored anywhere and stay in the application's package, while only their data are stored on the disk. This allows to run the same application several times without losing any data and without worrying about a data file. This also allows to store common data between users.</p>
<p>Note that the store has an option for installing applications as volatile.</p>
<h2><a class="header" href="#permissions" id="permissions">Permissions</a></h2>
<p>See the <a href="concepts/../features/permissions.html">permissions feature document</a>.</p>
<h2><a class="header" href="#name-and-slug" id="name-and-slug">Name and slug</a></h2>
<p>Each application has a name as well as a slug. The name can any valid UTF-8 string, while the slug must respect several rules:</p>
<ul>
<li>Only lowercase letters, underscores and digits</li>
<li>Must not start by a digit</li>
<li>Must not be the name of a native shell command</li>
<li>Must not be the name of a native shell function</li>
<li>Must not be the name of a shell type</li>
</ul>
<p>By default, the slug is auto-generated from the name, but it can also be customized.</p>
<h2><a class="header" href="#application-identifier" id="application-identifier">Application Identifier</a></h2>
<p>From the slug is generated the <em>Application's IDentifier</em> (AID), which is prefixed by the developer's identifier (DID) specified in the application's manifest (it must match the publisher's identifier on the store), and followed by two double points. The DID is submitted to the same rules as the application's slug.</p>
<p>For instance, an application with a slug of <code>utils</code> made by a developer whose DID is <code>superdev</code> will get an AID of <code>utils::superdev</code>.</p>
<p>The AID is unique across the store as well as in a single NightOS installation. As malicious application may provide the DID and the slug of a legit application (which is called <em>AID spoofing</em>), sideloading is <a href="concepts/applications.html#sideloading">verified by default</a>.</p>
<p>As AID are text-based and can be quite long (up to 512 bytes), programs can instead use the <em>Application's Numeric IDentifier</em> (ANID), which is a 32-bit unique number randomly generated by the system to refer to this particular application. On two different systems, the ANID of a given application will likely be very different, and so cannot be guessed. It is provided by the system during the application's launch through the <a href="concepts/applications.html#application-context">context</a>.</p>
<p>System applications are registered under the reserved <code>sys</code> DID.</p>
<h2><a class="header" href="#application-context" id="application-context">Application Context</a></h2>
<p>When an application starts, it can retrieve its <em>context</em>, which are data indicating the execution context of the application.
Detailed informations can be found in the related <a href="concepts/../specs/applications/context.html">specifications document</a>.</p>
<h2><a class="header" href="#commands" id="commands">Commands</a></h2>
<p>Application can expose <a href="concepts/../technical/shell.html">shell commands</a>. Multiple commands can be exposed without any risk of clashing as the command name must be prefixed by the AID first.</p>
<p>For instance, if an application with AID <code>superdev.utils</code> exposes an <code>get_time</code> command, the final usable command will be <code>:superdev.utils.get_time</code>.</p>
<p>This is quite a long name but allows to prevent any clashing between commands. It's common for shell scripts to use imports at the beginning of the script to refer more easily to applications' commands.</p>
<p>Note that, by default, shell prompts (not scripts) will allow to directly use commands such as <code>get_time</code> in the short form if no other application exposes a command with the same name.</p>
<p>Commands work by launching the application with a specific <a href="concepts/applications.html#application-context">context</a>.</p>
<h2><a class="header" href="#system-applications" id="system-applications">System applications</a></h2>
<p>Some <a href="concepts/../applications/">native applications</a> are part of the system itself and are called <em>system applications</em> as such. They get a few specific features:</p>
<ul>
<li>Access to system-reserved features</li>
<li>Ability to create <a href="concepts/applications.html#services">system services</a></li>
<li>They cannot be uninstalled</li>
</ul>
<p>System applications cannot be removed in any way, as some of them are critical for the system to function properly.<br />
Native applications which are <em>not</em> system applications can be removed, though.</p>
<h2><a class="header" href="#services" id="services">Services</a></h2>
<p>Application can provide a <a href="concepts/../technical/services.html">service</a> by specifying it in their <a href="concepts/../specs/applications/manifest.html">manifest</a>.
The service will be run at startup with the usual application's permissions.</p>
<p>When an application uses a service, there is exactly one service process running per active user.</p>
<h1><a class="header" href="#libraries" id="libraries">Libraries</a></h1>
<p><em>Libraries</em> allow to share a program between multiple applications.</p>
<ul>
<li><a href="concepts/libraries.html#how-libraries-work">How libraries work</a></li>
<li><a href="concepts/libraries.html#dependencies-management-and-resolving">Dependencies management and resolving</a></li>
<li><a href="concepts/libraries.html#system-libraries">System libraries</a></li>
</ul>
<h2><a class="header" href="#how-libraries-work" id="how-libraries-work">How libraries work</a></h2>
<p>Unlike applications, libraries can be installed in multiple versions. This means you can have three versions of the same library installed at the same time on your computer.</p>
<p>When an application wants to use a library, it explicitly indicates the list of versions it is compatible with. The system then gets the related version and provides it to the application.</p>
<p>A library by itself cannot do itself: no background process, no commands exposure, no permission granting. Applications simply use libraries as helpers to achieve specific tasks.</p>
<p>For instance, the system library <code>fs</code> which is natively available allows to manipulate files and directories easily.</p>
<h2><a class="header" href="#dependencies-management-and-resolving" id="dependencies-management-and-resolving">Dependencies management and resolving</a></h2>
<p>Each application indicates in its <a href="concepts/../specs/applications/manifest.html">manifest</a> the list of libraries it requires.</p>
<p>When the application is installed, the system will also check if the required libaries are already installed, and with the matching versions. If this is not the case, the library will be downloaded and installed as well (even if it's a volatile application).</p>
<p>When an application is removed, the system looks for each of its dependencies. If the dependency is not used by any application anymore, it is removed by default.</p>
<h2><a class="header" href="#system-libraries" id="system-libraries">System libraries</a></h2>
<p>The system provides several <em>system libraries</em>, which work are libraries that communicate with the system through signals to enable system-related and hardware-related features.
Note that's it's possible to use signals directly to deal with the system and the hardware, but it's a lot more complicated than just using these system libaries.</p>
<ul>
<li><code>fs</code> : Filesystem management</li>
<li><code>net</code> : Network communications</li>
<li><code>ipm</code> : Inter-process management (create processes, workers, IPC, shared memory, ...)</li>
<li><code>gui</code> : Graphical user interface library (relies on <code>desktop</code>)</li>
<li><code>apps</code> : Applications management</li>
<li><code>perm</code> : Permissions controller</li>
<li><code>shell</code> : Shell interface (run commands, ...)</li>
<li><code>input</code> : Input interface (keyboard, mouse, microphone, ...)</li>
<li><code>sound</code> : Sound interface</li>
<li><code>system</code> : System interface (control panel, low-level changes, updates, ...)</li>
<li><code>sandbox</code> : Sandboxes management (run applications in sandboxes, ...)</li>
<li><code>desktop</code> : Desktop management (desktop, windows, notifications, ...)</li>
<li><code>hardware</code> : Hardware management (drivers and devices)</li>
<li><code>reactive</code> : Reactive (relies on <code>reactive</code>, includes Reactive Markup Language, ...)</li>
<li><code>sysver</code> : Exposes the system version, its main purpose to indicate which system version is required for an application</li>
</ul>
<h1><a class="header" href="#users" id="users">Users</a></h1>
<ul>
<li><a href="concepts/users.html#the-concept">The concept</a></li>
<li><a href="concepts/users.html#users-type">Users type</a></li>
<li><a href="concepts/users.html#dangers-of-an-admin-account">Dangers of an admin. account</a></li>
<li><a href="concepts/users.html#user-privileges-elevation-upe">User Privileges Elevation (UPE)</a></li>
<li><a href="concepts/users.html#complexity-level">Complexity level</a></li>
<li><a href="concepts/users.html#users-data-encryption">Users' data encryption</a></li>
<li><a href="concepts/users.html#child-and-supervised-users">Child and supervised users</a></li>
<li><a href="concepts/users.html#groups">Groups</a></li>
<li><a href="concepts/users.html#user-privileges">User privileges</a></li>
</ul>
<h2><a class="header" href="#the-concept" id="the-concept">The concept</a></h2>
<p>Many computers are intended to be shared by multiple persons. In such case, it is useful to separate the data of each user and to prevent other users from accesing another's.</p>
<p>By default, there is two user accounts: the System and the Administrator. They are called <em>virtual users</em> because it's not possible to log in these accounts. Other users (the ones which are created manually) are called <em>custom users</em>.</p>
<p>Each custom user has a dedicated data directory called the <em>homedir</em>, in <code>/home/[username]</code>, as well as a list of files and directories it can read and/or write. By default, each user gets access to:</p>
<ul>
<li>Its homedir in <code>/home/[username]</code> ;</li>
<li>The mounted periphericals in <code>/media</code> ;</li>
<li>Its temporary directory in <code>/tmp/[username]</code></li>
</ul>
<h2><a class="header" href="#users-type" id="users-type">Users type</a></h2>
<p>Each user is of a specific type:</p>
<ul>
<li><em>Phantom</em>: the user's data are erased after the computer is turned off ;</li>
<li><em>Standard</em>: nothing special</li>
<li><em>Administrator</em>: can run programs directly as administrator</li>
<li><em>Main administrator</em>: administrator that can manage storage encryption</li>
</ul>
<p>When a user wants to perform a task it does not have the privileges to, it can (by default) ask to run the task as <em>another user</em>. The other user's credentials are then required.</p>
<p>It's not possible to ask to run a task as system or as administrator as these accounts are virtual and do not have passwords as such, <strong>except</strong> if an administrator user is tries to run a task as administrator.</p>
<p>Note that there is always one and exactly one main administrator. This user account is created during the installation process, and can be transferred later on to another administrator account.</p>
<h2><a class="header" href="#dangers-of-an-admin-account" id="dangers-of-an-admin-account">Dangers of an admin. account</a></h2>
<p>The problem with administrators account is that they can do almost <strong>anything</strong> (except some very specific things like editing the system's files). They can change system settings, read and change other users' data, and even run background processes at startup. They also have all possible privileges as they can edit their own.</p>
<p>This is why it's extremely discouraged to have two administrator users on the same computer, unless the two accounts are used by really trustworthy persons. As such, a large warning is shown if you try to create a new administrator user.</p>
<h2><a class="header" href="#user-privileges-elevation-upe" id="user-privileges-elevation-upe">User Privileges Elevation (UPE)</a></h2>
<p>Users can ask to perform a task with the privileges of another user, such as running a program as administrator. This uses the <em>User Privileges Elevation</em> (UPE) system, builtin the <a href="concepts/../specs/services/perm.html"><code>sys::perm</code></a> service.</p>
<p>In such case, the program is still run as the current user, but with the privileges of both the running user and the user specified to the UPE.</p>
<p>Running a program with UPE requires to know either the other account's password, or to have an <em>authorization</em> from this user. For instance, admin. users have an <em>authorization</em> to use the Administrator account, without providing any password, although a human confirmation is required.</p>
<p>Each request, successful or not, is logged in the log file at <code>/etc/logs/auc</code>.</p>
<h2><a class="header" href="#complexity-level" id="complexity-level">Complexity level</a></h2>
<p>Each user can define a <em>complexity</em> level, which will affect its default settings.</p>
<p>A higher level of complexity will make the system display more informations, give more details about errors that may require some technical knowledge but providing additional features and informations in exchange.</p>
<p>The levels are:</p>
<ul>
<li><strong>Beginner</strong>: only show basic informations, make the permission popups as simple as possible</li>
<li><strong>Standard</strong>: the default complexity level</li>
<li><strong>Advanced</strong>: shows additional informations, displays some error reports, makes the permission popups more precise and verbose</li>
<li><strong>Power</strong>: shows very detailed informations, displays all error reports, makes the permission popups display exhaustive informations</li>
</ul>
<h2><a class="header" href="#users-data-encryption" id="users-data-encryption">Users' data encryption</a></h2>
<p>See <a href="concepts/../features/encryption.html">encryption</a>.</p>
<h2><a class="header" href="#child-and-supervised-users" id="child-and-supervised-users">Child and supervised users</a></h2>
<p><em>Child users</em> are users that are supervised by the <a href="concepts/../features/parental-control.html">parental control</a>.
<em>Supervised users</em> are users that are part of a <a href="concepts/../features/domains.html">domain</a>.</p>
<h2><a class="header" href="#groups" id="groups">Groups</a></h2>
<p><em>Groups</em> are a set of privileges defined by the administrator. Access to some folders or application's permissions (e.g. microphone access) can be restricted to a specific group, for instance.
When a user is created, it can be put in a group. It then automatically inherits all of the group's privileges, in addition to his own ones.
The administrator can add and remove users from groups with the control panel.</p>
<p>When a user is in a group, the group's privileges cannot be revoked for this user.</p>
<h2><a class="header" href="#user-privileges" id="user-privileges">User privileges</a></h2>
<p>User privileges indicate the list of actions a user can perform or not. You can find more in the specifications of the <a href="concepts/../specs/services/perm.html"><code>sys::perm</code></a> system service.</p>
<h1><a class="header" href="#features" id="features">Features</a></h1>
<p>This folder contains explanations about each major feature of NightOS. Each document is designed to be relatively easy to read and understand.</p>
<ul>
<li><a href="features/balancer.html">The balancer</a> - improve performances by balancing processes' priority</li>
<li><a href="features/crash-saves.html">Crash saves</a> - prevent data loss at maximum with crash-proof data saving</li>
<li><a href="features/domains.html">Domains</a> - manage a network of computers</li>
<li><a href="features/encryption.html">Encryption</a> - encrypt the whole storage and individual user accounts</li>
<li><a href="features/freeze-prevention.html">Freeze-prevention system</a> - prevent the system from freezing when all RAM and CPU power are used</li>
<li><a href="features/parental-control.html">Parental control</a> - manage children access to the computer</li>
<li><a href="features/permissions.html">Permissions system</a> - prevent applications and users from doing whatever they want</li>
<li><a href="features/sandboxes.html">Sandboxes</a> - isolate applications to prevent them from harming important data</li>
<li><a href="features/synchronization.html">Synchronization</a> - synchronize settings between multiple computers</li>
</ul>
<h1><a class="header" href="#balancer" id="balancer">Balancer</a></h1>
<p>The <em>balancer</em> is a kernel feature that allows to get more performances out of most important applications.</p>
<ul>
<li><a href="features/balancer.html#how-the-balancer-works">How the balancer works</a></li>
<li><a href="features/balancer.html#application-processes-suspension">Application processes suspension</a></li>
<li><a href="features/balancer.html#performance-mode">Performance mode</a></li>
</ul>
<h2><a class="header" href="#how-the-balancer-works" id="how-the-balancer-works">How the balancer works</a></h2>
<p>The balancer allows to manage the priority of userland processes - and only them. Here is the list of its features:</p>
<ul>
<li>Increase priority of this application: gives a priority of 8 to the process linked to the active window ;</li>
<li>Give maximum priority to this application: gives a priority of 10 to the process linked to the active window ;</li>
<li>Set this application with maximum priority: always give a priority of 8 to this application's processes ;</li>
<li>Suspend/resume this application: see below ;</li>
<li>Enter performance mode: see below</li>
</ul>
<h2><a class="header" href="#application-processes-suspension" id="application-processes-suspension">Application processes suspension</a></h2>
<p>Application processes can be <em>suspended</em>, which is an equivalent of pause where they don't run at all.
This is achieved by setting their priority to 0.</p>
<p>A suspended application can then be <em>resumed</em>, and because it was just suspended it will instantly run again, without any data loss.</p>
<p>When a process is suspended, all its <a href="features/../technical/processes.html#child-processes">child processes</a> are, too.</p>
<h2><a class="header" href="#performance-mode" id="performance-mode">Performance mode</a></h2>
<p>The <em>performance mode</em> performs the following actions:</p>
<ul>
<li>For all userland processes with a non-null priority, set their priority to 1 ;</li>
<li>For all the processes of the application related to the active window, set a priority of 10.</li>
</ul>
<p>This makes all other applications running a lot slower, but the current one will run a lot faster.
The priority is re-calculated whenever the active window changes.</p>
<p>When a fullscreen application uses more than 50% of CPU in fullscreen, or when it asks for it, an overlay suggesting to enter performance mode is shown.</p>
<p>Performance mode is automatically exited when the related process exits.</p>
<h1><a class="header" href="#crash-saves" id="crash-saves">Crash saves</a></h1>
<p><em>Crash saves</em> prevent most data loss caused by a crash, in all applications supporting it.</p>
<ul>
<li><a href="features/crash-saves.html#how-crash-saves-work">How crash saves work</a></li>
<li><a href="features/crash-saves.html#crashes-detection">Crashes detection</a>
<ul>
<li><a href="features/crash-saves.html#invalid-shutdown-indicator">Invalid shutdown indicator</a></li>
<li><a href="features/crash-saves.html#applications-crash-indicator">Application's crash indicator</a></li>
</ul>
</li>
<li><a href="features/crash-saves.html#restoration-process">Restoration process</a></li>
</ul>
<h2><a class="header" href="#how-crash-saves-work" id="how-crash-saves-work">How crash saves work</a></h2>
<p>Every minute (this delay can be changed in the registry), a <code>SYS_CRASHSAVE_COLLECT</code> answerable signal is sent to all running applications.
Applications can then answer with their <em>state data</em>, which should contain every data required for the application in order to be restored to its exact current state later. They may join a <em>title message</em>, which is expected to be their main window's title - if they have ones.
They can also answer with a specific message telling they won't give a crash save data during the current collect. The signal will still be sent on the next collect process (e.g. a minute later).
A last answer method is with another message telling they won't give any crash save for the running instance. The signal won't be sent again for this instance of the application. This message is most of the time encountered when the application doesn't implement the crash save process.</p>
<p>If the application didn't answer when the next collect occurs, the signal is aborted, but the next one will be sent.</p>
<p>When a crash save has been collected for a given application, it is stored in <code>/home/[user]/appdata/[appname]/crashsaves/[timestamp]_[pid].csf</code>.</p>
<p><em>NOTE:</em> Crash saves' intregrity is controlled using the system's <a href="features/../technical/integrity-checker.html">integrity checker</a>.</p>
<h2><a class="header" href="#crashes-detection" id="crashes-detection">Crashes detection</a></h2>
<h3><a class="header" href="#invalid-shutdown-indicator" id="invalid-shutdown-indicator">Invalid shutdown indicator</a></h3>
<p>When the system starts up, it creates an empty file in <code>/etc/sys/awake</code>.
When the system shutdowns gracefully, this file is removed.</p>
<p>If, during startup, this file already exists, the system hasn't shutdowned gracefully.
When this happens, a dialog message is shown, suggesting to re-open crashed applications with their last crash save.</p>
<p>For each application that do not have an available crash save (e.g. when the system crashed before a crash save could have been collected for this application), an indicator in the dialog box will show this application cannot be restored.</p>
<h3><a class="header" href="#applications-crash-indicator" id="applications-crash-indicator">Application's crash indicator</a></h3>
<p>When an application starts, the system creates an empty file in <code>/home/[user]/appdata/[appname]/crashsaves/awake</code> for user applications (even for global applications).</p>
<p>When the application exits gracefully, the file is removed automatically.
When the system detects the application exited, if this file still exists, it shows a dialog box asking if the user wants to relaunch the application with the last crash save.</p>
<p><em>NOTE:</em> If there is no available crash save (e.g. when the application crashed before a crash save could have been made), the dialog box will simply show the application crashed.</p>
<p><em>NOTE:</em> Because a crash save could have been collected for several instances of an application, they can all be restored afterwise.</p>
<h2><a class="header" href="#restoration-process" id="restoration-process">Restoration process</a></h2>
<p>When a crash save is attempted to be restored, the <a href="features/../specs/services/crashsave.html"><code>sys::crashsave</code></a> service. When the application is ready, a <code>SYS_CRASHSAVE_RESTORE</code> confirmable signal is sent, with the application's crash save.
The application is expected to confirm the signal when it has finished restoring its state using the crash save.
The crash save is not deleted directly, though. It is renamed using the new instance's PID and kept until the next collect process receives a new crash save for this instance.</p>
<p>If the application crashes before another crash save can be made <em>and</em> didn't confirm the restoration signal, when this process happens again, system will indicate the application appear to have crashed during crash save restoration.</p>
<h1><a class="header" href="#domains" id="domains">Domains</a></h1>
<p><em>Domains</em> are a set of computers running NightOS which are linked to each other. The way a domain's computers behave and interact are defined in the <em>Domain Supervisor</em>, which is only available to the domain administrator user.</p>
<p>It behaves like an extension of the <a href="features/parental-control.html">parental control</a>, though they are two completely distinct features and domains offer a lot more features, while being made not to manage a child's access to a computer but to manage thousands of comupters at once.</p>
<ul>
<li><a href="features/domains.html#the-concept">The concept</a></li>
<li><a href="features/domains.html#domain-supervisor">Domain supervisor</a></li>
</ul>
<h2><a class="header" href="#the-concept-1" id="the-concept-1">The concept</a></h2>
<p>Domains enable all features of <a href="features/parental-control.html">parental control</a> (without the dedicated application though), as well as the following ones:</p>
<ul>
<li>Mount a common storage between computers</li>
<li>Use remote user accounts for log in</li>
<li>Restrict access to applications</li>
<li>Restrict available permissions to users</li>
<li>Restrict installation and update of new applications</li>
<li>Manage how applications and the system are updated</li>
<li>Monitor CPU, RAM and storage usage on all computers</li>
<li>Get access to every user's storage (unless per-user encryption has been explicitly allowed)</li>
<li>Get remote terminal access to every running computer</li>
<li>Get virtual desktop access to every running computer</li>
<li>Put computers to sleep, hibernation, log out current user, power them off or reboot them</li>
<li>Start any computer remotely (if the computer does support it, e.g. through PoE)</li>
<li>Limit disk usage per user (in disk usage percentage or absolute value)</li>
<li>Limit the session duration per user</li>
<li>Limit the number of physical and virtual cores per user</li>
<li>Limit the amount of memory per user</li>
</ul>
<h2><a class="header" href="#domain-supervisor" id="domain-supervisor">Domain supervisor</a></h2>
<p>The <em>Domain Supervisor</em> is a system application that shows up on any computer that is part of a domain. Only domain supervisor users can see it, but every user can run it through command line (though it will ask for a domain supervisor's username and password).</p>
<p>Here is the list of options the domain supervisor proposes:</p>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#encryption" id="encryption">Encryption</a></h1>
<p>Encryption allows to prevent unauthorized access to a data with a password.</p>
<ul>
<li><a href="features/encryption.html#global-encryption">Global encryption</a></li>
<li><a href="features/encryption.html#per-user-encryption">Per-user encryption</a></li>
<li><a href="features/encryption.html#combining-global-and-per-user-encryptions">Combining global and per-user encryptions</a></li>
</ul>
<h2><a class="header" href="#global-encryption" id="global-encryption">Global encryption</a></h2>
<p>By default, the whole storage can be encrypted using the computer's master password, which is prompted on startup.</p>
<p>During installation, even if this feature is turned off by the user, a random encryption key is generated in the bootloader, which can be accessed through the <code>/etc/sys/gbpwd</code> file. This key will be used to encrypt the storage when global encryption is active.
This process allows administrators to change the master password whenever they want to.</p>
<p>When global encryption is turned on, the administrator must choose an encryption password it will communicate to each user. The system will not be able to start without this password.</p>
<p>On startup, the system will run a <em>bootloader</em> which is not encrypted (and thus vulnerable to attacks) which asks for the master password. This master password is then used to decrypt the master key in the bootloader. Then, the <code>/sys/valid</code> file is decrypted, and its content is compared to <code>ValidMasterKey</code>. If contents are equal, the provided master password is valid and the boot process starts normally. Else, the key is not the good one and the user is prompted a new one.</p>
<p>The point of global encryption is that external persons cannot read the storage's data by just reading the storage ; they must either know the master key or put a malicious bootloader to spy on the user.</p>
<p><strong>NOTE:</strong> The ability to encrypt the storage globally, change the master password or decrypt the storage is by default reserved to the main administrator, but this privilege can be given to normal administrators, though this is highly discouraged.</p>
<h2><a class="header" href="#per-user-encryption" id="per-user-encryption">Per-user encryption</a></h2>
<p>But any non-guest user can also use a built-in system tool to encrypt its data using its own password. This way, the user's data become unreadable without his password, making even administrators unable to read his data.</p>
<p>The encryption/decryption key is generated automatically when the user account is created and stored in the user's profile data (in <code>/etc/sys/users</code>).</p>
<p>When enabled, the encrypted directories are:</p>
<ul>
<li>The homedir at <code>/home/[username]</code></li>
<li>The tempdir at <code>/tmp/[username]</code></li>
</ul>
<p>This feature is enabled by default, but can be disabled by the administrator. Also, it is disabled by default on <a href="features/domains.html">domains</a>.</p>
<h2><a class="header" href="#combining-global-and-per-user-encryptions" id="combining-global-and-per-user-encryptions">Combining global and per-user encryptions</a></h2>
<p>When both a user enabled encryption for its user account and global encryption is active too, instead of having to encrypt and decrypt the data twice the user's data will be encrypted using a key derived from the master key as well as the user's encryption key.</p>
<p>This allows to save a lot of time but still prevent unauthorized access if the user's password is weak.</p>
<h1><a class="header" href="#freeze-prevention" id="freeze-prevention">Freeze prevention</a></h1>
<p><em>Freeze prevention</em> prevents nearly all computer freezes, by reserving a little amount of resources to the system.
It is enabled by default, but it can be disabled during installation process or from the control panel.</p>
<ul>
<li><a href="features/freeze-prevention.html#how-freeze-prevention-works">How freeze prevention works</a></li>
</ul>
<h2><a class="header" href="#how-freeze-prevention-works" id="how-freeze-prevention-works">How freeze prevention works</a></h2>
<p>The system forbids applications to access a fixed amount of RAM, called the <em>freeze prevention resource</em> (FPR), which is by default the smallest between 1% of the total RAM and 8 megabytes.</p>
<p>When more than 99% of CPU and/or RAM is used, the system puts itself in <em>freeze prevention mode</em> (FPM), which consists in listening to a specific keyboard shortcut (by default, <code>Ctrl+Alt+P</code>), controllable using the keyboard or the mouse (with a special block cursor, not changeable by applications) which asks user if they want to terminate gently the more resources-consuming application instance (by sending the <code>TERMINATE</code> signal), to kill it, to kill all instances of the application, or to see the list of running application instances with how much resources they consume, to make a choice on another one.</p>
<p>If developer mode is enabled, another option is added to access a tiny shell containing a set of commands made to list and manage running applications in a more powerful way.</p>
<h1><a class="header" href="#parental-control" id="parental-control">Parental Control</a></h1>
<p><em>Parental control</em> allows to manage a child's access to a computer running NightOS.</p>
<ul>
<li><a href="features/parental-control.html#how-it-works">How it works</a></li>
<li><a href="features/parental-control.html#integration">Integration</a></li>
<li><a href="features/parental-control.html#features">Features</a>
<ul>
<li><a href="features/parental-control.html#restrict-usage-hours">Restrict usage hours</a></li>
<li><a href="features/parental-control.html#restrict-session-duration">Restrict session duration</a></li>
<li><a href="features/parental-control.html#restrict-access-to-applications">Restrict access to applications</a></li>
<li><a href="features/parental-control.html#restrict-access-to-websites">Restrict access to websites</a></li>
<li><a href="features/parental-control.html#restrict-mature-contents">Restrict mature contents</a></li>
<li><a href="features/parental-control.html#restrict-installation-of-applications">Restrict installation of applications</a></li>
<li><a href="features/parental-control.html#controlling-session-remotely">Controlling session remotely</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#how-it-works" id="how-it-works">How it works</a></h2>
<p>Parental control works using (at least) two accounts: the parent's account, and the child's user account, which is related to as a <em>child user</em>. Note that multiple child users can be managed using parental control.</p>
<p>The parent account then gets access to an application called &quot;Parental Control&quot;, which allows to access all parental control-related features for each child user.</p>
<p>It is also possible to get important notifications by email, and even to install a smartphone application (iOS/Android) which brings the parental control application to phones, allowing to manage child users even when not at home.</p>
<h2><a class="header" href="#integration" id="integration">Integration</a></h2>
<p>Parental control's settings are available to third-party applications using specific permissions. This way, some applications can provide an additionally layer of security for child users, like preventing access to adult contents in a game store.</p>
<h2><a class="header" href="#features-1" id="features-1">Features</a></h2>
<h3><a class="header" href="#restrict-usage-hours" id="restrict-usage-hours">Restrict usage hours</a></h3>
<p>This feature allows to restrict usage of the computer by the child user during specific hours in the day.
These hours can be set independently for each day of the week, allowing for instance to set specific hours in the week-end.
It's also possible to set specific hours for some specific weeks or periods of times (e.g. for four specific days in a row), allowing for instance to set specific hours for vacations.</p>
<p>Child user will not be able to log in outside of these hours. If they are logged in when the upper limit is reached (e.g. only 8 AM to 9 AM is allowed and the child user is still logged in as 9 AM), a warning message will be shown 15 minutes before reaching the time limit, 5 minutes before, and 1 minute before, allowing the child to save its data.</p>
<p>When this final minute comes, a pop-up shows telling the session is going to be closed in 60 seconds, and a cooldown is shown in a closable pop-up balloon in the taskbar. An option is also shown to extend the session by up to fifteen minutes, sending a notification to the parent's phone as well as an e-mail.</p>
<p>The parent can then do nothing and the session will extend for a maximum of fifteen minutes, or reject it and the computer will shut down after 1 minute. Then another option shows to ask if the parent wants to permanently disable time extension.</p>
<p>Session time extension can be enabled/disabled during the parental control installation process (enabled by default). If disabled, the time extension option will not be shown to the child user during the timeout.</p>
<h3><a class="header" href="#restrict-session-duration" id="restrict-session-duration">Restrict session duration</a></h3>
<p>This feature allows to restrict how much time a session can be active, allowing for instance to limit a child user's usage to one hour per day. Like the usage hours, it can be set independently for each day of the week, for specific weeks, and for specific periods.</p>
<p>Session time extension applies here as well, and works the same way as for restricted usage hours. The related settings are independent though, allowing for instance to enable session time extension for usage hours but not for session duration, or the opposite.</p>
<h3><a class="header" href="#restrict-access-to-applications" id="restrict-access-to-applications">Restrict access to applications</a></h3>
<p>This feature restricts access to some applications, either using a whitelist (listing all the <em>allowed</em> applications), or using a blacklist (listing all the <em>forbidden</em> applications).</p>
<p>It's possible to automatically while/black-list new applications.</p>
<h3><a class="header" href="#restrict-access-to-websites" id="restrict-access-to-websites">Restrict access to websites</a></h3>
<p>This feature restricts access to some websites, either using a whitelist or a blacklist. It's also possible to apply these restrictions only to compatible web browsers. Whitelist is strongly discouraged outside of web browsers-only usage, as it may prevent some applications to work properly.</p>
<p>Whenever an application tries to access a forbidden website, the request will fail with a specific code indicating it's forbidden by parental control. Applications can still enforce this rule but this requires a specific permission that cannot be allowed by child users.</p>
<p>These restrictions are enabled through the built-in firewall, <a href="features/../applications/Vortex.html">Vortex</a>.</p>
<h3><a class="header" href="#restrict-mature-contents" id="restrict-mature-contents">Restrict mature contents</a></h3>
<p>The child user's birth date can be declared during setup, so its age (not its birth date) will be available to every application which asks for it (with a specific permission, which is by default automatically granted to all applications which ask it).</p>
<p>This allows, for instance, for web browsers to block websites that declare themselves as showing adult contents. Or even more precise protection, like a movies store not showing movies whom age limit is beyond the child user's age.</p>
<h3><a class="header" href="#restrict-installation-of-applications" id="restrict-installation-of-applications">Restrict installation of applications</a></h3>
<p>This feature prevents child users from installing and running volatile applications.
By default, installation is allowed but sends a notification to the parent user asking if the child user is allowed to install the requested application ; while running volatile applications is simply disabled.</p>
<h3><a class="header" href="#controlling-session-remotely" id="controlling-session-remotely">Controlling session remotely</a></h3>
<p>This feature allows parents to log out the child user remotely. This will show a pop-up indicating the session will be closed in 60 seconds, behaving just like usage hours restriction. It may also provide session time extension based on how the log out was triggered (log out the child user <em>or</em> log out the child user and disable session time extension) and the setting selected during the setup process.</p>
<h1><a class="header" href="#sandboxes" id="sandboxes">Sandboxes</a></h1>
<p><em>Sandboxes</em> allow to test an application without applying modifications to the system.</p>
<ul>
<li><a href="features/sandboxes.html#how-sandboxes-work">How sandboxes work</a></li>
<li><a href="features/sandboxes.html#persistent-sandboxes">Persistent sandboxes</a></li>
<li><a href="features/sandboxes.html#puppet-sandbox">Puppet sandbox</a></li>
</ul>
<h2><a class="header" href="#how-sandboxes-work" id="how-sandboxes-work">How sandboxes work</a></h2>
<p>A sandbox is an execution mode where an application's modifications to the disk are not applied directly to it, but instead to a virtual drive stored in its <code>sandboxes</code> folder. When the app. exits, a confirmation overlay proposes to apply the modifications to the real storage - it's also possible to see the changes before applying them.</p>
<p>In developer mode, it is possible to export sandboxes and import them on other computers.</p>
<h2><a class="header" href="#persistent-sandboxes" id="persistent-sandboxes">Persistent sandboxes</a></h2>
<p>Sandboxes can also be created as <em>persistent</em>, which prevents them from being removed after the app. exited. Instead, the next time it will run, the same sandbox will be used again.</p>
<h2><a class="header" href="#puppet-sandbox" id="puppet-sandbox">Puppet sandbox</a></h2>
<p>Sandboxes can be controlled by another application (this requires an administrator permission, though). This allows to automatically accept or decline every API usage, like permissions or I/O requests. Such sandboxes are called <em>puppet sandboxes</em>, and they can be especially useful for testing.</p>
<h1><a class="header" href="#synchronization" id="synchronization">Synchronization</a></h1>
<p>Online backup and synchronization is performed through <a href="features/../applications/Cloudy.html">Cloudy</a>.</p>
<h1><a class="header" href="#technical" id="technical">Technical</a></h1>
<p>This folder contains technical documents which essential describe low-level parts of NightOS.</p>
<ul>
<li><a href="technical/controller.html">The controller</a> - permissions management system</li>
<li><a href="technical/dev-mode.html">Developer mode</a> - enable powerful development options</li>
<li><a href="technical/file-formats.html">File formats</a> - description of all native file formats</li>
<li><a href="technical/integrity-checker.html">Integrity checker</a> - ensure the system hasn't been corrupted</li>
<li><a href="technical/io-manager.html">I/O manager</a> - manage input/output requests</li>
<li><a href="technical/ipc.html">Inter-process communication</a> - communication between processes</li>
<li><a href="technical/multi-platform.html">Multi-platform management</a> - how the NightOS ecosystem can be used on other operating systems</li>
<li><a href="technical/performances.html">Performances</a> - system tweaks used to optimize general and specific-case performances</li>
<li><a href="technical/pre-compiling.html">Pre-compiling applications</a> - pre-compiling applications to improve installation time and size</li>
<li><a href="technical/processes.html">Processes</a> - low-level view of how code runs in a concurrent way</li>
<li><a href="technical/registry.html">The registry</a> - configure the system's behaviour and features</li>
<li><a href="technical/services.html">Services</a> - special processes that run in the background and allow other applications to perform specific tasks</li>
<li><a href="technical/shell.html">The shell</a> - the de-facto way to run complex and/or automatized tasks on NightOS</li>
</ul>
<h1><a class="header" href="#controller" id="controller">Controller</a></h1>
<p>The <em>controller</em> is a system library that manages permissions of processes. The <a href="technical/io-manager.html"><em>I/O manager</em></a> relies on it to accept or reject requests.</p>
<ul>
<li><a href="technical/controller.html#notion-of-scope">Notion of scope</a></li>
<li><a href="technical/controller.html#the-perm-system-library">The <code>perm</code> system library</a></li>
<li><a href="technical/controller.html#permissions-extension">Permissions extension</a></li>
</ul>
<h2><a class="header" href="#notion-of-scope" id="notion-of-scope">Notion of scope</a></h2>
<p>Permissions are split into several scopes:</p>
<ul>
<li>The <em>application scope</em> contains the permissions a given process is borned from ;</li>
<li>The <em>user scope</em> contains the permissions the user who launched the application has ;</li>
<li>The <em>mode scope</em> contains the permissions the <em>execution mode</em> (either system or userland) has.</li>
</ul>
<p>The mode scope restricts the user scope, which itself restricts the application scope. This means that, if the application scope specify a permission that is not covered by the user scope, it is not applyable to the process. This allows to prevent applications and users from getting too high permissions.</p>
<p>The mode scope prevents applications from performing harmful tasks such as writing the system. Only system applications, which run in system mode instead of userland mode, gets an unrestricted mode scope.</p>
<h2><a class="header" href="#the-perm-system-library" id="the-perm-system-library">The <code>perm</code> system library</a></h2>
<p>The <code>perm</code> system library is an interface for the controller which allows processes to check their own permissions, ensure they can make I/O requests before effectively making them, and extend their permissions (see below).</p>
<h2><a class="header" href="#permissions-extension" id="permissions-extension">Permissions extension</a></h2>
<p>A process can, at any moment, send a <em>permission extension request</em> (PER) using the <code>perm</code> library. It allows to gain a new permission by showing an overlay the user can accept or decline. If the permission is accepted, the requested permission is added to the process' one - and sometimes to the application's one.</p>
<p>If the requested permission is out of its maximum scope (e.g. asking for write access to <code>/etc</code> while being ran as standard user), the request is rejected.</p>
<h1><a class="header" href="#developer-mode" id="developer-mode">Developer mode</a></h1>
<p>The <em>developer mode</em> enables several features that are not available to default users. Only administrator users get access to them when they are enabled.</p>
<ul>
<li><a href="technical/dev-mode.html#how-to-enable">How to enable</a></li>
<li><a href="technical/dev-mode.html#features">Features</a></li>
<li><a href="technical/dev-mode.html#application-proxies">Application proxies</a></li>
</ul>
<h2><a class="header" href="#how-to-enable" id="how-to-enable">How to enable</a></h2>
<p>Developer mode can be enabled either by typing the following command in the terminal:</p>
<pre><code class="language-shellscript">adm central --enable dev-mode
</code></pre>
<p>Or, while holding the <code>Ctrl</code> <code>Alt</code> and <code>Maj</code> key, type <code>DEV</code> (three letters).</p>
<p>A warning dialog will appear.
If you confirm, it will display an <a href="technical/../concepts/users.html#user-privileges-elevation-upe">UPE dialog</a> for the administrator account.
Then a final confirmation dialog will ensure you're sure about what you're doing. Then development mode will be enabled (no reboot is required).</p>
<h2><a class="header" href="#features-2" id="features-2">Features</a></h2>
<ul>
<li>Additional features will appear in the control center (<a href="technical/../applications/Central.html#development-related-options">see the options</a>)</li>
<li>The registry can be <a href="technical/registry.html#debugging">imported and exported</a></li>
</ul>
<h2><a class="header" href="#application-proxies" id="application-proxies">Application proxies</a></h2>
<p><em>Application proxies</em> are applications that intercept all applications calls to the system on-the-fly. It is useful for applications debugging.</p>
<p>When a proxy is set up for an application, all system calls sent to this application will be transferred to the proxy, which will be able to do whatever it wants with it. It's possible for the proxy to never answer the signal, to change its content before actually sending it to the system, etc.</p>
<p>Basic usage of an application proxy is as a &quot;listener&quot;: it only listens to specific signals and logs them, without cancelling them and/or modifying them. This is useful to check all filesystem access requested by an application, in real time.</p>
<h1><a class="header" href="#devices" id="devices">Devices</a></h1>
<ul>
<li><a href="technical/devices.html#connecting-a-new-device">Connecting a new device</a></li>
<li><a href="technical/devices.html#interacting-with-a-device">Interacting with a device</a></li>
<li><a href="technical/devices.html#device-handler-files-persistence">Device handler files persistence</a></li>
<li><a href="technical/devices.html#custom-device-handler-filename">Custom device handler filename</a></li>
</ul>
<h2><a class="header" href="#connecting-a-new-device" id="connecting-a-new-device">Connecting a new device</a></h2>
<p>When a new device is connected to the computer, a <em>device handler file</em> (DHF) is created in the <code>/dev</code> directory (see <a href="technical/../specs/filesystem.html#structure">filesystem structure</a>).</p>
<p>Depending on its type, it will be put in a different directory, as shown in the above document. Note that new category directories may be introduced later on.</p>
<p>The filename itself is a random unique identifier made of a single lowercase letter, a digit, another lowercase letter and finally another digit.</p>
<p>For instance, if a hard drive is connected to the computer, the DHF may be something like <code>/dev/sst/f5t2</code>.</p>
<h2><a class="header" href="#interacting-with-a-device" id="interacting-with-a-device">Interacting with a device</a></h2>
<p>Device handler files are not simple files ; they can only be used through the <a href="technical/../specs/services/hw.html"><code>sys::hw</code></a> service.</p>
<p>Different actions may happen depending on the device's type:</p>
<ul>
<li>Camera devices: when an application asks to capture a photo/video, the device will be suggested to take the images from</li>
<li>Microphones: when an application asks to capture sound, the device will be suggested to capture the sound from</li>
<li>Sound output devices: the device will be available for playback</li>
<li>Network adapters: the device will be available to make network requests on</li>
<li>Other supported wireless devices: depends on the type (Bluetooth adapter, ...)</li>
<li>Basic/persistent storage devices: when possible, the device will be automatically mounted in <code>/mnt</code> and visible in the files explorer</li>
</ul>
<p>There are many different types of devices, all can be found in the specifications of the <a href="technical/../specs/services/hw.html"><code>sys::hw</code></a> service under the <a href="technical/../specs/services/hw.html#driven-device-type">&quot;Driven device type&quot; (DDT) section</a>.</p>
<p>For uncategorized devices (in <code>/dev/etc</code>), a popup is shown to the user, to indicate the connected device is not recognized. Some applications may still be able to interact with it (for instance, a storage device using an unsupported protocol).</p>
<h2><a class="header" href="#device-handler-files-persistence" id="device-handler-files-persistence">Device handler files persistence</a></h2>
<p>When a device is connected, its DHF is not removed. Instead, if a process tries to interact with the DHF, the <a href="technical/../specs/services/hw.html"><code>sys::hw</code></a> service will indicate the device is currently not connected.</p>
<p>When the device is connected again, it is associated to the same DHF again. This allows applications to persist the device's location and use it later on.</p>
<h2><a class="header" href="#custom-device-handler-filename" id="custom-device-handler-filename">Custom device handler filename</a></h2>
<p>It's possible to give a custom handler filename for intuitivity. In such case, a new DHF is created in the related directory, but the old DHF is kept anyway. This allows to not break compatibility with applications that rely on the old DHF.</p>
<p>The two DHF will point to the exact same device, without any difference. The custom DHF can be removed anytime, although this is discouraged as applications may rely on it.</p>
<p>Also, custom DHF names must always be longer than 4 characters, to avoid confusion with automatically-generated DHFs.</p>
<h1><a class="header" href="#file-formats" id="file-formats">File Formats</a></h1>
<p>This document presents the file formats natively handled by NightOS. Some files are only handled by optional first-party applications that may not be installed on the computer, so some formats may not be supported in specific installs where such applications have been removed/were never installed.</p>
<ul>
<li><a href="technical/file-formats.html#common-formats">Common formats</a></li>
<li><a href="technical/file-formats.html#virtual-storages">Virtual storages</a></li>
<li><a href="technical/file-formats.html#application-packages">Application packages</a></li>
<li><a href="technical/file-formats.html#system-updates">System updates</a></li>
</ul>
<h2><a class="header" href="#common-formats" id="common-formats">Common formats</a></h2>
<p>Common file formats are natively handled:</p>
<ul>
<li>Text files (<code>.txt</code>, <code>.md</code>, ...) with <a href="technical/../applications/Gravity.html">Gravity</a></li>
<li>Audio files (<code>.mp3</code>, <code>.flac</code>, ...) with <a href="technical/../applications/Sonata.html">Sonata</a></li>
<li>Image files (<code>.png</code>, <code>.jpg</code>, ...) with <a href="technical/../applications/ShootingStar.html">ShootingStar</a></li>
<li>Video files (<code>.mp4</code>, <code>.mkv</code>, ...) with <a href="technical/../applications/Milkshake.html">Milkshake</a></li>
<li>Archive files (<code>.zip</code>, <code>.tar</code>, ...) with <a href="technical/../applications/Blackhole.html">Blackhole</a></li>
<li>E-book files (<code>.cbz</code>, <code>.cbr</code>, ...) with <a href="technical/../applications/Reader.html">Reader</a></li>
<li>E-mail files (<code>.eml</code>, <code>.vcf</code>, ...) with <a href="technical/../applications/Postal.html">Postal</a></li>
<li>Web files (<code>.html</code>, ...) with <a href="technical/../applications/Rocket.html">Rocket</a></li>
<li>Virtual storage files (<code>.iso</code>, <code>.vfd</code>, ...) with <a href="technical/../applications/Locky.html">Locky</a></li>
</ul>
<h2><a class="header" href="#virtual-storages" id="virtual-storages">Virtual storages</a></h2>
<p>Virtual storages are files that contain one or several virtual filesystems. Different filesystems can be put in, but all must be supported natively by NightOS in order to properly work without needing to install any additional application.</p>
<p>The filesystems can be encrypted individually. The whole storage can also be encrypted.</p>
<p>They have multiple purposes: store encrypted files, virtual filesystems for sandboxed applications, etc.</p>
<p>Virtual storage files have the <code>.vts</code> extension and are opened using <a href="technical/../applications/Locky.html">Locky</a>.</p>
<h2><a class="header" href="#application-packages" id="application-packages">Application packages</a></h2>
<p>Applications can be installed from standalone files called <a href="technical/../specs/applications/package.html">application packages</a>.
Installable applications have the <code>.nap</code> (NightOS Application Package) extension, while volatile applications have the <code>.nva</code> (NightOS Volatile Application) one.</p>
<p>They are opened using <a href="technical/../applications/Skyer.html">Skyer</a>.</p>
<h2><a class="header" href="#system-updates" id="system-updates">System updates</a></h2>
<p>The system is intended to be updated through the update section in the settings, but sometimes it may be required to install updates offline for specific reasons (e.g. no network connection available at the moment). In such case, it is possible to download incremental updates as system update files.</p>
<p>They may contain one or several updates, and are only installable on a very specific version of the system, to avoid missing some other incremental updates.</p>
<p>System update files have the <code>.nsu</code> (NightOS System Update) extension and are opened using the <a href="technical/../applications/Central.html">control center</a>.</p>
<h1><a class="header" href="#integrity-checker" id="integrity-checker">Integrity checker</a></h1>
<ul>
<li><a href="technical/integrity-checker.html#system-immutability">System immutability</a></li>
<li><a href="technical/integrity-checker.html#hashes-computing">Hashes computing</a></li>
<li><a href="technical/integrity-checker.html#checking-hashes-at-startup">Checking hashes at startup</a></li>
</ul>
<h2><a class="header" href="#system-immutability" id="system-immutability">System immutability</a></h2>
<p>The <code>/sys</code> directory is immutable, which means it cannot be modified, even by the main administrator. The only process where this directory may be affected is during a repair process or during an update, which are both processes that are handled by the system directly.</p>
<h2><a class="header" href="#hashes-computing" id="hashes-computing">Hashes computing</a></h2>
<p>When critical files are written, in <code>/sys</code> or <code>/etc/sys</code>, their hash is computed using the SHA-384 algorithm and stored in the system's <em>hash registry</em> (<code>/etc/sys/hashes</code> file).</p>
<h2><a class="header" href="#checking-hashes-at-startup" id="checking-hashes-at-startup">Checking hashes at startup</a></h2>
<p>When any of these files is read from the disk, their content is computed and compared to the hash registry. If the hashes don't match, the file is considered as corrupted. The consequences depend on the location of the file:</p>
<ul>
<li><em>System</em> (<code>/sys</code>): the system will check its backup integrity and then restore itself from the backup ;</li>
<li><em>System backup</em> (<code>/sys/backup</code>): the system will check <code>/sys</code> integrity and then make a new backup of itself ;</li>
<li><em>System + system backup</em>: the system won't boot and indicate it must be reinstalled (documents won't be lost if they aren't corrupted)
It's possible to force the boot process, but a large warning will indicate it may cause crashes or even introduce security issues ;</li>
<li><em>Hash registry</em> (<code>/etc/sys/hashes</code>): same thing ;</li>
<li><em>Registry</em> (<code>/etc/sys/registry</code>): same thing ;</li>
<li><em>Crash save</em>: the crash save won't be restored (can be forced but with a large warning) ;</li>
<li><em>Sandbox</em>: system will refuse to start the sandbox (can be forced but with a large warning) ;</li>
</ul>
<p><strong>IMPORTANT:</strong> If some malicious person edits the system files <strong>and</strong> its backup, it can also edit the hash registry, so the error won't show up. So that's not because there is no error the system is safe and has not been modified!</p>
<h1><a class="header" href="#io-nano-manager" id="io-nano-manager">I/O nano-manager</a></h1>
<p>The <em>Input/Output Nano-manager</em>, formerly known as <em>Ion</em>, is a part of the system which treats input/output requests from processes.</p>
<ul>
<li><a href="technical/io-manager.html#hardware-access">Hardware access</a></li>
<li><a href="technical/io-manager.html#requests">Requests</a></li>
<li><a href="technical/io-manager.html#permissions">Permissions</a></li>
<li><a href="technical/io-manager.html#requests-priority">Requests priority</a></li>
</ul>
<h2><a class="header" href="#hardware-access" id="hardware-access">Hardware access</a></h2>
<p>When a process tries to access the hardware, it must go through Ion, which will allow it or not to interact with the desired component.</p>
<p><a href="technical/services.html">System services</a> such as <a href="technical/../specs/services/fs.html"><code>sys::fs</code></a> or <a href="technical/../specs/services/net.html"><code>sys::net</code></a> use Ion to deal with the related hardware components.</p>
<h2><a class="header" href="#requests" id="requests">Requests</a></h2>
<p>When a process tries to access, for instance, the filesystem, it sends an I/O request to the manager which is pushed in an internal queue. The manager sorts incoming requests and treat them depending on their arrival.</p>
<h2><a class="header" href="#permissions-1" id="permissions-1">Permissions</a></h2>
<p>To ensure a process has the required permissions to make a specific I/O request, the manager asks the <a href="technical/controller.html">controller</a> to verify its permissions. The controller's response makes the manager accept or reject the request.</p>
<h2><a class="header" href="#requests-priority" id="requests-priority">Requests priority</a></h2>
<p>Requests are treated by priority, which is made both of its arrival timestamp (first one, first out) but also of the process' priority: a process with an higher priority will see its I/O requests treated more quickly.</p>
<h1><a class="header" href="#multi-platform" id="multi-platform">Multi-platform</a></h1>
<p>NightOS programs can be ran either on Linux, Windows or MacOS systems using a wrapper called the <em>NightOS Calls Wrapper</em> (NCW).
It can be downloaded from NightOS' official website.</p>
<p>When installed on a system, it allows to use NightOS applications natively, although permissions management will not be as smooth and many options will not be available (e.g. no desktop, no access to native NightOS applications - only native libraries, etc.).</p>
<h1><a class="header" href="#performances" id="performances">Performances</a></h1>
<ul>
<li><a href="technical/performances.html#cycle-and-phases">Cycle and phases</a></li>
<li><a href="technical/performances.html#processes-priority">Processes' priority</a></li>
<li><a href="technical/performances.html#balancing-performances">Balancing performances</a></li>
</ul>
<h2><a class="header" href="#cycle-and-phases" id="cycle-and-phases">Cycle and phases</a></h2>
<p>Because processes' instructions cannot always be processed parallely, the system will let each application run a fixed amount of instructions, before going to the next one. This short period of time is called a <em>phase</em> and generally lasts a few milliseconds. The treatment of a single phase for all running processes is called a <em>run cycle</em>. When a process isn't in a phase, it is &quot;paused&quot; until the next one.</p>
<h2><a class="header" href="#processes-priority" id="processes-priority">Processes' priority</a></h2>
<p>Each process is started with a given <em>priority</em>, which is a number from 0 to 10, which can be modified during its execution. The more priority it has, the more instructions it will run in a single phase.</p>
<p>A priority of 0 prevents the program from running any instruction at all. In this case, only an external process will be able to increase the priority to let the program run again.</p>
<p>By default, a background process gets a priority of 2, a visible process gets a priority of 4, the process linked to the active window gets a priority of 6, and the process linked to a fullscreen window gets a priority of 7.</p>
<p>When a process asks to set its priority to 9 or 10, a confirmation overlay is shown.</p>
<h2><a class="header" href="#balancing-performances" id="balancing-performances">Balancing performances</a></h2>
<p>See the performances <a href="technical/../features/balancer.html">balancer</a>.</p>
<h1><a class="header" href="#pre-compiling" id="pre-compiling">Pre-compiling</a></h1>
<p>On traditional operating systems, programs are provided as binary and so are only available for one specific platform (Windows, Linux, MacOS, ...) with a specific architecture (x86, ARM, ...).</p>
<p>In order to prevent this, and in order to bring more stability and security to native programs, NightOS programs are shipped as <em>NightOS Pre-compiled Programs</em> (NPP) using a specific language called <em>CommonAssembly</em>.</p>
<ul>
<li><a href="technical/pre-compiling.html#how-it-works">How it works</a></li>
<li><a href="technical/pre-compiling.html#compatibility">Compatibility</a></li>
<li><a href="technical/pre-compiling.html#usage">Usage</a></li>
</ul>
<h2><a class="header" href="#how-it-works-1" id="how-it-works-1">How it works</a></h2>
<p>CommonAssembly is very similar to WebAssembly: compressed very low-level source-files that are built ahead of time on the machine that will run it. This enables several advantages:</p>
<ul>
<li>Programs are multi-platforms, multi-architectures</li>
<li>Programs run faster thanks to being optimized for the specific machine they will run on</li>
<li>Programs are still very fast to compile</li>
<li>Source code is protected for closed-source applications as CommonAssembly is made of basic instructions</li>
<li>Better security thanks to programs being checked ahead-of-time</li>
</ul>
<h2><a class="header" href="#compatibility" id="compatibility">Compatibility</a></h2>
<p>CommonAssembly can be ran on other operating systems than NightOS using a lightweight wrapper available on NightOS' official website.</p>
<p><em>NOTE:</em> While CommonAssembly is multi-platform, NightOS applications take advantage of NightOS' features like more powerful signals that are <em>not</em> natively available on other systems. In order to run such applications, you must install the <a href="technical/multi-platform.html">full wrapper</a> which is available on the same website.</p>
<h2><a class="header" href="#usage" id="usage">Usage</a></h2>
<p>Open-source and closed-source NightOS applications usually bring pre-compiled versions of themselves in order to fasten a lot the installation process, and to get rid of the need of having the heavy build toolchain installed on the target computer.</p>
<p>This allows to install applications really fast, and to optimize them for the current machine.</p>
<h1><a class="header" href="#processes" id="processes">Processes</a></h1>
<p><strong>WARNING: This document is far from being complete and may lack a good description of what processes are, and/or the features they offer.</strong></p>
<p>NightOS <em>processes</em> are implemented a bit like Linux' ones, with additional features.
There are several types of processes:</p>
<ul>
<li><em>System processes</em>, which are created by the system ;</li>
<li><em>Application processes</em>, in which applications run ;</li>
<li><em>Worker processes</em>, in which applications' workers run</li>
</ul>
<p>The base and system processes are called <em>low-level processes</em>, while application and worker ones are called <em>userland processes</em>.</p>
<p>You can find the implementation details of processes in the <a href="technical/../specs/kernel/processes.html">kernel document</a>.</p>
<ul>
<li><a href="technical/processes.html#user-privileges">User privileges</a></li>
<li><a href="technical/processes.html#child-processes">Child processes</a></li>
<li><a href="technical/processes.html#threading">Threading</a>
<ul>
<li><a href="technical/processes.html#main-thread">Main thread</a></li>
<li><a href="technical/processes.html#thread-local-storage">Thread-local storage</a></li>
</ul>
</li>
<li><a href="technical/processes.html#automatic-permissions-inheritance">Automatic permissions inheritance</a></li>
</ul>
<h2><a class="header" href="#user-privileges-1" id="user-privileges-1">User privileges</a></h2>
<p>Each process is ran as a specific user, which determines the maximum allowed scope for <a href="technical/controller.html">controller requests</a>, and with a list of initial privileges (the ones given to the application).</p>
<h2><a class="header" href="#child-processes" id="child-processes">Child processes</a></h2>
<p>A process can create <em>child processes</em> (it's called a <em>fork</em>). The child process will roughly be a 1:1 copy of the parent process, but with its own unique PID.</p>
<p>Child processes automatically inherit their parent's permissions.</p>
<p>When a process exits, all its child processes are immediatly killed. It's up to the process to ensure its children are properly terminated before it.</p>
<h2><a class="header" href="#threading" id="threading">Threading</a></h2>
<p>A process can create <em>threads</em>, which are still a part of the process. Threads allow to run multiple part of a process concurrently, as the kernel may run several threads in different processor cores.</p>
<p>All threads share the same address space and memory, although they all have a reserved space called the <a href="technical/processes.html#thread-local-storage"><em>thread-local storage</em></a>.</p>
<p>Threads work as a hierarchy ; when a thread creates another, it is called the new thread's <em>parent</em>, while the new thread is its <em>child</em>. When a thread terminates, all its children are instantly destroyed.</p>
<h3><a class="header" href="#main-thread" id="main-thread">Main thread</a></h3>
<p>When a process starts, its instruction run its <em>main thread</em>. Due to threads being hierarchised, exiting the main thread will result in all other threads being closed immediatly, which is why the main thread should always first terminate its children properly to ensure all data are synchronized for instance.</p>
<h3><a class="header" href="#thread-local-storage" id="thread-local-storage">Thread-local storage</a></h3>
<p>Threads have a reserved portion of memory in their address space called the <em>thread-local storage</em> (TLS).</p>
<h2><a class="header" href="#automatic-permissions-inheritance" id="automatic-permissions-inheritance">Automatic permissions inheritance</a></h2>
<p>When an application process gets a new permission, all other processes from the same application inherit it, unless this permission is granted only for this instance of the application.</p>
<h1><a class="header" href="#registry" id="registry">Registry</a></h1>
<p>The registry contains all system configuration.</p>
<ul>
<li><a href="technical/registry.html#format-and-content">Format and content</a></li>
<li><a href="technical/registry.html#debugging">Debugging</a></li>
</ul>
<h2><a class="header" href="#format-and-content" id="format-and-content">Format and content</a></h2>
<p>The registry's format and content can be found in the <a href="technical/../specs/registry.html">specifications document</a>.</p>
<h2><a class="header" href="#debugging" id="debugging">Debugging</a></h2>
<p>In <a href="technical/dev-mode.html">developer mode</a>, the registry can be exported to the HFRR format and imported back.</p>
<h1><a class="header" href="#services-1" id="services-1">Services</a></h1>
<p>A <em>service</em> is a process that launches at startup and may receive <a href="technical/ipc.html">IPC</a> messages from any process.</p>
<ul>
<li><a href="technical/services.html#system-services">System services</a></li>
<li><a href="technical/services.html#application-services">Application services</a></li>
</ul>
<h2><a class="header" href="#system-services" id="system-services">System services</a></h2>
<p>System services are native <a href="technical/../concepts/applications.html">applications</a>. They have system permissions and as such are allowed to perform any task.
Their purpose is to allow processes to perform specific actions like permissions management or filesystem access without hunging up the <a href="technical/../specs/kernel/README.html">kernel</a>.</p>
<p>Each system service is a system application, exposing a service. Most also expose command-line tools.</p>
<p>You can get more details about how services work in the <a href="technical/../specs/services.html">specifications document</a>.</p>
<p>You can find the list of system services in their <a href="technical/../specs/services/">specifications directory</a>.</p>
<h2><a class="header" href="#application-services" id="application-services">Application services</a></h2>
<p>Application services, also called <em>userland services</em>, are provided by <a href="technical/../concepts/applications.html#services">applications themselves</a>.</p>
<h1><a class="header" href="#shell" id="shell">Shell</a></h1>
<p>The <em>shell</em>, called <em>Hydre</em>, is the part that interprets scripts.</p>
<ul>
<li><a href="technical/shell.html#commands">Commands</a></li>
<li><a href="technical/shell.html#pipes">Pipes</a></li>
<li><a href="technical/shell.html#specifications">Specifications</a></li>
</ul>
<h2><a class="header" href="#commands-1" id="commands-1">Commands</a></h2>
<p>Hydre works using <em>commands</em>, which can take <em>arguments</em>.
When running a command which comes from an applications which <a href="technical/../concepts/applications.html#commands">expose it</a>, the said application is run in a new process which uses its <a href="technical/../specs/applications/context.html#execution-context">execution context</a>.</p>
<p>The special thing about running an application from one of its exposed commands is that its CMDIN, CMDUSR, CMDMSG, CMDERR, CMDOUT and CMDRAW pipes are exposed to the caller.</p>
<p>You can find more informations about how a process can interact with a running command in the <a href="technical/../specs/kernel/ipc.html#interactive-usage">IPC documentation</a>.</p>
<h2><a class="header" href="#pipes" id="pipes">Pipes</a></h2>
<p>When a command is run from <a href="technical/../applications/Pluton.html">Pluton</a>, the command process' pipes are handled as follows:</p>
<ul>
<li>All user inputs are sent to the CMDUSR pipe</li>
<li>All messages sent through CMDMSG and CMDERR pipes are printed as they are received by the shell</li>
<li>The command's return value (from CMDOUT) is printed after the command completes</li>
<li>Data written to CMDRAW is not shown, as they don't have to be UTF-8 encoded, or even to be a string. They can be redirected through pipes, though</li>
</ul>
<h2><a class="header" href="#specifications" id="specifications">Specifications</a></h2>
<p>Hydre's specifications can be found in the <a href="technical/../specs/shell.html">related document</a>.</p>
<h1><a class="header" href="#specifications-1" id="specifications-1">Specifications</a></h1>
<p>This folder contains <em>specification documents</em>, whose purpose is to describe fully a specific concept or feature.
Think of these as reference documents - they are not meant to be easily understood without a solid knowledge of how NightOS works.
For more informations about low-level concepts these documents refer to, you can check the <a href="specs/../technical/">technical documents</a> first.</p>
<ul>
<li><a href="specs/applications/context.html">Application context</a> - launch an application to directly perform a specific task</li>
<li><a href="specs/applications/package.html">Applications package</a> - files representing a whole application</li>
<li><a href="specs/applications/manifest.html">Applications manifest</a> - how applications describe themselves in their package</li>
<li><a href="specs/filesystem.html">Filesystem</a> - how the filesystem works</li>
<li><a href="specs/libraries.html">Libraries</a> - what are libraries</li>
<li><a href="specs/registry.html">The registry</a> - exhaustive specification of the registry's content</li>
<li><a href="specs/vocabulary.html">Vocabulary</a> - the list of NightOS-related terms</li>
<li><a href="specs/shell.html">The shell</a> - how <a href="specs/../technical/shell.html">Hydre</a> works</li>
<li><a href="specs/shell-scripting.html">Shell scripting</a> - <a href="specs/../technical/shell.html">Hydre</a>'s scripting language</li>
<li><a href="specs/kernel/">Kernel</a> - complete specifications of the kernel</li>
<li><a href="specs/services.html">Services</a> - specifications about services work and behave</li>
<li><a href="specs/services/">System services</a> - complete list of system services</li>
</ul>
<h1><a class="header" href="#execution-context" id="execution-context">Execution Context</a></h1>
<p>An application's <em>execution context</em> is a piece of data that is provided when the application starts.<br />
It indicates why the application was started and so what it is supposed to do.</p>
<ul>
<li><a href="specs/applications/context.html#startup-reason">Startup Reason</a></li>
<li><a href="specs/applications/context.html#context-header">Context header</a></li>
<li><a href="specs/applications/context.html#arguments-structure">Arguments structure</a></li>
</ul>
<h2><a class="header" href="#startup-reason" id="startup-reason">Startup Reason</a></h2>
<p>The most important information is the <em>startup reason</em>, which indicates <em>why</em> the application was started.</p>
<p>It is one-byte long, and is made of the following bits (starting from the strongest):</p>
<ul>
<li>Bits 0-3:
<ul>
<li><code>0x1</code>: the application was started as part of its post-installation process</li>
<li><code>0x2</code>: the application was started as part of its pre-update process</li>
<li><code>0x3</code>: the application was started as part of its post-update process</li>
<li><code>0x4</code>: the application was started as part of its pre-uninstallation process</li>
<li><code>0x4</code>: the application was started by the system as an <a href="specs/applications/../../concepts/applications.html#services">application service</a></li>
<li><code>0x5</code>: the application was started by the desktop environment</li>
<li><code>0x6</code>: the application was started by itself (from another process of the same application)</li>
<li><code>0x7</code>: the application was started by another application</li>
<li><code>0x8</code>: the application was started using one its exposed <a href="specs/applications/../../concepts/applications.html#commands">shell commands</a></li>
</ul>
</li>
<li>Bit 4: set if the application was started automatically after a crash/improver shutdown and should to the <a href="specs/applications/../services/crashsave.html"><code>sys::crashsave</code></a> service to get a crashsave</li>
<li>Bit 5: set if the application's raw output (CMDRAW) will be read (e.g. through the use of a <a href="specs/applications/../shell-scripting.html#reading-a-commands-output">shell operator</a>)</li>
</ul>
<p>The startup reason is especially important as it determines what the application should do (e.g. uninstall itself, run as a command...) but also if it should output data through its CMDRAW in case it was called by a command.</p>
<h2><a class="header" href="#context-header" id="context-header">Context header</a></h2>
<p>The context header is stored as a single block of data, consisting of:</p>
<ul>
<li>The startup reason (1 byte)</li>
<li>Ambiant informations (1 byte)
<ul>
<li>Bit 0: set if the application is starting for the very first time since it was installed</li>
<li>Bit 1: set if the application is starting for the very first time for this specific user</li>
<li>Bit 2: set if the application is starting for the first time after an update</li>
<li>Bit 3: set if other instances of this application are running</li>
</ul>
</li>
<li>The application's <a href="specs/applications/../../concepts/applications.html#application-identifier">ANID</a> (4 bytes)</li>
</ul>
<p>If the command was not started a command, the context ends here. Else, it also contains the following informations:</p>
<ul>
<li>The ANID of the caller application (4 bytes)</li>
<li>The number of arguments the process was started with (1 byte)</li>
<li>The cumulated size of all arguments, in bytes - up to 63.5 KB (2 bytes)</li>
<li>RC identifier for the CMDIN pipe (8 bytes)</li>
<li>RC identifier for the CMDUSR pipe (8 bytes)</li>
<li>SC identifier for the CMDMSG pipe (8 bytes)</li>
<li>SC identifier for the CMDERR pipe (8 bytes)</li>
<li>SC identifier for the CMDRAW pipe (8 bytes)</li>
<li>SC identifier for the CMDOUT pipe (8 bytes)</li>
<li><em>Future-proof shift space</em> (196 bytes)</li>
</ul>
<h2><a class="header" href="#arguments-structure" id="arguments-structure">Arguments structure</a></h2>
<p>The context header is followed by the list of each command-line argument, taking up to 64 KB.</p>
<p>Arguments are a simple concatenation of <a href="specs/applications/commands.html#values-encoding">encoded values</a>.</p>
<h1><a class="header" href="#application-packages-1" id="application-packages-1">Application packages</a></h1>
<p>Application packages are files that have either the <code>.nap</code> (NightOS Application Package) or <code>.nva</code> (NightOS Volatile Application).</p>
<ul>
<li><a href="specs/applications/package.html#content">Content</a></li>
<li><a href="specs/applications/package.html#manifest">Manifest</a></li>
<li><a href="specs/applications/package.html#pre-compiled-applications">Pre-compiled applications</a></li>
</ul>
<h2><a class="header" href="#content" id="content">Content</a></h2>
<p>NAP and NVA files are ZStandard archives which only requirement is to contain, at the archive's root, a <code>manifest.toml</code> file describing the archive itself, a <code>hash.md5</code> ensuring the archive has not been corrupted.</p>
<h2><a class="header" href="#manifest" id="manifest">Manifest</a></h2>
<p>The manifest format can be found in the related <a href="specs/applications/manifest.html">specifications document</a>.</p>
<h2><a class="header" href="#pre-compiled-applications" id="pre-compiled-applications">Pre-compiled applications</a></h2>
<p>By default, and if possible, the system will always try to install <a href="specs/applications/../../technical/pre-compiling.html">pre-compiled programs</a> from applications' package. If the pre-compiled programs are not available, it will be built from source code - which takes a lot more time.</p>
<h1><a class="header" href="#application-manifest" id="application-manifest">Application Manifest</a></h1>
<p>Here is an example of an application manifest (<code>REQ</code>: required, <code>OPT</code>: optional):</p>
<pre><code class="language-yaml"># [REQ] Informations about the application
infos:
  # [REQ] Application's name, as shown when installing it
  name: Cloud Notepad App
  # [REQ] Application's slug, as stored on the disk in the /apps directory
  slug: cloud-notepad-app
  # [REQ] Application's description, as shown when installing it
  description: A notepad application that allows syncing your files in the cloud
  # [REQ] Application's version, following semantic versioning
  version: 1.0.0
  # [REQ] Application's authors
  authors:
    - name: Cl√©ment Nerma
      email: clement.nerma@gmail.com
  # [REQ] Application's icons (in the archive)
  # [REQ] &quot;%{}&quot;: either 16, 32, 64, 128 or 256 pixels (icons must be square)
  icon: assets/icons/app/%{}.png
  # [REQ] Application's license (must be in a list of available licenses)
  license: Apache-2.0

# [REQ] Application package's content
content:
  # Packages can either contain source code only, pre-compiled programs only, or both
  # &lt;for source packages&gt; [REQ]
  source:
    # [REQ] Build tool (must in the list of the toolchain's supported build tools)
    toolchain: rust
    # [REQ] Required build tool-related options
    build: {}
    # [OPT] Build tool-related options
    options:
      optimize: O3

  # &lt;for precomp packages&gt; [REQ]
  precomp: main.npp

# [OPT] Event triggers
events:
  # [OPT] Should the application start just after being installed?
  postinstall: false
  # [OPT] Should the application start just before being uninstalled?
  preuninstall: false
  # [OPT] Should the application start just before being updated?
  preupdate: false
  # [OPT] Should the application start just after being updated?
  postupdate: false

# [OPT] Exposed commands (see the related document for additional informations)
commands: {}

# [OPT] Does the application expose a service?
service: false

# [OPT] Additional informations
additional:
  # [OPT] Available languages (in a list of existing languages)
  languages: [&quot;en-US&quot;]

# [REQ] Application's dependencies
dependencies:
  # [REQ] Required libaries
  libraries:
    sysver: ^1.0.0 # Any stable version

  # [OPT] Required fonts
  fonts:
    fonts:open-sans: true # Any version
</code></pre>
<p>For more informations about exposed commands, see the <a href="specs/applications/commands.html">related document</a>.</p>
<h1><a class="header" href="#filesystem" id="filesystem">Filesystem</a></h1>
<p>This document presents how files are stored in NightOS.</p>
<ul>
<li><a href="specs/filesystem.html#presentation">Presentation</a></li>
<li><a href="specs/filesystem.html#symbolic-links">Symbolic links</a>
<ul>
<li><a href="specs/filesystem.html#concept">Concept</a></li>
<li><a href="specs/filesystem.html#cyclic-symlinks">Cyclic symlinks</a></li>
</ul>
</li>
<li><a href="specs/filesystem.html#flows">Flows</a>
<ul>
<li><a href="specs/filesystem.html#concept-1">Concept</a></li>
<li><a href="specs/filesystem.html#creating-a-flow">Creating a flow</a></li>
<li><a href="specs/filesystem.html#connecting-to-a-flow">Connecting to a flow</a></li>
</ul>
</li>
<li><a href="specs/filesystem.html#structure">Structure</a>
<ul>
<li><a href="specs/filesystem.html#notes">Notes</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#presentation" id="presentation">Presentation</a></h2>
<p>NightOS uses the <strong>Btrfs</strong> filesystem for the main storage due to its robustness, performance, and features (e.g. snapshots).</p>
<p>Three partitions are used to store the data:</p>
<ul>
<li>One <strong>FAT32</strong> partition for the bootloader ;</li>
<li>One <strong>Btrfs</strong> partition for the system (<code>/sys</code> and <code>/etc</code>) ;</li>
<li>One <strong>Btrfs</strong> partition for users' data (<code>/apps</code> and <code>/home</code>)</li>
</ul>
<h2><a class="header" href="#symbolic-links" id="symbolic-links">Symbolic links</a></h2>
<p><em>Symbolic links</em>, abbreviated <em>symlinks</em>, are files that point to another location.</p>
<h3><a class="header" href="#concept" id="concept">Concept</a></h3>
<p>A symlink points to a specific item: file, folder, device, anything. It's just not a shortcut, though, as the symlink will still work if its target is moved.</p>
<p>When a symlink is accessed, the system will transparently access its target item instead.</p>
<p>When a symlink is removed, it does not affect the original target. Also, any number of symlinks can target the same item, and symlinks can target other symlinks to. When accessing a symlink, if its target item is a symlink itself, the latter's target will be accessed instead, and so on, until we do not encounter a symlink anymore.</p>
<p>This can be explicitly disabled when interacting with the filesystem, or limited to a specific number of children.</p>
<p>Also, symbolic links may point to a location on another storage.</p>
<h3><a class="header" href="#cyclic-symlinks" id="cyclic-symlinks">Cyclic symlinks</a></h3>
<p>Given the following situation:</p>
<ol>
<li>We create a symlink <code>A</code> which points to a random file</li>
<li>We create a symlink <code>B</code> which points to <code>A</code></li>
<li>We update the target of <code>A</code> to be <code>B</code></li>
</ol>
<p>When we will try to access <code>A</code>, the system will access <code>B</code>, then <code>A</code>, then <code>B</code>, and so on. This is called a <em>cyclic symlink chain</em>. In such case, the chain is reduced to the minimum (for instance, if we had <code>C</code> pointing to <code>A</code>, the minimum chain would not be <code>C</code> <code>A</code> <code>B</code> but just <code>A</code> <code>B</code>), and marked as erroneous. The process that tried to access the symlink will receive a specific error code to indicate a cyclic symlink chain was encountered.</p>
<h2><a class="header" href="#flows" id="flows">Flows</a></h2>
<p><em>Flows</em> are a simple and efficient way for processes (mostly <a href="specs/services.html">services</a>) to allow treating flows of data.</p>
<h3><a class="header" href="#concept-1" id="concept-1">Concept</a></h3>
<p>A flow is a file without extension, located in the <code>/fl</code> directory, that can either send data to reader processes (<em>read-only</em>) or receive data from writer processes (<em>write-only</em>).</p>
<p>To understand the concept better, here is the list of native flow files that are always available:</p>
<table><thead><tr><th>Flow file</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>/fl/zero</code></td><td>Read-only</td><td>Outputs zeroes all the time ; useful to zero a file or device or to benchmark a storage</td></tr>
<tr><td><code>/fl/rand</code></td><td>Read-only</td><td>Outputs cryptographically-secure random numbers. Useful to randomly fill a storage or memory area</td></tr>
<tr><td><code>/fl/ucrand</code></td><td>Read-only</td><td>Outputs non-cryptographically-secure random numbers, thus faster that <code>/fl/rand</code></td></tr>
<tr><td><code>/fl/null</code></td><td>Write-only</td><td>Receives data but does nothing with them</td></tr>
</tbody></table>
<p>Processes are based on <a href="specs/kernel/ipc.html">pipes</a>.</p>
<h3><a class="header" href="#creating-a-flow" id="creating-a-flow">Creating a flow</a></h3>
<p>When a process wants to create a flow, it follows the following procedure:</p>
<ol>
<li>The process asks the <a href="specs/services/flow.html"><code>sys::flow</code></a> service to create a flow</li>
<li>The service creates the related flow file in <code>/fl</code></li>
<li>When a process reads from the (readable) flow file, all data is continuely retrieved from the creator's SC (until the flow is closed)</li>
<li>When a process writes to the (writable) flow file, all data is continuely written to the creator's RC (the flow is not closed after that though)</li>
<li>When the creator closes its SC/RC, the IPC channels duo is closed and the flow file is removed</li>
</ol>
<h3><a class="header" href="#connecting-to-a-flow" id="connecting-to-a-flow">Connecting to a flow</a></h3>
<p>When a process wants to read from or write to a file, it first asks the <a href="specs/services/flow.html"><code>sys::flow</code></a> service to connect to this file. If accepted, it receives a <a href="specs/kernel/ipc.html#pipes">SC or RC</a> to interact with the flow.</p>
<h2><a class="header" href="#structure" id="structure">Structure</a></h2>
<p>Below is the file tree indicating how elements are organized in NightOS.</p>
<p><em>NOTE:</em> <code>&lt;F&gt;</code> indicates the item is a file.</p>
<pre><code>/
‚îú‚îÄ‚îÄ app                            Interactables available to all users
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ &lt;appname&gt;                  An application's folder (NOTE: one sub-folder per version for libraries)
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ content                Application's program (executables, static resources, ...)
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ crashsaves             Application's crash saves
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ data                   Application's data (e.g. database)
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ packages               Application's packages (original package + update packages)
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ sandboxes              Application's sandboxes
‚îú‚îÄ‚îÄ dev                            Connected devices
‚îÇ   ‚îú‚îÄ‚îÄ cam                        Cameras
‚îÇ   ‚îú‚îÄ‚îÄ bst                        Basic storage devices (SD cards, USB keys, ...)
‚îÇ   ‚îú‚îÄ‚îÄ etc                        Uncategorized devices
‚îÇ   ‚îú‚îÄ‚îÄ mic                        Microphones
‚îÇ   ‚îú‚îÄ‚îÄ net                        Network adapters (Ethernet adapter, WiFi card, ...)
‚îÇ   ‚îú‚îÄ‚îÄ snd                        Sound-related output devices (Sound card, DAC, ...)
‚îÇ   ‚îú‚îÄ‚îÄ sst                        Sensitive storage devices (Hard drives, SSDs, ...)
‚îÇ   ‚îî‚îÄ‚îÄ wrl                        Other supported wireless devices (Bluetooth adapter, ...)
‚îú‚îÄ‚îÄ etc                            Mutable data folder
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ env   &lt;F&gt;                  Environment variables
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ hosts &lt;F&gt;                  Hosts overriding (e.g. 'localhost')
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ lock                       Opened lock files
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ logs                       Log files
‚îÇ¬†¬† |   ‚îî‚îÄ‚îÄ upe                    History of UPE requests (1)
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ public                     Public data, readable and writable by everyone
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ sys                        System's mutable data - available to system only
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ registry               System's registry
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ awake    &lt;F&gt;           System's shutdown indicator to detect if there was an error during last shutdown
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ hashes   &lt;F&gt;           Critical files' hashes for the integrity checker (2)
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ gbpwd    &lt;F&gt;           Global storage's encryption key (3)
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ users    &lt;F&gt;           User profiles and groups
‚îú‚îÄ‚îÄ fl                             Flow files
‚îú‚îÄ‚îÄ home                           Users' data
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ &lt;user&gt;                     A specific user's data
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ apps                   User's applications (same structure as for `/apps`)
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ appdata                User's applications persistent data (not removed when the application is uninstalled)
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ desktop                User's files appearing on the desktop
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ documents              User's documents
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ downloads              User's downloads
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ music                  User's music files
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ pictures               User's pictures
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ videos                 User's videos
‚îÇ       ‚îî‚îÄ‚îÄ trash                  User's trash
‚îú‚îÄ‚îÄ mnt                            Mounted storages
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ root                       Soft link to `/`
‚îú‚îÄ‚îÄ sys                            System - immutable outside of installation, repair processes and updates
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ apps                       System applications
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ boot                       System's boot program
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ langs                      Translation files
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ old                        Old versions of the system, used during the repair process (compressed archives)
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ backup                     Copy of the last system version (compressed archive)
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ kernel                     Custom micro-kernel
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ valid   &lt;F&gt;                A file that just contains &quot;ValidMasterKey&quot; to test if the provided master key is valid at startup
‚îú‚îÄ‚îÄ tmp                            Temporary folder (cleaned during shutdown)
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ &lt;user&gt;                     Temporary folder for a specific user
</code></pre>
<p>Links:</p>
<ul>
<li>(1) <a href="specs/../concepts/users.html#user-privileges-elevation-upe">UPE requests</a></li>
<li>(2) The <a href="specs/../technical/integrity-checker.html">integrity checker</a></li>
<li>(3) Global storage's <a href="specs/../features/encryption.html#global-encryption">encryption key</a></li>
</ul>
<h3><a class="header" href="#notes" id="notes">Notes</a></h3>
<p>Globally installed applications (located in <code>/apps</code>) can store user-specific data in <code>/home/[user]/appdata/[appname]</code>, which will only be made of the <code>data</code>, <code>crashsaves</code> and <code>sandboxes</code> folder.</p>
<h1><a class="header" href="#libraries-1" id="libraries-1">Libraries</a></h1>
<p>Libraries are NightOS' way to share code between multiple applications.</p>
<ul>
<li><a href="specs/libraries.html#manifest">Manifest</a></li>
</ul>
<h2><a class="header" href="#manifest-1" id="manifest-1">Manifest</a></h2>
<p>As libaries are only meant to share code, there manifest is a lot simplier than <a href="specs/applications/manifest.html">applications' manifest</a>.</p>
<pre><code class="language-yaml"># [REQ] Informations about the library
infos:
  # [REQ] Library's slug, as stored on the disk in the /apps directory
  slug: sound-synth
  # [OPT] Library's title, as shown when installing it
  name: Sound Synthesizer
  # [REQ] Library's description, as shown when installing it
  description: A small library to synthesize sound through virtual instruments
  # [REQ] Library's license (must be in a list of available licenses)
  license: Apache-2.0
  # [REQ] Library's version, following semantic versioning
  version: 1.0.0
  # [REQ] Library's authors
  authors:
    - name: Cl√©ment Nerma
      email: clement.nerma@gmail.com
  # [OPT] Library's icons (in the archive)
  # [OPT] &quot;%{}&quot;: either 16, 32, 64, 128 or 256 pixels (icons must be square)
  icon: assets/icons/app/%{}.png

# [REQ] Library package's content
content:
  # Packages can either contain source code only, pre-compiled programs only, or both
  # &lt;for source packages&gt; [REQ]
  source:
    # [REQ] Build tool (must in the list of the toolchain's supported build tools)
    toolchain: rust
    # [REQ] Required build tool-related options
    build: {}
    # [OPT] Build tool-related options
    options:
      optimize: O3

  # &lt;for precomp packages&gt; [REQ]
  precomp: main.nsl

# [REQ] Library dependencies
dependencies:
  sysver: ^1.0.0 # Any stable version
</code></pre>
<h1><a class="header" href="#registry-1" id="registry-1">Registry</a></h1>
<p>This document describes the format of the <a href="specs/../technical/registry.html">system registy</a> as well as its content.</p>
<ul>
<li><a href="specs/registry.html#format">Format</a>
<ul>
<li><a href="specs/registry.html#notes-about-types">Notes about types</a></li>
</ul>
</li>
<li><a href="specs/registry.html#hffr-format">HFFR Format</a></li>
<li><a href="specs/registry.html#structure">Structure</a></li>
</ul>
<h2><a class="header" href="#format" id="format">Format</a></h2>
<p>The registry is located in the <code>/etc/sys/registry</code> file. It's basically a nested B-Tree map.</p>
<p>Each map has string keys and a value that describes the entry: its purpose, its type with optional constraints, and then the type-safe value.</p>
<p>All types are described as a name, optionally followed by a maximum number of entries between brackets or a maximum number of bytes between braces. Here is the list, in <a href="specs/registry.html#hffr-format">HFRR notation</a>:</p>
<table><thead><tr><th>Name</th><th>Size (s) in bytes</th><th>Description</th></tr></thead><tbody>
<tr><td><code>struct</code></td><td>s = ?</td><td>A structure - keys are ASCII strings and values' type may be various</td></tr>
<tr><td><code>string</code></td><td>s = ?</td><td>An UTF-8 encoded string</td></tr>
<tr><td><code>string[x]</code></td><td>x &lt;= s &lt;= x * 4</td><td>An UTF-8 encoded string with a maximum capacity of <code>x</code> characters</td></tr>
<tr><td><code>string{x}</code></td><td>s &lt;= x * 4</td><td>An UTF-8 encoded string with a maximum capacity of <code>x</code> bytes</td></tr>
<tr><td><code>asciistr</code></td><td>s = ?</td><td>An ASCII encoded string</td></tr>
<tr><td><code>asciistr[x]</code></td><td>s &lt;= x</td><td>An ASCII encoded string with a maximum capacity of <code>x</code> characters</td></tr>
<tr><td><code>asciistr{x}</code></td><td>s &lt;= x</td><td>An ASCII encoded string with a maximum capacity of <code>x</code> bytes</td></tr>
<tr><td><code>int{x}</code></td><td>s = x</td><td>A signed integer on <code>x</code> bytes</td></tr>
<tr><td><code>uint{x}</code></td><td>s = x</td><td>An unsigned integer on <code>x</code> bytes</td></tr>
<tr><td><code>float{x}</code></td><td>s = x</td><td>A floating-point number on <code>x</code> bytes</td></tr>
<tr><td><code>pfloat{x}</code></td><td>s = x</td><td>A positive floating-point number on <code>x</code> bytes</td></tr>
<tr><td><code>ints</code></td><td>s = {CPU bits}</td><td>A signed integer on as many bytes as the CPU</td></tr>
<tr><td><code>uints</code></td><td>s = {CPU bits}</td><td>An unsigned integer on as many bytes as the CPU</td></tr>
<tr><td><code>bool</code></td><td>s = 1</td><td>A boolean</td></tr>
<tr><td><code>list:type</code></td><td>s = ?</td><td>A list of entries with the provided <code>type</code></td></tr>
<tr><td><code>list[x]:type</code></td><td>s = sizeof(type) * x</td><td>A list of entries with the provided <code>type</code> with a maximum of <code>x</code> entries</td></tr>
<tr><td><code>structlist</code></td><td>s = ?</td><td>A list of structures guaranteeing its first entry (the structure model) will never be removed</td></tr>
<tr><td><code>map:(key):(val)</code></td><td>s = ?</td><td>A dictionary mapping keys of the <code>key</code> to values of the <code>val</code> type</td></tr>
<tr><td><code>mapc:(key):(val)</code></td><td>s = ?</td><td>A dictionary mapping all possible keys of the <code>key</code> to values of the <code>val</code> type</td></tr>
<tr><td><code>structmap:(key)</code></td><td>s = ?</td><td>A dictionary mapping keys of the <code>key</code> to structures</td></tr>
<tr><td><code>structmapc:(key)</code></td><td>s = ?</td><td>A dictionary mapping all possible keys of the <code>key</code> to structures</td></tr>
<tr><td><code>time(p)</code></td><td>s &lt;= 8</td><td>A duration with a precision of <code>p</code> (see below)</td></tr>
<tr><td><code>tmin(p,min)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>time(p)</code> but with a minimum value</td></tr>
<tr><td><code>tmax(p,min)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>time(p)</code> but with a maximum value</td></tr>
<tr><td><code>tbtw(p,min,max)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>time(p)</code> but with a minimum and a maximum value</td></tr>
<tr><td><code>stime(p)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>time(p)</code> but allows negative durations</td></tr>
<tr><td><code>size(p)</code></td><td>s &lt;= 8</td><td>A data size with a precision of <code>p</code> (see below)</td></tr>
<tr><td><code>smin(p,min)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>size(p)</code> but with a minimum value</td></tr>
<tr><td><code>smax(p,min)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>size(p)</code> but with a maximum value</td></tr>
<tr><td><code>sbtw(p,min,max)</code></td><td>s &lt;= 8</td><td>Equivalent of <code>size(p)</code> but with a minimum and a maximum value</td></tr>
<tr><td><code>id:app</code></td><td>s &lt;= 256</td><td>Identifier of an installed application (ASCII string)</td></tr>
<tr><td><code>id:lib</code></td><td>s &lt;= 256</td><td>Identifier of an installed library (ASCII string)</td></tr>
<tr><td><code>id:user</code></td><td>s = 4</td><td>Identifier of an installed user (32-bit unsigned number)</td></tr>
<tr><td><code>in:(type):(a...)</code></td><td>s = max(sizeof(type))</td><td>Any value in the provided tuple</td></tr>
</tbody></table>
<p>The registry's root is a <code>struct</code>. Each key-value association in a struct is called a <em>node</em>. Nodes that are single values (neither a list, a map or a structure) or called <em>leafs</em>.</p>
<p>All sizes that are exceptly provided in bytes must be a multiple of two.</p>
<h3><a class="header" href="#notes-about-types" id="notes-about-types">Notes about types</a></h3>
<ul>
<li>
<p>Durations (<code>time</code>, <code>tmin</code>, <code>tmax</code> and <code>tbtw</code> types) have a precision which indicate the smallest unit of time they accept. <code>1</code> is for years, <code>2</code> for months, <code>3</code> for weeks, <code>4</code> for days, <code>5</code> for hours, <code>6</code> for minutes, <code>7</code> for seconds, <code>8</code> for milliseconds, <code>9</code> for microseconds and <code>10</code> for nanoseconds.</p>
</li>
<li>
<p>Sizes (<code>size</code>, <code>smin</code>, <code>smax</code> and <code>sbtw</code> types) accept values that are a multiple of their precision. <code>1</code> is for terabytes, <code>2</code> for gigabytes, <code>3</code> for megabytes, <code>4</code> for kilobytes, <code>5</code> for bytes and <code>6</code> for bits.</p>
</li>
<li>
<p>For the <code>struct</code> type, there is no need to specify the list of possible keys and the type of associated values, because they are already present in the registry when it's installed by the system - so it's all implicit. The keys in a struct should never change through time, nor the type of the value of each key. As such, it is not possible to create a list of <code>struct</code>, for instance.</p>
</li>
<li>
<p>For map structures (<code>structmap</code> and <code>structmapc</code>), the first key when sorting using the default algorithm for each type is guaranteed to never be removed. Its mapped value acts as the model structure for all over values in the map.</p>
</li>
</ul>
<h2><a class="header" href="#hffr-format" id="hffr-format">HFFR Format</a></h2>
<p>The registry can be converted for debugging to an HFRR text file (Human-Friendly Registry Format).</p>
<p>In this format, structures' keys are described using the <code>key(type):</code> format. Each line following it describing its value is indented by a tabulation (<code>\t</code>). The tabulation is decreased when the value has been fully describes.</p>
<p>Strings are describes using double quotes, with a <code>r</code> prefix symbol for ASCII strings. Floating-point numbers use a <code>.</code> symbol as their decimal separators, and an explicit <code>+</code> or <code>-</code> symbol indicates all numbers' sign.</p>
<p>Each list entry is prefixed by a <code>-</code> symbol, and each key is described as a set of <code>key: value</code> list (on multiple lines for lists and maps).</p>
<p>Empty lists are represented as <code>[]</code> and empty maps as <code>{}</code>.</p>
<p>Durations are represented as a combination of one or more integer numbers each followed by a time suffix (<code>ns</code> for nanoseconds, <code>us</code> for microseconds, <code>ms</code> for milliseconds, <code>s</code> for seconds, <code>m</code> for minutes, <code>h</code> for hours, <code>d</code> for days, <code>w</code> for weeks, <code>mo</code> for months or <code>y</code> for years). Also, combinations use the space separator and numbers are represented with leading zeros if necessary, except for the first number.</p>
<p>So for instance, a duration of 2 days and 10 seconds will give the string <code>2d 10s</code>.</p>
<p>Sizes are represented just like times, but with different suffixes (<code>TB</code> for terabytes, <code>GB</code> for gigabytes, <code>MB</code> for megabytes, <code>KB</code> for kilobytes, <code>B</code> for bytes and <code>b</code> for bits), and without leading zeroes.</p>
<p>So for instance a size of two terabytes and three kilobyte will be represented as <code>1TB 3KB</code>.</p>
<p>The easiest way to understand the format is to look at the default registry structure presented below.</p>
<h2><a class="header" href="#structure-1" id="structure-1">Structure</a></h2>
<p><strong>NOTE: This section is under heavy development and is by no mean complete!</strong></p>
<p>Here is the content of the default registry file (when installing NightOS with all default settings), converted to the <a href="specs/registry.html#hffr-format">HFRR format</a>:</p>
<pre><code class="language-yaml"># Kernel configuration (only editable in developer mode)
kernel(struct):
  # Signals configuration
  signals(struct):
    # Delay before forced suspension after WILL_SUSPEND signal
    suspend_delay(time(ms)): 500ms
    # Delay before forced termination (kill) after WILL_TERMINATE signal
    terminate_delay(time(ms)): 500ms
    # Delay for a service to answer a connection request
    service_answer_delay(ntime(ms,100ms)): 500ms

# System configuration
system(struct):
  # Debugging options
  debugging(struct):
    # Is development mode enabled?
    dev_mode(bool): true

  # Encryption
  encryption(struct):
    # Is the global storage encrypted?
    global_encrypted(bool): false

  # Date and time
  datetime(struct):
    # Is it based on the internet? (if not, it's a custom one)
    internet_based(bool): true
    # In the case the date is not internet-based, provide a timestamp which indicates the difference between the computer's
    #  local datetime and the one that should be displayed
    custom_based_diff(stime(ns)): 0ns

  # Crash saves
  crash_saves(struct):
    # Restore crash saves as soon as the user logs in
    restore_on_login(bool): true
    # Do not save crash saves for guest users
    disable_for_guest_user(bool): true
    # Delay between each crash save
    collect_every(tmin(s,1s)): 60s
    # Ask an application to create a new crash save even if the previous new has not been completed yet
    collect_if_previous_unanswered(bool): false

  # Freeze-prevention
  freeze_prevention(struct):
    # Reserved amount of memory (0 = disabled)
    reserved_memory(MB): 16MB
    # Reserved amount of CPU per virtual core (0 = disabled)
    reserved_cpu_vcore(uint{1}): 1

# Users (keys = user's unique identifier, value = user's type with 0 = main admin., 1 = admin., 2 = standard, 3 = guest)
# Detailed informations about each user (nickname, privileges, encryption password, ...) and groups are stored
#   in the user profiles file at '/etc/sys/users'
users(map:(uint{4}):(in:(0,1,2,3))):
  0: 1 # System
  1: 1 # Administrator
</code></pre>
<h1><a class="header" href="#vocabulary" id="vocabulary">Vocabulary</a></h1>
<p>This document introduces all vocabulary related to NightOS;</p>
<ul>
<li><a href="specs/vocabulary.html#graphics-related-terms">Graphics-related terms</a></li>
<li><a href="specs/vocabulary.html#surface">Surface</a></li>
<li><a href="specs/vocabulary.html#interaction">Interaction</a>
<ul>
<li><a href="specs/vocabulary.html#windows">Windows</a>
<ul>
<li><a href="specs/vocabulary.html#window">Window</a></li>
<li><a href="specs/vocabulary.html#borderless-windows">Borderless windows</a></li>
<li><a href="specs/vocabulary.html#resizable-windows">Resizable windows</a></li>
<li><a href="specs/vocabulary.html#windows-title-bar">Windows' title bar</a></li>
<li><a href="specs/vocabulary.html#windows-resizing-lines">Windows' resizing lines</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#graphics-related-terms" id="graphics-related-terms">Graphics-related terms</a></h2>
<h2><a class="header" href="#surface" id="surface">Surface</a></h2>
<p>A <em>surface</em> is a two-dimension area displayed on the screen. It is often used to refer to an application's window.</p>
<h2><a class="header" href="#interaction" id="interaction">Interaction</a></h2>
<p>An <em>interaction</em> with a given <a href="specs/vocabulary.html#surface">surface</a> consists in the user clicking on it on pressing a key while this surface is focused.</p>
<h3><a class="header" href="#windows" id="windows">Windows</a></h3>
<h4><a class="header" href="#window" id="window">Window</a></h4>
<p>A <em>window</em> is a 2D figure provided to an application for manipulation.
It does not refer to the desktop environment itself, or to the bootloader's screens for example.
There are several types of windows: <a href="specs/vocabulary.html#resizable-windows">resizable windows</a> and <a href="specs/vocabulary.html#borderless-windows">borderless windows</a>.</p>
<h4><a class="header" href="#borderless-windows" id="borderless-windows">Borderless windows</a></h4>
<p><em>Borderless</em> windows are windows without any titlebar nor <a href="specs/vocabulary.html#windows-resizing-lines">resizing lines</a>.</p>
<h4><a class="header" href="#resizable-windows" id="resizable-windows">Resizable windows</a></h4>
<p><em>Resizable</em> windows are the most common type of windows. They feature a <a href="specs/vocabulary.html#windows-title-bar">title bar</a> as well as <a href="specs/vocabulary.html#windows-resizing-lines">resizing lines</a>.</p>
<h4><a class="header" href="#windows-title-bar" id="windows-title-bar">Windows' title bar</a></h4>
<p>A window's <em>title bar</em> is a bar located above the window's content. It contains:</p>
<ul>
<li>On its left: a set of four buttons (customizable) which allow to hide the window in the taskbar, restore/maximize it, close it, or suspend/resume the related application ;</li>
<li>On its center: the window's title, which is controlled by the application and may change during the window's lifetime</li>
</ul>
<h4><a class="header" href="#windows-resizing-lines" id="windows-resizing-lines">Windows' resizing lines</a></h4>
<p>A window's <em>resizing lines</em> are four lines on all sides of a window, 1-pixel wide or high, which allow to extend or reduce the window's size relatively to the line's position.</p>
<p>For example, dragging the top line to a pixel higher on the screen will result in the window being extended to this direction - but other borders of the window won't move. Dragging the top line to the opposite direction will result in the window being compressed to this direction.</p>
<p>The top line is located above the window's titlebar.</p>
<h1><a class="header" href="#hydre" id="hydre">Hydre</a></h1>
<p>The <em>shell</em> is the part responsible for running <em>scripts</em>, which are small text-based programs that are natively available on every NightOS installation. It is called <em>Hydre</em> and is part of the system under the form of the <a href="specs/services/hydre.html"><code>sys::hydre</code></a> service.</p>
<p>You can get a quick overview of Hydre in its <a href="specs/../technical/shell.html">technical document</a>.</p>
<p><strong>NOTE:</strong> The behaviours described here only apply when using the <a href="specs/../applications/Pluton.html">Pluton</a> terminal application. Although all terminals are expected to follow these specifications as they act as a standard for terminals, they are technically not forced to and so misbehaviours may appear when using an alternative terminal application.</p>
<ul>
<li><a href="specs/shell.html#shell-sessions">Shell sessions</a>
<ul>
<li><a href="specs/shell.html#sessions-security">Sessions security</a></li>
</ul>
</li>
<li><a href="specs/shell.html#commands-evaluation">Commands evaluation</a></li>
<li><a href="specs/shell.html#command-pipes">Command pipes</a></li>
<li><a href="specs/shell.html#interactivity">Interactivity</a>
<ul>
<li><a href="specs/shell.html#input-data">Input data</a></li>
<li><a href="specs/shell.html#user-inputs">User inputs</a></li>
<li><a href="specs/shell.html#text-output">Text output</a>
<ul>
<li><a href="specs/shell.html#invalid-messages">Invalid messages</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="specs/shell.html#events-handling">Events handling</a></li>
<li><a href="specs/shell.html#scripting-language">Scripting language</a>
<ul>
<li><a href="specs/shell.html#pre-evaluation-checking">Pre-evaluation checking</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#shell-sessions" id="shell-sessions">Shell sessions</a></h2>
<p>Before evaluating commands, a <em>shell session</em> needs to be created using the <a href="specs/services/hydre.html"><code>sys::hydre</code></a> service.</p>
<p>A session has the following properties:</p>
<ul>
<li>A (changeable) width and height, in number of characters</li>
<li>Commands output are concatenated</li>
</ul>
<p>Commands can then be run inside the created session, and once they are all finished the same session can be closed using the same service. This simplify execution chaining, but also enables commands to be notified through the <a href="specs/services.html#communication">service's pipes</a> when the session is resized.</p>
<p>Only one <a href="specs/shell-scripting.html">shell instruction</a> can be run at a time, but as it may be made of multiple commands (e.g. <code>cmd1 | cmd2</code>), multiple processes may be binded to the same shell session. Also, <a href="specs/shell-scripting.html#running-in-background">background commands</a> may be running in parallel of the running command.</p>
<p>For instance, when using the <a href="specs/../applications/Pluton.html">Pluton</a> terminal, it creates on opening a shell session to run the commands in. When a new tab is opened, another shell session is opened for that tab. When the tab is destroyed, the session is destroyed as well, which means all commands running in it (including pipe and background commands) are killed.</p>
<h3><a class="header" href="#sessions-security" id="sessions-security">Sessions security</a></h3>
<p>When a command is run, the command's PID is registered in the session's <em>actors</em> list. When the command ends, it is removed from the list.<br />
When a process contacts the <a href="specs/services/hydre.html"><code>sys::hydre</code></a> service to access the session it runs in, Hydre gets the session associated to this process' PID, and returns it. If the PID is not associated to any session, the access is refused and the command won't be able to get any information on any session.</p>
<p>This prevents processes from accessing sessions they aren't part of.</p>
<h2><a class="header" href="#commands-evaluation" id="commands-evaluation">Commands evaluation</a></h2>
<p>Commands are evaluated one by one, as scripts cannot be run in a concurrent way. They are handled as follows:</p>
<ul>
<li>Builtin commands are treated internally by the shell</li>
<li>Application commands will result in launching the requested application in a separate process</li>
</ul>
<h2><a class="header" href="#command-pipes" id="command-pipes">Command pipes</a></h2>
<p>When an application is started from a command, its <a href="specs/applications/context.html#execution-context">execution context</a> indicates it and the process gets access to several pipes called the <em>command pipes</em>:</p>
<table><thead><tr><th>Pipe identifier</th><th>Standard pipe name</th><th>Pipe type</th><th>Format</th><th>Description</th></tr></thead><tbody>
<tr><td>CMDIN</td><td>Typed input</td><td>Raw</td><td><em>typed</em></td><td>Data coming either from a command pipe (`</td></tr>
<tr><td>CMDUSR</td><td>Interactive input</td><td>Message</td><td>UTF-8</td><td>Data coming from a terminal session (e.g. user inputs)</td></tr>
<tr><td>CMDMSG</td><td>Messages output</td><td>Message</td><td>UTF-8</td><td>Messages to display in the console, which won't be redirected by default</td></tr>
<tr><td>CMDERR</td><td>Errors output</td><td>Message</td><td>UTF-8</td><td>Messages to display as errors in the console, which won't be redirected by default</td></tr>
<tr><td>CMDRAW</td><td>Raw bytes</td><td>Raw</td><td>Raw</td><td>Output data, which will be redirected if an output pipe (<code>&gt;</code>) is used</td></tr>
<tr><td>CMDOUT</td><td>Typed output</td><td>Raw</td><td><em>typed</em></td><td>Typed output data, which will be used by <a href="specs/shell-scripting.html">shell scripts</a>)</td></tr>
</tbody></table>
<p>The SC/RC identifiers of these pipes are available in the application's <a href="specs/applications/context.html">context</a>.</p>
<p>The process that launched the command gets the ability to:</p>
<ul>
<li>Send data to the callee's CMDIN/CMDUSR pipe ;</li>
<li>Read data from the callee's CMDMSG/CMDERR/CMDRAW/CMDOUT pipes</li>
</ul>
<p>As this only applies to processes that can be started from commands, this only applies to <em>application processes</em> ; system processes not being linked to commands and worker processes being started from application processes (and so not directly from commands).</p>
<p>Technically speaking, commands are started by the <a href="specs/services/hydre.html"><code>sys::hydre</code></a> service and so by a system process. This same service creates the pipes and handles them. For more informations on this, please check the service's <a href="specs/services/hydre.html">documentation</a>.</p>
<p>If the process terminates before the return value has been fully transmitted through CMDOUT or if it closes the CMDOUT pipe before fully transmitting the value, the process is considered as faulty and killed immediatly (if still alive). The calling script (if any) exits with an error message, unless the error is caught with <code>catch</code>, the error message being generated by the system.</p>
<p>Even if the process closes its CMDMSG or CMDRAW pipe properly (by calling the <a href="specs/kernel/syscalls.html#0x25-close_pipe"><code>CLOSE_PIPE</code></a>), the command is not considered as finished until the process itself did not terminate.</p>
<p>Note that when a return value has been fully transmitted through CMDOUT, all pipes are closed and the command is considered as finished.</p>
<h2><a class="header" href="#interactivity" id="interactivity">Interactivity</a></h2>
<p>When an application command is run, the pipes are handled as follows.</p>
<h3><a class="header" href="#input-data" id="input-data">Input data</a></h3>
<p>All data coming from a command pipe (<code>|</code>) or from an input pipe (<code>&lt;</code>) (if the command's input type is <code>stream</code>) are transmitted through CMDIN.
Once the input data have been fully transmitted, the CMDIN pipe is closed.</p>
<h3><a class="header" href="#user-inputs" id="user-inputs">User inputs</a></h3>
<p>All user inputs (including raw keystrokes) are transmitted to CMDUSR, except a few ones:</p>
<ul>
<li><code>Ctrl-.</code>, which asks the process to suspend (triggers the <a href="specs/kernel/signals.html#0x10-suspend"><code>SUSPEND</code></a> signal)</li>
<li><code>Ctrl-Shift-.</code>, which forces the process to suspend (triggers the <a href="specs/kernel/signals.html#0x11-will_suspend"><code>WILL_SUSPEND</code></a> signal)</li>
<li><code>Ctrl-C</code>, which asks the process to terminate (triggers the <a href="specs/kernel/signals.html#0x12-terminate"><code>TERMINATE</code></a> signal)</li>
<li><code>Ctrl-Shift-C</code>, which forces the process to terminate (triggers the <a href="specs/kernel/signals.html#0x13-will_terminate"><code>WILL_TERMINATE</code></a> signal)</li>
<li>Custom GUI keystrokes like <code>Alt-F4</code></li>
<li>System-handled keystrokes like <code>Ctrl+Alt+Del</code></li>
</ul>
<p>User input messages use the following format (always starting from the strongest byte/bit):</p>
<ul>
<li>Byte 0: modifier keys
<ul>
<li>Bit 0: set if the <code>Command</code> or <code>Windows</code> key is pressed</li>
<li>Bit 1: set if the <code>Ctrl</code> key is pressed</li>
<li>Bit 2: set if the <code>Alt</code> key is pressed</li>
<li>Bit 3: set if the <code>Shift</code> key is pressed</li>
<li>Bit 4: set if the <code>Fn</code> key is pressed</li>
<li>Bit 5: set if Numeric Lock is enabled</li>
<li>Bit 6: set if Caps Lock is enabled</li>
<li>Bit 7: set if Scroll Lock is enabled</li>
</ul>
</li>
<li>Byte 1: keycode</li>
<li>Bytes 2-5: UTF-8 printable character on 4 bytes, or <code>0x00</code> if the character is not printable</li>
</ul>
<h3><a class="header" href="#text-output" id="text-output">Text output</a></h3>
<p>Commands may output either simple text messages (via CMDMSG) or error text messages (via CMDERR).<br />
<em>Conventionnally</em> (but it's up to the terminal application), text messages are displayed by default in white while error messages are displayed in red.</p>
<p>Messages must use the following format (always starting from the strongest byte/bit):</p>
<ul>
<li>Byte 0-2: RGB foreground color (<code>0</code> will use the current one)</li>
<li>Byte 3-5: RGB background color (<code>0</code> will use the current one)</li>
<li>Byte 6: style
<ul>
<li>Bit 0: if set, the message will be displayed in bold</li>
<li>Bit 1: if set, the message will be displayed in italic</li>
<li>Bit 2: if set, the message will be displayed with a line below it</li>
<li>Bit 3: if set, the message will be displayed with a line above it</li>
<li>Bit 4: if set, the message will be displayed reversed</li>
</ul>
</li>
<li>Byte 7: number of control characters</li>
<li>Byte 7-(N): control characters on 2 bytes each</li>
<li>Bytes (N+1)-(END): The message itself, encoded in UTF-8 (can be empty)</li>
</ul>
<p>Control characters use the following format:</p>
<ul>
<li>Strongest byte: control character code
<ul>
<li><code>0x00</code>: no control character</li>
<li><code>0x01</code>: move cursor up X times</li>
<li><code>0x02</code>: move cursor left X times</li>
<li><code>0x03</code>: move cursor right X times</li>
<li><code>0x04</code>: move cursor down X times</li>
<li><code>0x05</code>: move the cursor to the beginning of the line</li>
</ul>
</li>
<li>Weakest byte: data byte</li>
</ul>
<p>For instance, an <code>0x0305</code> control character is decomposable in the <code>0x03</code> code and the <code>0x05</code> data byte, which means moving the cursor to the right 5 times.</p>
<h4><a class="header" href="#invalid-messages" id="invalid-messages">Invalid messages</a></h4>
<p>A message is considered invalid if at least one of the following conditions is verified:</p>
<ul>
<li>The message's length is lower than 8 bytes + 2 * (number of control characters)</li>
<li>The provided control character is invalid</li>
</ul>
<p>Messages that do not follow this format will result in displaying Unicode's replacement character (<code>0xFFFD</code>: ÔøΩ) instead.</p>
<p>Messages providing an invalid foreground and/or background color will <em>conventionnally</em> (but it's up to the terminal application) in a specific color to indicate no right color could be determined.</p>
<h2><a class="header" href="#events-handling" id="events-handling">Events handling</a></h2>
<p>Commands can get informations on the current session using the <a href="specs/services/hydre.html"><code>sys::hydre</code></a> service.</p>
<p>This allows the command to be notified of events like windows resizing. For more informations, see the service's <a href="specs/services/hydre.html">specifications document</a>.</p>
<h2><a class="header" href="#scripting-language" id="scripting-language">Scripting language</a></h2>
<p>You can find more about the script language in the language's <a href="specs/../specs/shell-scripting.html">specifications document</a>.</p>
<h3><a class="header" href="#pre-evaluation-checking" id="pre-evaluation-checking">Pre-evaluation checking</a></h3>
<p>Before executing a script, the shell looks for errors in it, such as unknown command, invalid argument, type mismatch and so on. If an error is foud, the script doesn't even start to run ; an error is directly reported and the command is considered as failed.</p>
<p>This prevents errors from happening in the middle of a script, leaving it in an inconsistent state ; this also makes script errors easier to debug as they are reported at compile time.</p>
<h1><a class="header" href="#shell-scripting" id="shell-scripting">Shell scripting</a></h1>
<p>The scripting language of <a href="specs/../technical/shell.html">Hydre</a> offers a lot of powerful easy-to-use features. This allows to create complex script that are still very readable and maintanable.</p>
<ul>
<li><a href="specs/shell-scripting.html#running-a-command">Running a command</a>
<ul>
<li><a href="specs/shell-scripting.html#combining-short-arguments">Combining short arguments</a></li>
<li><a href="specs/shell-scripting.html#argument-values">Argument values</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#comments">Comments</a></li>
<li><a href="specs/shell-scripting.html#variables">Variables</a></li>
<li><a href="specs/shell-scripting.html#value-types">Value types</a>
<ul>
<li><a href="specs/shell-scripting.html#variables-shadowing">Variables shadowing</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#expressions">Expressions</a></li>
<li><a href="specs/shell-scripting.html#computing-values">Computing values</a>
<ul>
<li><a href="specs/shell-scripting.html#mathematical-operators">Mathematical operators</a></li>
<li><a href="specs/shell-scripting.html#bit-wise-operators">Bit-wise operators</a></li>
<li><a href="specs/shell-scripting.html#logical-operators">Logical operators</a></li>
<li><a href="specs/shell-scripting.html#assignment-operators">Assignment operators</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#blocks">Blocks</a>
<ul>
<li><a href="specs/shell-scripting.html#conditionals">Conditionals</a></li>
<li><a href="specs/shell-scripting.html#switches">Switches</a></li>
<li><a href="specs/shell-scripting.html#loops">Loops</a></li>
<li><a href="specs/shell-scripting.html#filesystem-iteration">Filesystem iteration</a></li>
<li><a href="specs/shell-scripting.html#variables-scoping">Variables scoping</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#functions">Functions</a>
<ul>
<li><a href="specs/shell-scripting.html#arguments">Arguments</a></li>
<li><a href="specs/shell-scripting.html#return-types">Return types</a></li>
<li><a href="specs/shell-scripting.html#methods">Methods</a></li>
<li><a href="specs/shell-scripting.html#failing">Failing</a>
<ul>
<li><a href="specs/shell-scripting.html#retries">Retries</a></li>
<li><a href="specs/shell-scripting.html#global-failing">Global failing</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#nullable-types">Nullable types</a>
<ul>
<li><a href="specs/shell-scripting.html#handle-the-null-value">Handle the <code>null</code> value</a></li>
<li><a href="specs/shell-scripting.html#the-case-of-optional-arguments">The case of optional arguments</a></li>
<li><a href="specs/shell-scripting.html#nullable-any">Nullable <code>any</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#advanced-types">Advanced types</a>
<ul>
<li><a href="specs/shell-scripting.html#structures">Structures</a></li>
<li><a href="specs/shell-scripting.html#closures">Closures</a></li>
<li><a href="specs/shell-scripting.html#streams">Streams</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#data-validation">Data validation</a></li>
<li><a href="specs/shell-scripting.html#event-listeners">Event listeners</a>
<ul>
<li><a href="specs/shell-scripting.html#waiting">Waiting</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#imports">Imports</a>
<ul>
<li><a href="specs/shell-scripting.html#aliases">Aliases</a></li>
<li><a href="specs/shell-scripting.html#import-expansions">Import expansions</a></li>
<li><a href="specs/shell-scripting.html#non-clashing-namespace">Non-clashing namespace</a></li>
<li><a href="specs/shell-scripting.html#volatile-imports">Volatile imports</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#commands-input--output">Commands input &amp; output</a>
<ul>
<li><a href="specs/shell-scripting.html#reading-a-commands-output">Reading a command's output</a></li>
<li><a href="specs/shell-scripting.html#redirecting-the-output-to-a-file">Redirecting the output to a file</a></li>
<li><a href="specs/shell-scripting.html#output-data">Output data</a>
<ul>
<li><a href="specs/shell-scripting.html#reading-from-cmdin">Reading from CMDIN</a></li>
<li><a href="specs/shell-scripting.html#returning-with-cmdout">Returning with CMDOUT</a></li>
<li><a href="specs/shell-scripting.html#writing-to-cmdraw">Writing to CMDRAW</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#input-of-a-command">Input of a command</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#running-in-background">Running in background</a></li>
<li><a href="specs/shell-scripting.html#environment-variables">Environment variables</a>
<ul>
<li><a href="specs/shell-scripting.html#reading-an-environment-variable">Reading an environment variable</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#commands-typing">Commands typing</a>
<ul>
<li><a href="specs/shell-scripting.html#arguments-type">Arguments type</a></li>
<li><a href="specs/shell-scripting.html#enumerations">Enumerations</a></li>
<li><a href="specs/shell-scripting.html#return-type">Return type</a></li>
<li><a href="specs/shell-scripting.html#conditionals-1">Conditionals</a></li>
<li><a href="specs/shell-scripting.html#example">Example</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#native-library">Native library</a>
<ul>
<li><a href="specs/shell-scripting.html#utilities">Utilities</a>
<ul>
<li><a href="specs/shell-scripting.html#envvarname-string---any"><code>env(varname: string) -&gt; any?</code></a></li>
<li><a href="specs/shell-scripting.html#promptmessage-string---string"><code>prompt(message: string) -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#prompt_intmessage-string---fallible-int"><code>prompt_int(message: string) -&gt; fallible int</code></a></li>
<li><a href="specs/shell-scripting.html#prompt_floatmessage-string---fallible-float"><code>prompt_float(message: string) -&gt; fallible float</code></a></li>
<li><a href="specs/shell-scripting.html#confirmmessage-string---fallible-bool"><code>confirm(message: string) -&gt; fallible bool</code></a></li>
<li><a href="specs/shell-scripting.html#chooseoptions-liststring---fallible-int"><code>choose(options: list[string]) -&gt; fallible int</code></a></li>
<li><a href="specs/shell-scripting.html#retry_cmdcmd-command-retries-int---fallible"><code>retry_cmd(cmd: command, retries: int) -&gt; fallible</code></a></li>
<li><a href="specs/shell-scripting.html#exit"><code>exit()</code></a></li>
<li><a href="specs/shell-scripting.html#last_failed---bool"><code>last_failed() -&gt; bool</code></a></li>
<li><a href="specs/shell-scripting.html#rand---float"><code>rand() -&gt; float</code></a></li>
<li><a href="specs/shell-scripting.html#rand_intlow-int-up-int---fallible-int"><code>rand_int(low: int, up: int) -&gt; fallible int</code></a></li>
<li><a href="specs/shell-scripting.html#rand_floatlow-float-up-float---fallible-float"><code>rand_float(low: float, up: float) -&gt; fallible float</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#all-types">All types</a>
<ul>
<li><a href="specs/shell-scripting.html#anystr---string"><code>any.str() -&gt; string</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#nullable-types-1">Nullable types</a>
<ul>
<li><a href="specs/shell-scripting.html#tisnull---t"><code>T?.isNull() -&gt; T</code></a></li>
<li><a href="specs/shell-scripting.html#tdefaultfallback-t---t"><code>T?.default(fallback: T) -&gt; T</code></a></li>
<li><a href="specs/shell-scripting.html#tunwrap---t"><code>T?.unwrap() -&gt; T</code></a></li>
<li><a href="specs/shell-scripting.html#texpectmessage-string---t"><code>T?.expect(message: string) -&gt; T</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#characters">Characters</a>
<ul>
<li><a href="specs/shell-scripting.html#charsingle---bool"><code>char.single() -&gt; bool</code></a></li>
<li><a href="specs/shell-scripting.html#charcodepoints---listint"><code>char.codepoints() -&gt; list[int]</code></a></li>
<li><a href="specs/shell-scripting.html#charlen---int"><code>char.len() -&gt; int</code></a></li>
<li><a href="specs/shell-scripting.html#charbytes---int"><code>char.bytes() -&gt; int</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#strings">Strings</a>
<ul>
<li><a href="specs/shell-scripting.html#stringchars---listchar"><code>string.chars() -&gt; list[char]</code></a></li>
<li><a href="specs/shell-scripting.html#stringcodepoints---listint"><code>string.codepoints() -&gt; list[int]</code></a></li>
<li><a href="specs/shell-scripting.html#stringlen---int"><code>string.len() -&gt; int</code></a></li>
<li><a href="specs/shell-scripting.html#stringbytes---int"><code>string.bytes() -&gt; int</code></a></li>
<li><a href="specs/shell-scripting.html#stringparse_intbase--10---fallible-int"><code>string.parse_int(base = 10) -&gt; fallible int</code></a></li>
<li><a href="specs/shell-scripting.html#stringparse_floatbase--10---fallible-float"><code>string.parse_float(base = 10) -&gt; fallible float</code></a></li>
<li><a href="specs/shell-scripting.html#stringupper_case---string"><code>string.upper_case() -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#stringlower_case---string"><code>string.lower_case() -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#stringreverse---string"><code>string.reverse() -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#stringconcatright-string---string"><code>string.concat(right: string) -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#stringsplitstr-string-sep-string---string"><code>string.split(str: string, sep: string) -&gt; string</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#lists">Lists</a>
<ul>
<li><a href="specs/shell-scripting.html#listcharstringify---str"><code>list[char].stringify() -&gt; str</code></a></li>
<li><a href="specs/shell-scripting.html#listtgetindex-int---t"><code>list[T].get(index: int) -&gt; T?</code></a></li>
<li><a href="specs/shell-scripting.html#listtexpectindex-number-message-string---t"><code>list[T].expect(index: number, message: string) -&gt; T</code></a></li>
<li><a href="specs/shell-scripting.html#listtunshiftvalue-t"><code>list[T].unshift(value: T)</code></a></li>
<li><a href="specs/shell-scripting.html#listtpushvalue-t"><code>list[T].push(value: T)</code></a></li>
<li><a href="specs/shell-scripting.html#listtunshift---t"><code>list[T].unshift() -&gt; T?</code></a></li>
<li><a href="specs/shell-scripting.html#listtpop---t"><code>list[T].pop() -&gt; T?</code></a></li>
<li><a href="specs/shell-scripting.html#listtsortasc--true---listt"><code>list[T].sort(asc = true) -&gt; list[T]</code></a></li>
<li><a href="specs/shell-scripting.html#listtreverse---listt"><code>list[T].reverse() -&gt; list[T]</code></a></li>
<li><a href="specs/shell-scripting.html#listtlen---int"><code>list[T].len() -&gt; int</code></a></li>
<li><a href="specs/shell-scripting.html#liststringjoinsep-----string"><code>list[string].join(sep = &quot;,&quot;) -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#listtconcatanother-listt---listt"><code>list[T].concat(another: list[T]) -&gt; list[T]</code></a></li>
<li><a href="specs/shell-scripting.html#listtconcatlists-listlistt---listt"><code>list[T].concat(lists: list[list[T]]) -&gt; list[T]</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#commands">Commands</a>
<ul>
<li><a href="specs/shell-scripting.html#commandrun---int"><code>command.run() -&gt; int</code></a></li>
<li><a href="specs/shell-scripting.html#commandfallible"><code>command.fallible()</code></a></li>
<li><a href="specs/shell-scripting.html#commandret_str---string"><code>command.ret_str() -&gt; string</code></a></li>
<li><a href="specs/shell-scripting.html#commandcmdraw---stream"><code>command.cmdraw() -&gt; stream</code></a></li>
<li><a href="specs/shell-scripting.html#commandcmdmsg---liststring"><code>command.cmdmsg() -&gt; list[string]</code></a></li>
<li><a href="specs/shell-scripting.html#commandcmderr---liststring"><code>command.cmderr() -&gt; list[string]</code></a></li>
<li><a href="specs/shell-scripting.html#commandoutput---liststring"><code>command.output() -&gt; list[string]</code></a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#streams-1">Streams</a>
<ul>
<li><a href="specs/shell-scripting.html#streampending---bool"><code>stream.pending() -&gt; bool</code></a></li>
<li><a href="specs/shell-scripting.html#streamsize_hint---int"><code>stream.size_hint() -&gt; int?</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#examples">Examples</a>
<ul>
<li><a href="specs/shell-scripting.html#guess-the-number">Guess The Number</a></li>
</ul>
</li>
<li><a href="specs/shell-scripting.html#native-commands">Native commands</a>
<ul>
<li><a href="specs/shell-scripting.html#echo-display-a-value"><code>echo</code>: display a value</a></li>
<li><a href="specs/shell-scripting.html#wt-write-a-file"><code>wt</code>: write a file</a></li>
<li><a href="specs/shell-scripting.html#rd-read-a-file"><code>rd</code>: read a file</a></li>
<li><a href="specs/shell-scripting.html#mkdir-create-a-directory"><code>mkdir</code>: create a directory</a></li>
<li><a href="specs/shell-scripting.html#ren-rename-a-filesystem-item"><code>ren</code>: rename a filesystem item</a></li>
<li><a href="specs/shell-scripting.html#mv-move-a-filesystem-item"><code>mv</code>: move a filesystem item</a></li>
<li><a href="specs/shell-scripting.html#rm-remove-a-filesystem-item"><code>rm</code>: remove a filesystem item</a></li>
<li><a href="specs/shell-scripting.html#ls-list-filesystem-items"><code>ls</code>: list filesystem items</a></li>
<li><a href="specs/shell-scripting.html#fd-find-filesystem-items"><code>fd</code>: find filesystem items</a></li>
<li><a href="specs/shell-scripting.html#syml-manage-symlinks"><code>syml</code>: manage symlinks</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#running-a-command" id="running-a-command">Running a command</a></h2>
<p>Hydre uses an intuitive syntax. Commands are written like they would be in *-sh shells: the command name is followed by arguments, each separated by a space.</p>
<p>Arugments can either be positional (they are written directly), shorts (prefixed by a <code>-</code> symbol and one-character long), or longs (prefixed by two <code>-</code> symbols). Here is an example:</p>
<pre><code class="language-hydre">cmdname &quot;pos1&quot; &quot;pos2&quot; -a --arg1
</code></pre>
<p>This line runs the command called <code>cmdname</code>, provides two positional arguments <code>pos1</code> and <code>pos2</code>, a short one <code>a</code> and a long one <code>arg1</code>.
Short and long arguments are called <em>dash arguments</em>.</p>
<h3><a class="header" href="#combining-short-arguments" id="combining-short-arguments">Combining short arguments</a></h3>
<p>It's possible to combine multiple short arguments in once by writing them one after the other:</p>
<pre><code class="language-hydre">cmdname -abc
</code></pre>
<p>This line is strictly equivalent to:</p>
<pre><code class="language-hydre">cmdname -a -b -c
</code></pre>
<h3><a class="header" href="#argument-values" id="argument-values">Argument values</a></h3>
<p>Short and long arguments can also require a value. This value must be provided using an <code>=</code> symbol or by simply using a space:</p>
<pre><code class="language-hydre">cmdname -s=1 --long=2
# or:
cmdname -s 1 --long 2
</code></pre>
<h2><a class="header" href="#comments" id="comments">Comments</a></h2>
<p>Comments can be written on a single line with the <code>#</code> symbol:</p>
<pre><code class="language-hydre">cmdname # single-line comment
</code></pre>
<p>Everything after the <code>#</code> symbol is ignored. For multiple-line comments, it's required to use three <code>#</code> symbols:</p>
<pre><code class="language-hydre">###
this
is a
multi-line
comment
###
</code></pre>
<h2><a class="header" href="#variables" id="variables">Variables</a></h2>
<p>Variables are declared with the <code>var</code> keyword:</p>
<pre><code class="language-hydre">var age = 19
</code></pre>
<p>Here, we declare a variable <code>age</code> with value <code>19</code>. As variables are typed, this variable will only be allowed to contain numbers from now on - no strings, no booleans, nothing else.</p>
<p>And to assign a new value to it:</p>
<pre><code class="language-hydre">age = 20
</code></pre>
<h2><a class="header" href="#value-types" id="value-types">Value types</a></h2>
<p>All arguments must match their expected <em>type</em>: if the command is expecting a number, we can't give it a list for instance.</p>
<p>Here is the list of all types and how they are written:</p>
<pre><code class="language-hydre"># Booleans (bool) (`true` or `false`)
_ = true

# Integers (int)
_ = 3

# Floating-point numbers (float)
_ = 3.14

# Characters (char)
_ = 'a'

# Strings (string)
_ = &quot;abc&quot;

# Lists of a given type (list[type])
_ = [ 3, 3.14 ]

# Paths (path) - must contain at least one `/` to indicate clearly that it's a path and not a string or something else
_ = dir/file.ext
_ = ./file.ext
_ = /tmp

# Commands (used to run custom commands later in functions)
_ = @{ command &quot;pos1&quot; -s --long }
</code></pre>
<p>A <code>string</code> is composed of multiple <code>char</code>s, which are made of single codepoints. This means a <em>grapheme cluster</em> made of multiple codepoints will need to be encoded in a <code>string</code>.<br />
There is also the <code>any</code> type which accepts values of all types, and <code>stream</code> which we'll talk about later as it's a special type.<br />
Finally, there is the <code>void</code> type which cannot be written 'as is' but is used in special contexts like <a href="specs/shell-scripting.html#commands-typing">commands return values</a>. It's a type that contains no data at all.</p>
<p>There are also <em>flag arguments</em>, which are dash arguments that take no value. The command will simply check if the argument was provided or not.</p>
<p><strong>NOTE:</strong> In order to avoid writing errors, positional arguments cannot be provided after a flag argument.</p>
<p>For instance, considering <code>pos1</code> and <code>pos2</code> are positional arguments, <code>--flag</code> a flag argument and <code>--val</code> a non-flag long argument:</p>
<pre><code class="language-hydre"># VALID
command &quot;pos1&quot; &quot;pos2&quot; --flag --val 2

# VALID
command &quot;pos1&quot; --val 2 &quot;pos2&quot; --flag

# VALID
command &quot;pos1&quot; --flag --val 2 &quot;pos2&quot;

# VALID
command --flags --val 2 &quot;pos1&quot; &quot;pos2&quot;

# INVALID (we could think by reading this that &quot;pos2&quot; is the
#          value of the non-flag argument &quot;--flag&quot;)
command &quot;pos1&quot; --flag &quot;pos2&quot; --val 2
</code></pre>
<h3><a class="header" href="#variables-shadowing" id="variables-shadowing">Variables shadowing</a></h3>
<p>Any variable can, inside a program, be replaced by a new variable with a same name but with a different type. This is called <em>shadowing</em>.</p>
<p>It can be useful when converting data from a type to another, such as:</p>
<pre><code class="language-hydre">var names: list[string] = [ &quot;Jack&quot;, &quot;John&quot; ]

var names: string = names.join(&quot;,&quot;) # this is called a _method_, we'll talk about them later
</code></pre>
<p>Here, we <em>shadowed</em> the <code>names</code> variable to create a new one with a different type from the data we had before, which means we cannot access the original <code>names</code> variable anymore.</p>
<h2><a class="header" href="#expressions" id="expressions">Expressions</a></h2>
<p>To use a variable, we can directly use it like this::</p>
<pre><code class="language-hydre">tellage ${age}
</code></pre>
<p>So this code:</p>
<pre><code class="language-hydre">var age = 20
tellage ${age}
</code></pre>
<p>Is equivalent to this one:</p>
<pre><code class="language-hydre">tellage 20
</code></pre>
<p>It's also possible to perform computations using expressions:</p>
<pre><code class="language-hydre">var age = 20
var add = 12
tellage ${age + add}
</code></pre>
<p>String and characters can also be inserted inside a string:</p>
<pre><code class="language-hydre">var name = &quot;Jack&quot;
echo &quot;Hello, ${name}!&quot; # Hello, Jack!
</code></pre>
<p>Values in lists through their index (starting at 0):</p>
<pre><code class="language-hydre">var names = [ &quot;Jack&quot; ]
echo &quot;Hello, ${names[0]}!&quot; # Hello, Jack!
</code></pre>
<p>Note that getting an out-of-bound index will make the program <em>panic</em>, which means it exits immediatly with an error message.</p>
<pre><code class="language-hydre">var names = [ &quot;Jack&quot; ]
echo &quot;Hello, ${names[1]}!&quot; # Panics
</code></pre>
<h2><a class="header" href="#computing-values" id="computing-values">Computing values</a></h2>
<p>It's also possible to compute values using operators. Each operator takes one or multiple operands, which can be either a variable or a literal value.</p>
<h3><a class="header" href="#mathematical-operators" id="mathematical-operators">Mathematical operators</a></h3>
<p>Mathematical operators all take two operands. If any of the operands is not a number, it will fail.
If both operands are integers, the result will be an integer, but if at least one is a floating-point number, so will be the result.</p>
<p>The operators are:</p>
<ul>
<li><code>+</code>: addition</li>
<li><code>-</code>: substraction</li>
<li><code>*</code>: multiplication</li>
<li><code>**</code>: pow</li>
<li><code>/</code>: division</li>
<li><code>//</code>: floating-point division (gives a floating-point number even if the two operands are integers)</li>
<li><code>%</code>: remainder (works only with two integers)</li>
</ul>
<h3><a class="header" href="#bit-wise-operators" id="bit-wise-operators">Bit-wise operators</a></h3>
<p>Bit-wise operators only take integer operands and produce an integer result:</p>
<ul>
<li><code>&amp;</code> bit-by-bit and</li>
<li><code>|</code> bit-by-bit or</li>
<li><code>^</code> bit-by-bit exclusive or</li>
<li><code>&lt;&lt;</code> binary left shift operator</li>
<li><code>&gt;&gt;</code> binary right shift operator</li>
<li><code>~</code> one's complement - takes a single number</li>
</ul>
<h3><a class="header" href="#logical-operators" id="logical-operators">Logical operators</a></h3>
<p>Logical operators take two operands and return a boolean:</p>
<table><thead><tr><th>Symbol</th><th>Name</th><th>Returns <code>true</code> if...</th></tr></thead><tbody>
<tr><td><code>&amp;&amp;</code></td><td>and</td><td><code>a</code> and <code>b</code> are <code>true</code> booleans</td></tr>
<tr><td><code>\|\|</code></td><td>or</td><td><code>a</code>, <code>b</code> or both are <code>true</code> booleans</td></tr>
<tr><td><code>==</code></td><td>equal to</td><td><code>a</code> is equal to <code>b</code></td></tr>
<tr><td><code>!=</code></td><td>different than</td><td><code>a</code> is different than <code>b</code></td></tr>
<tr><td><code>&gt;</code></td><td>greater than</td><td><code>a</code> is greater than <code>b</code></td></tr>
<tr><td><code>&lt;</code></td><td>lower than</td><td><code>a</code> is lower than <code>b</code></td></tr>
<tr><td><code>&gt;=</code></td><td>greater than or equal to</td><td><code>a</code> is greater than or equal to <code>b</code></td></tr>
<tr><td><code>&lt;=</code></td><td>lower than or equal to</td><td><code>a</code> is lower than or equal to <code>b</code></td></tr>
</tbody></table>
<p>Finally, there is the <code>!</code> operator, which takes a single operand on its right, and simply reverts a boolean.</p>
<h3><a class="header" href="#assignment-operators" id="assignment-operators">Assignment operators</a></h3>
<p>The neutral assignment operator <code>=</code> can be prefixed by any mathematical, bit-wise or logical operator's symbol(s). The operator's left operand will be the current variable's content, while the right one will be the value on the left of the assignment operator. The result will then be stored in the variable.</p>
<p>Here is an example:</p>
<pre><code class="language-hydre">var a = 3

a += 1
a *= 8
a /= 2

echo ${a} # 16
</code></pre>
<p>Note that the result's type must be compatible with the variable:</p>
<pre><code class="language-hydre">var a = 0

a &amp;&amp;= 1 # ERROR: Cannot assign a 'bool' to an 'int'
</code></pre>
<p>There are also the <code>++</code> and <code>--</code> operators, which respectively increase and decrease the desired variable:</p>
<pre><code class="language-hydre">var a = 0

a ++
a ++
a --

echo ${a} # 1
</code></pre>
<h2><a class="header" href="#blocks" id="blocks">Blocks</a></h2>
<p>Blocks allow to run a piece of code multiple times or if a specific condition is met. They are useful combined to comparison operators.</p>
<h3><a class="header" href="#conditionals" id="conditionals">Conditionals</a></h3>
<p>Conditionals uses the following syntax:</p>
<pre><code class="language-hydre">if # condition
  command1
end
</code></pre>
<p>When this block is ran, if <code>condition</code> (which is an expression that must result in a boolean) is equal to <code>true</code>, <code>command1</code> is ran. Here is an example:</p>
<pre><code class="language-hydre">if 2 + 2 == 4
  command1
end
</code></pre>
<p>It's possible to specify multiple commands at once:</p>
<pre><code class="language-hydre">if 2 + 2 == 4
  command1
  command2
  command3
end
</code></pre>
<p>Note that all commands must be indented by one tabulation.</p>
<p>It's also possible to run a set of commands in case the condition isn't met too using <code>else</code>:</p>
<pre><code class="language-hydre">if 2 + 2 == 4
  command1
else
  command2
end
</code></pre>
<p>Finally, conditions can be chained using <code>elif</code>:</p>
<pre><code class="language-hydre">if 1 + 1 == 4
  echo &quot;Bizarre.&quot;
elif 1 + 1 == 3
  echo &quot;Bizarre!&quot;
else
  echo &quot;Normal.&quot;
end
</code></pre>
<h3><a class="header" href="#switches" id="switches">Switches</a></h3>
<p>A <em>switch</em> allows to perform actions depending on a value. It's roughly equivalent to a combination of multiple <code>if</code> and <code>elif</code> statements.</p>
<pre><code class="language-hydre">switch rand_int(0, 10)
  when 0
    echo &quot;It's zero!&quot;

  when 1
    echo &quot;It's one!&quot;

  else
    echo &quot;It's something else&quot;
end
</code></pre>
<p>Note that, for blocks that only contain a single instruction, we can shorten this using the following syntax:</p>
<pre><code class="language-hydre">switch rand_int(0, 10)
  when 0 =&gt; echo &quot;It's zero!&quot;
  when 1 =&gt; echo &quot;It's one!&quot;
  else   =&gt; echo &quot;It's something else!&quot;
end
</code></pre>
<h3><a class="header" href="#loops" id="loops">Loops</a></h3>
<p>Loops allow to run a piece of code for a while. The most common loop is the range loop:</p>
<pre><code class="language-hydre">for i in 0..10
  command ${i}
end
</code></pre>
<p>This will run <code>command 0</code> to <code>command 9</code>. To include the upper bound, we must add an <code>=</code> symbol:</p>
<pre><code class="language-hydre">for i in 0..=10
  command ${i}
end
</code></pre>
<p>This will run <code>command 0</code> to <code>command 10</code>.</p>
<p>We can also iterate on a list:</p>
<pre><code class="language-hydre">var str = &quot;Jack&quot;

var list = [ &quot;Jack&quot;, &quot;John&quot; ]

for name in list
  echo ${name}
end
</code></pre>
<p>This will display <code>Jack</code> and <code>John</code>.</p>
<p>To get the indexes as well, we can do:</p>
<pre><code class="language-hydre">for i, name in list
  echo &quot;${i}: ${name}&quot;
end
</code></pre>
<p>This will display <code>0: Jack</code> and <code>1: John</code>.</p>
<p>There is another type of loop, which runs a piece of code while a condition is met:</p>
<pre><code class="language-hydre">while # condition
  command
end
</code></pre>
<p>If the <code>condition</code> is <code>false</code> when the loop is reached, the <code>command</code> will not be ran once. Else, it will be ran as long as the <code>condition</code> is <code>true</code>.</p>
<p>Note that loops can be broke anytime using the <code>break</code> keyword:</p>
<pre><code class="language-hydre">for i in 0..10
  command ${i}

  if i == 2
    break
  end
end
</code></pre>
<p>This will run <code>command 0</code>, <code>command 1</code> and <code>command 2</code> only.</p>
<h3><a class="header" href="#filesystem-iteration" id="filesystem-iteration">Filesystem iteration</a></h3>
<p>It's possible to iterate on a list of files and directories:</p>
<pre><code class="language-hydre">for file in (./*.txt)
  echo &quot;Found a text file: ${file}&quot;
end
</code></pre>
<p>The pattern between parenthesis must be a glob pattern. Recursivity is supported to:</p>
<pre><code class="language-hydre">for file in (**/*.txt)
  echo &quot;Found a text file: ${file}&quot;
end
</code></pre>
<h3><a class="header" href="#variables-scoping" id="variables-scoping">Variables scoping</a></h3>
<p>When a variable is declared, it is <em>scoped</em> to the current block, meaning it doesn't exist outside of the current block:</p>
<pre><code class="language-hydre"># This variable is declared in the &quot;global&quot; block
# so it's available everywhere in the current script
var firstName = &quot;Jack&quot;

if firstName == &quot;Jack&quot;
  # This variable is declared in an &quot;if&quot; block
  # so it's not available outside of it
  var lastName = &quot;Sparrow&quot;
end

echo ${firstName} # Prints: &quot;Jack&quot;
echo ${lastName} # ERROR (&quot;lastName&quot; is not in scope)
</code></pre>
<p>Also, variables are not shared between scripts.</p>
<h2><a class="header" href="#functions" id="functions">Functions</a></h2>
<p>Functions allow to split the code in several parts to make it more readable, as well as to re-use similar pieces of code across the script.</p>
<pre><code class="language-hydre">fn hello()
  echo &quot;Hello!&quot;
end
</code></pre>
<p>Now we can call <code>hello</code> this way:</p>
<pre><code class="language-hydre">hello() # Will print &quot;Hello !&quot;
</code></pre>
<h3><a class="header" href="#arguments" id="arguments">Arguments</a></h3>
<p>Function can also take arguments, which must have a type.</p>
<pre><code class="language-hydre">fn hello (name: string)
  echo &quot;Hello, ${name}!&quot;
end

hello(&quot;Jack&quot;) # Will print &quot;Hello, Jack!&quot;
</code></pre>
<p>Arguments can be made optional by providing default values. This also allows to get rid of their explicit type as it's now implicit:</p>
<pre><code class="language-hydre">fn hello (name = &quot;Unknown&quot;)
  echo &quot;Hello, ${name}!&quot;
end

hello()       # Will print &quot;Hello, Unknown!&quot;
hello(&quot;Jack&quot;) # Will print &quot;Hello, Jack!&quot;
</code></pre>
<p>Note that a function's arguments do not require to wrap the value between <code>${...}</code> as it's implicit. Which means we can write:</p>
<pre><code class="language-hydre">var name = &quot;Jack&quot;
hello(name) # Prints: &quot;Hello, Jack!&quot;
</code></pre>
<p>We can also combine functions and blocks, for instance:</p>
<pre><code class="language-hydre">fn greet (names: list[string]) -&gt; int
  # .len() is called an _extension_, we will see more about that later
  if names.len() == 0
    echo &quot;No one to greet :|&quot;
  else
    for name in names
      echo &quot;Hello, ${name}!&quot;
    end
  end
end

hello([])               # No one to greet :|
hello([&quot;John&quot;, &quot;Jack&quot;]) # Hello, John! Hello, Jack!
</code></pre>
<h3><a class="header" href="#return-types" id="return-types">Return types</a></h3>
<p>Functions can also return values. In such case, they must specify the type of values they return, and ensure all code paths will return a value of this type:</p>
<pre><code class="language-hydre">fn add (a: float, b: float) -&gt; float
  return a + b
end
</code></pre>
<h3><a class="header" href="#methods" id="methods">Methods</a></h3>
<p>All value types expose specific functions that can be used with a dot after a variable of the given type, called <em>methods</em>:</p>
<pre><code class="language-hydre">var letters = &quot;abcdef&quot;
var letters = letter.split(&quot;,&quot;)
</code></pre>
<p>Here, we use the <code>split</code> <em>method</em> of the <code>string</code> type, which returns a <code>list[string]</code>.</p>
<h3><a class="header" href="#failing" id="failing">Failing</a></h3>
<p>Functions can also <em>fail</em> to indicate something went wrong:</p>
<pre><code class="language-hydre">fn divide (a: float, b: float) -&gt; fallible float
  if b == 0
    fail &quot;Cannot divide by 0!&quot;
  else
    return a / b
  end
end
</code></pre>
<p>The <code>fallible</code> keyword must be present before the return type to indicate the function may fail (even if the function doesn't return anything).</p>
<p>When a function fails, the program stops and print the provided error message. But it's also possible to handle the error:</p>
<pre><code class="language-hydre">fn handle_bad_div (a: float, b: float) -&gt; float
  catch divide(a, b)
    ok result
      echo &quot;Divided successfully: ${a} / ${b} = ${result}&quot;

    err errmsg
      echo &quot;Division failed :(&quot;
      echo &quot;Here is the error message: ${errmsg}&quot;
  end
end
</code></pre>
<p>Note that you may handle only the success or error case depending on your needs ; you do not have to handle both cases.</p>
<p>This keyword also allows to catch errors from commands:</p>
<pre><code class="language-hydre"># Run a command and get error messages from CMDERR instead if the command fails
catch $(somecommand)
  ok data =&gt; echo &quot;Success: ${data}&quot;
  err msg =&gt; echo &quot;Errors: ${msg.join(&quot;; &quot;)}&quot;
end
</code></pre>
<h4><a class="header" href="#retries" id="retries">Retries</a></h4>
<p>It's possible to retry a function until it succeeds using the <code>retry</code> keyword:</p>
<pre><code class="language-hydre">fn may_fail ()
  if rand() &gt; 0.5
    fail &quot;I don't like high numbers&quot;
  end
end

retry may_fail()
</code></pre>
<p>This will run <code>may_fail</code>, and run it again if it fails, until it succeeds.</p>
<p>It's also possible to specify a maximum  of retries:</p>
<pre><code class="language-hydre">retry(5) may_fail()
</code></pre>
<p>For information, here is the declaration of the native <code>retry_cmd</code> command, which allows to try to run a command until it succeeds:</p>
<pre><code class="language-hydre">fn retry_cmd(cmd: command, retries: string) -&gt; fallible
  retry(retries) cmd()
  if status() != 0
    fail &quot;Command did not suceed after ${retries} retries.&quot;
  end
end
</code></pre>
<p>It can be used like this:</p>
<pre><code class="language-hydre">retry_cmd(@{ read &quot;file.txt&quot; }, 10)
</code></pre>
<h4><a class="header" href="#global-failing" id="global-failing">Global failing</a></h4>
<p>A whole script can fail using this keyword, which will result in displaying the error message in CMDERR and exiting immediatly.<br />
The failure may be handled using <code>fallible</code> in the caller script.</p>
<h2><a class="header" href="#nullable-types" id="nullable-types">Nullable types</a></h2>
<p>Sometimes, it's useful to be able to represent a value that may be either <em>something</em> or <em>nothing</em>. In many programming languages, &quot;nothing&quot; is represented as the <code>null</code>, <code>nil</code> or <code>()</code> value.</p>
<p>Nullable types are suffixed by a <code>?</code> symbol, and may either contain a value of the provided type <strong>or</strong> <code>null</code>. Here is an example:</p>
<pre><code class="language-hydre">fn custom_rand() -&gt; int?
  var rnd = rand_int(-5, 5)

  if rnd &gt; 0
    return rnd
  else
    return null
  end
end
</code></pre>
<p>To declare a variable with an nullable type, we wrap its initialization value in the nullable operator <code>?(...)</code>:</p>
<pre><code class="language-hydre">var a = 1 # int
var b = ?(1) # int?
</code></pre>
<p>Or we explicitly give the variable a nullable type:</p>
<pre><code class="language-hydre">var b: int? = 1 # int?
</code></pre>
<p>To initialize the variable with the <code>null</code> value instead, we must use the explicit version:</p>
<pre><code class="language-hydre">var c: int? = null # int?
</code></pre>
<p>Note that imbricated types are not supported, which means we cannot create <code>int??</code> values for instance.</p>
<h3><a class="header" href="#handle-the-null-value" id="handle-the-null-value">Handle the <code>null</code> value</a></h3>
<p>If we try to access an nullable value &quot;as is&quot;, we will get a type error:</p>
<pre><code class="language-hydre">var a = ?(1)

var b = 0
b = a # ERROR: Cannot use an `int?` value where `int` is expected
</code></pre>
<p>We then have multiple options. We can use one of the nullable types' function:</p>
<pre><code class="language-hydre">var a = ?(1)

var b = 0

# Make the program exit with an error message if 'a' is null
b = a.unwrap()

# Make the program exit with a custom error message if 'a' is null
b = a.expect(&quot;'a' should not be null :(&quot;)
</code></pre>
<p>We can also detect if a value is <code>null</code> by using the <code>.isNull()</code> method:</p>
<pre><code class="language-hydre">var a = ?(1)
var b: int? = null

echo ${a.isNull()} # false
echo ${b.isNull()} # true
</code></pre>
<p>There is also the <code>.default(T)</code> method that allows to use a fallback value in case of <code>null</code>:</p>
<pre><code class="language-hydre">var a = ?(1)
var b: int? = null

echo ${a.default(3)} # 1
echo ${b.default(3)} # 3
</code></pre>
<p>We can also use special syntaxes in blocks:</p>
<pre><code class="language-hydre">var a = ?(1)

if some a
  # While we are in this block, 'a' is considered as an 'int'
else
  # While we are in this block, 'a' is considered as 'null'
end

while some a
  # Same here
end
</code></pre>
<p>Also, if the program exits in all cases when the argument is considered as null or non-null, the opposite type will be applied to the rest of the program:</p>
<pre><code class="language-hydre">var a = ?(1)

if some a
  exit
end

# 'a' is considered as 'null' here

var b = ?(1)

if none b
  exit
end

# 'b' is considered as 'int' here
</code></pre>
<h3><a class="header" href="#the-case-of-optional-arguments" id="the-case-of-optional-arguments">The case of optional arguments</a></h3>
<p>When a command takes an optional argument, it's possible to provide a nullable value of the same type instead:</p>
<pre><code class="language-hydre">var no_newline = ?(false)

echo &quot;Hello!&quot; -n ${no_newline}
</code></pre>
<p>If the value is <code>null</code>, the argument will not be provided. Else, it will be provided with the non-null value.</p>
<h3><a class="header" href="#nullable-any" id="nullable-any">Nullable <code>any</code></a></h3>
<p>The <code>any</code> type covers any type of values, meaning it accepts absolutely every single value, <em>except</em> the <code>null</code> value. Indeed, <code>any</code> is not nullable by default, so to make it accept <code>null</code> values we must use <code>any?</code> instead.</p>
<h2><a class="header" href="#advanced-types" id="advanced-types">Advanced types</a></h2>
<h3><a class="header" href="#structures" id="structures">Structures</a></h3>
<p><em>Structures</em> map one or multiple <em>fields</em> to as many <em>values</em>. Here is an example:</p>
<pre><code class="language-hydre">fn sayHello(person: struct { firstName: string, lastName: string })
  echo &quot;Hello, ${person.firstName} ${person.lastName}!&quot;
end

sayHello({ firstName: &quot;Bat&quot;, lastName: &quot;Man&quot; }) # Prints: &quot;Hello, Bat Man!&quot;
</code></pre>
<p>In such a simple example, it's easier to directly use a <code>firstName</code> and <code>lastName</code> parameters instead of a <code>struct</code>, but they are useful when returning heterogenous sets of data, for example in a list:</p>
<pre><code class="language-hydre">fn listRecursively(dir: path) -&gt; list[struct { name: path, size: int }]
  var list: list[struct { name: path, size: int }] = []

  for item in $(ls ${dir} --details)
    if item.isDirectory
      listRecursively(dir)
    else
      list[] = { name: item.path, size: stats.sizeOf }
    end
  end

  return list
end
</code></pre>
<p>But, as this is not very readable, it's better to use a <em>type alias</em>:</p>
<pre><code class="language-hydre">type fsItem = struct { name: path, size: int }

fn listRecursively(dir: path) -&gt; list[fsItem]
  var list: list[fsItem] = []
  # ...
end
</code></pre>
<h3><a class="header" href="#closures" id="closures">Closures</a></h3>
<p>Closures are anonymous functions which are generally used to repeat the same group of operations.</p>
<pre><code class="language-hydre">var test: fn (string, int) = { a, b -&gt; echo &quot;${a.repeat(b)}&quot; }
test(&quot;Hello world! &quot;, 3) # Prints: &quot;Hello world! Hello world! Hello world! &quot;
</code></pre>
<p>Note that closures can also return values implicitly:</p>
<pre><code class="language-hydre">var test: fn (string, int) -&gt; string = { a, b -&gt; a.repeat(b) }
echo ${test(&quot;Hello world!&quot;, 3)} # Prints: &quot;Hello world! Hello world! Hello world! &quot;
</code></pre>
<p>Also, closures are not forced to take their declared parameters:</p>
<pre><code class="language-hydre">type testType = fn (string, int)

var test: testType = { a, b, c -&gt; ### ... ### } # NOT VALID
var test: testType = { a, b    -&gt; ### ... ### } # Valid
var test: testType = { a       -&gt; ### ... ### } # Valid
var test: testType = {         -&gt; ### ... ### } # Valid
</code></pre>
<p>Here is a concrete usage example:</p>
<pre><code class="language-hydre">fn forEachFile(dir: path, callback: fn (path))
  for item in $(ls ${dir} --details)
    if item.isFile
      callback(item.fullPath)
    end
  end
end

forEachFile(./, { file -&gt; echo &quot;File: ${file}&quot; })
</code></pre>
<h3><a class="header" href="#streams" id="streams">Streams</a></h3>
<p>An usual type for manipulating large data is <code>stream</code>, which is notably used to treat a chunk of data that is either too large for the memory or is more easier to treat as things progress.</p>
<h2><a class="header" href="#data-validation" id="data-validation">Data validation</a></h2>
<p>Some commands may return a value whose type cannot be predicted before runtime. For instance, a command fetching a JSON object from a remote server will, in case of success, return a value but whose type cannot be known beforehand.</p>
<p><em>Data validation</em> is a feature allowing to scripts to check the type of an unknown value at runtime, using <em>type assertions</em>.</p>
<p>Here is an example:</p>
<pre><code class="language-hydre">var test: any = [ 2, 3, 4 ]

# 1. Here, &quot;test&quot; is considered to be of type &quot;any&quot;

if test is list[int]
  # 2. Here, &quot;test&quot; is considered to be of type &quot;list[int]&quot;
else
  # 3. Here, &quot;test&quot; is considered to be of type &quot;any&quot;
end
</code></pre>
<p>The <code>isnt</code> keyword can also be used:</p>
<pre><code class="language-hydre">var test: any = [ 2, 3, 4 ]

# 1. Here, &quot;test&quot; is considered to be of type &quot;any&quot;

if test isnt list[int]
  # 2. Here, &quot;test&quot; is considered to be of type &quot;any&quot;
else
  # 3. Here, &quot;test&quot; is considered to be of type &quot;list[int]&quot;
end
</code></pre>
<p>If, in an &quot;isnt&quot; conditional, the script exits/fails in all cases (or returns if we're in a function), the value is considered with the asserted type for the rest of the script:</p>
<pre><code class="language-hydre">var test: any = [ 2, 3, 4 ]

# 1. Here, &quot;test&quot; is considered to be of type &quot;any&quot;

if test isnt list[int]
  # 2. Here, &quot;test&quot; is considered to be of type &quot;any&quot;
  exit
end

# 3. Here, &quot;test&quot; is considered to be of type &quot;list[int]&quot;
# &gt; Because it's impossible for &quot;test&quot; to not be &quot;list[int]&quot; as in that case the program would have exited
</code></pre>
<p>This can be used to check complex structures as well:</p>
<pre><code class="language-hydre"># Considering we have a `fn fetchJson(url: string) -&gt; any' function that fetches a JSON value from the web

type User = struct { id: int, firstName: string, lastName: string, email: string }

var json = fetchJson(&quot;https://mysuperapi.../users/all&quot;)

if json isnt User
  fail &quot;JSON doesn't have the correct structure&quot;
end

# &quot;json&quot; is considered as a &quot;User&quot; here
</code></pre>
<h2><a class="header" href="#event-listeners" id="event-listeners">Event listeners</a></h2>
<p>Scripts can listen to events using the <code>on</code> keyword:</p>
<pre><code class="language-hydre">on keypress as keycode
  echo &quot;A key was pressed: ${keycode}&quot;
end
</code></pre>
<p>This program will display a message each time a key is pressed.</p>
<p>If the event listener is registered in a function, the is automatically unregistered when that function returns. If it's registered outside a function, it is unregistered when the script ends.</p>
<pre><code class="language-hydre">fn test()
  on keypress as keycode # (1)
    # Do something
  end
  # Event listener (1) is unregistered here
end

on keypress as keycode # (2)
  # Do something
end

echo &quot;Hello world!&quot;
# Event listener (2) is unregistered here
</code></pre>
<h3><a class="header" href="#waiting" id="waiting">Waiting</a></h3>
<p>Scripts may wait for a specific event before continuing. This can be achieved without a <code>while</code> loop that consumes a lot of CPU, using the <code>wait</code> keyword:</p>
<pre><code class="language-hydre">wait condition
</code></pre>
<p>The script will block while the provided <code>condition</code> is not <code>true</code>. The checking interval is defined by the system, and the condition should as fast to check as possible to consume as little CPU as possible.</p>
<pre><code class="language-hydre">echo &quot;Please press the &lt;F&gt; key to validate your choice&quot;

var validated = false

on keypress as keycode
  if keycode == KEY_F
    validated = true
  end
end

wait validated

echo &quot;Thanks for validating your choice :D&quot;
</code></pre>
<p>It's also possible to wait for a variable to not be <code>null</code>:</p>
<pre><code class="language-hydre">echo &quot;Please press a key&quot;

var key: int? = null

on keypress as keycode
  key = keycode
end

wait some key

echo &quot;You pressed key: ${key}&quot;
</code></pre>
<h2><a class="header" href="#imports" id="imports">Imports</a></h2>
<p>As you may already know, command names can be <a href="specs/../concepts/applications.html#commands">quite long and complicated</a>. In order to prevent from having to repeat very long names that are not really readable, it's recommanded to use <em>imports</em> which are declared at the beginning of script with the form <code>&lt;dev&gt;::&lt;app&gt;::&lt;command&gt;</code>:</p>
<pre><code class="language-hydre">import system::fs::read_file

read_file # ...
</code></pre>
<p>It's then possible to use the <code>read_file</code> without prefixing.</p>
<p>To perform multiple imports at once:</p>
<pre><code class="language-hydre">import system::fs::{read_file, write_file}
</code></pre>
<p>It's also possible to only bind the application itself:</p>
<pre><code class="language-hydre">import system::fs

fs::read_file # ...
</code></pre>
<h3><a class="header" href="#aliases" id="aliases">Aliases</a></h3>
<p>Imported commands can also be aliased:</p>
<pre><code class="language-hydre">import system::fs as sysfs

sysfs::read_file # ...
</code></pre>
<h3><a class="header" href="#import-expansions" id="import-expansions">Import expansions</a></h3>
<p>It's possible to import all commands from an application, with:</p>
<pre><code class="language-hydre">import system::fs::*

read_file # ...
</code></pre>
<p>But also to import all applications from a developer, with:</p>
<pre><code class="language-hydre">import system::*

fs::read_file # ...
</code></pre>
<p>Note that, if a name clash occurs - if two applications or commands with the same name are imported -, the script won't be able to run.</p>
<h3><a class="header" href="#non-clashing-namespace" id="non-clashing-namespace">Non-clashing namespace</a></h3>
<p>The <em>non-clashing namespace</em> is a namespace that can be imported, where live all commands whose name is unique across all applications.</p>
<p>For instance, let's imagine we have two applications:</p>
<ul>
<li><code>AppA</code> by <code>DevA</code>, which exposes a <code>cmd_a</code> and a <code>cmd_z</code> command ;</li>
<li><code>AppB</code> by <code>DevB</code>, which exposes a <code>cmd_b</code> and a <code>cmd_z</code> command</li>
</ul>
<p>What happens here? While the <code>cmd_z</code> command has a name clash between <code>AppA</code> and <code>AppB</code>, the <code>cmd_a</code> and <code>cmd_b</code> commands don't. This results in these last two commands being also put in the <code>nonclashing</code> namespace, which can then be imported like a traditional application:</p>
<pre><code class="language-hydre">import shell::nonclashing

nonclashing::cmd_a # OK
nonclashing::cmd_b # OK
nonclashing::cmd_z # ERROR (not in namespace)
</code></pre>
<p>This means we can also import all commands that don't clash with other ones:</p>
<pre><code class="language-hydre">import shell::nonclashing::*

cmd_a # OK
cmd_b # ...
cmd_z # ERROR (not in namespace)
</code></pre>
<h3><a class="header" href="#volatile-imports" id="volatile-imports">Volatile imports</a></h3>
<p>As <a href="specs/../concepts/applications.html#volatile-applications">volatile applications</a>' commands <a href="specs/applications/commands.html#volatile-applications">are not exposed globally</a>, there is a special import syntax for such applications, allowing to import their commands directly from their <a href="specs/applications/package.html">application package</a>:</p>
<pre><code class="language-hydre">import ./app.nva::super_command
super_command # ...

# OR
import ./app.nva as app
app::super_command # ...
</code></pre>
<h2><a class="header" href="#commands-input--output" id="commands-input--output">Commands input &amp; output</a></h2>
<h3><a class="header" href="#reading-a-commands-output" id="reading-a-commands-output">Reading a command's output</a></h3>
<p>Commands output data through <em>pipes</em>. There are several output pipes that can be used:</p>
<ul>
<li>CMDOUT is the default output pipe, which returns typed values (the command declares its output type beforehand)</li>
<li>CMDRAW allows to send a <code>stream</code>, which is useful when dealing with a lot of data or with external data</li>
<li>CMDMSG allows to send <code>string</code> messages that are displayed in the terminal's windows</li>
<li>CMDERR allows to send <code>string</code> messages that are also displayed, but as error messages</li>
</ul>
<p>There is a specific syntax to get the output from each pipe. To get the (typed) output from CMDOUT:</p>
<pre><code class="language-hydre">_ = $(echo &quot;Hello!&quot;) # Contains: &quot;Hello!&quot;
</code></pre>
<p>This is called the <em>typed reception operator</em>. It can be used like this for instance:</p>
<pre><code class="language-hydre">echo ${$(echo &quot;Hello!&quot;)} # Prints: &quot;Hello!&quot;
</code></pre>
<p>But, as this syntax is not very readable, evaluating a single command can be made without the <code>${...}</code> expression wrapper:</p>
<pre><code class="language-hydre">echo $(echo &quot;Hello!&quot;) # Prints: &quot;Hello!&quot;
</code></pre>
<p>Note that this only work if the command supports piping through CMDOUT.</p>
<p>To get the result from CMDRAW instead (as a <code>stream</code>), if the command supports it:</p>
<pre><code class="language-hydre"># '-b' makes 'echo' read from a stream
echo -b $@(streamify &quot;Hello!&quot;) # Prints: &quot;Hello!&quot;
</code></pre>
<p>To get the output of CMDMSG instead (as a <code>list[string]</code>):</p>
<pre><code class="language-hydre">echo $?(echo &quot;Hello!&quot;) # Prints: &quot;[&quot;Hello!&quot;]&quot;
</code></pre>
<p>To get the output of CMDERR (as a <code>list[string]</code>):</p>
<pre><code class="language-hydre">echo $!(echo &quot;Hello!&quot;) # Prints &quot;[]&quot;
</code></pre>
<p>To get the combined output of CMDMSG and CMDERR (as a <code>list[string]</code>):</p>
<pre><code class="language-hydre">echo $*(echo &quot;Hello!&quot;) # Prints &quot;[&quot;Hello!&quot;]&quot;
</code></pre>
<p>Note that using the <code>$(...)</code> operator will make the program panic if the command exits with a non-zero status code.</p>
<h3><a class="header" href="#redirecting-the-output-to-a-file" id="redirecting-the-output-to-a-file">Redirecting the output to a file</a></h3>
<p>It's also possible to redirect the output of a command to a file, using the <code>&gt;</code> operator. The values are converted to strings before being written, except <code>stream</code> values which are written as they are.</p>
<pre><code class="language-hydre">echo &quot;Hello!&quot; &gt; ./test.txt
</code></pre>
<p>This works because <code>echo</code> outputs by default to CMDOUT, not to CMDMSG. If it did, we could still perform the redirection this way:</p>
<pre><code class="language-hydre">echo &quot;Hello!&quot; ?&gt; ./test.txt
</code></pre>
<p>The prefixes are the same as for the <code>$(...)</code> operator:</p>
<ul>
<li><code>&gt;</code> for CMDOUT</li>
<li><code>@&gt;</code> for CMDRAW</li>
<li><code>?&gt;</code> for CMDMSG</li>
<li><code>!&gt;</code> for CMDERR</li>
<li><code>*&gt;</code> for CMDMSG and CMDERR combined</li>
</ul>
<h3><a class="header" href="#output-data" id="output-data">Output data</a></h3>
<p>If a script is <a href="specs/shell-scripting.html#commands-typing">declared as a command</a>, it gets its own CMDIN, CMDOUT and CMDRAW pipes (the CMDUSR, CMDMSG and CMDERR pipes remain as usual).</p>
<p>They can be accessed using three built-in commands: <code>cmdin</code>, <code>cmdout</code> and <code>cmdraw</code>.</p>
<h4><a class="header" href="#reading-from-cmdin" id="reading-from-cmdin">Reading from CMDIN</a></h4>
<p>The <code>cmdin</code> command simply writes in its CMDOUT the value provided in the shell's CMDIN. For instance:</p>
<pre><code class="language-hydre"># Considering this shell script accepts `string` values as input.

# If this shell script is called with 'Hello world!' as an input:
echo $(cmdin | length) # Prints: 12
</code></pre>
<p>The original type is preserved, which means we can perform typed operations on the input value.</p>
<h4><a class="header" href="#returning-with-cmdout" id="returning-with-cmdout">Returning with CMDOUT</a></h4>
<p>The <code>cmdout</code> command takes a typed value and writes it to the shell script's CMDOUT pipe. This also makes the program exit.</p>
<h4><a class="header" href="#writing-to-cmdraw" id="writing-to-cmdraw">Writing to CMDRAW</a></h4>
<p>The <code>cmdraw</code> command takes a <code>stream</code> value and writes it to the shell script's CMDRAW pipe. Only one stream can be piped at a time, so if <code>cmdraw</code> is called while another is pending, the command will simply fail (this can be caught with <code>catch</code>).</p>
<h3><a class="header" href="#input-of-a-command" id="input-of-a-command">Input of a command</a></h3>
<p>Some commands accept <em>inputs</em> through the command pipe <code>|</code> operator. They can be used this way:</p>
<pre><code class="language-hydre">echo &quot;Hello world!&quot; &gt; ./somefile.txt

read ./somefile.txt # Prints: &quot;Hello world!&quot;

read ./somefile.txt | length # Prints: 12
</code></pre>
<p>How does this work exactly? First, <code>read</code> reads the file and outputs it to CMDOUT as a <code>string</code>, which is then passed to <code>length</code> which happens to accept strings as an input. It then computes the length of the provided input and writes it to CMDOUT, as an <code>int</code>. Which means we can do that:</p>
<pre><code class="language-hydre">echo ${ $(read ./somefile.txt | length) * 2 } # Prints: 24
</code></pre>
<p>The input may be typed and only accept specific types of values. For instance <code>length</code> only accepts strings, so if we try to give it something else:</p>
<pre><code class="language-hydre">echo $(pass 2 | length) # ERROR
</code></pre>
<p>What happens here is that we use the builtin <code>pass</code> command which writes to CMDOUT the exact same value we gave it as an input. Then we give it to <code>length</code>, which fails because it doesn't accept <code>int</code>s.</p>
<p>There's also a shorthand syntax for providing a file's content as CMDIN to a command:</p>
<pre><code class="language-hydre">echo $(length &lt; ./somefile.txt) # Prints: 24
</code></pre>
<p>For commands that only accept <code>string</code> inputs, the file is automatically decoded and converted to a string. Else, it's kept as a <code>stream</code>.</p>
<h2><a class="header" href="#running-in-background" id="running-in-background">Running in background</a></h2>
<p>It's possible to run multiple commands in parallel by using <em>background commands</em>. A background command runs, as the name suggests, in the background, and so its output isn't visible. If it fails, it won't generate any error nor affect the <code>status()</code> code.</p>
<p>To run a command in backgroud, we use the <code>bg</code> keyword:</p>
<pre><code class="language-hydre">bg hello = sleep 5 -x { i -&gt; echo &quot;Counter: ${i}&quot; }
</code></pre>
<p>This will declare an <code>hello</code> variable and put an <code>int</code> value inside it, which is the background command's <em>identifier</em> (BGID). The command will be started and run in parallel of the current program. For instance, the following program:</p>
<pre><code class="language-hydre">bg hello = sleep 5 -x { i -&gt; echo &quot;Counter: ${i}&quot; } --end { -&gt; echo &quot;Counter completed!&quot; }

for i in 1..=5
  sleep 1
  echo &quot;Loop: ${i}&quot;
end

echo &quot;Loop completed!&quot;
</code></pre>
<p>Will print:</p>
<pre><code class="language-plaintext">Counter: 1
Loop: 1
Counter: 2
Loop: 2
Counter: 3
Loop: 3
Counter: 4
Loop: 4
Counter: 5
Loop: 5
Counter completed!
Loop completed!
</code></pre>
<p>It's possible to wait for a background command by making it run back in the foreground:</p>
<pre><code class="language-hydre">bg hello = sleep 5 # The command runs in background
fg hello # The commands comes back to the foreground
         # The program pauses until it completes like for a normal command
</code></pre>
<p>It's also possible to let the command run even when the program finishes with <code>detach</code>:</p>
<pre><code class="language-hydre">bg hello = sleep 5
detach hello
</code></pre>
<p>Or to stop the background command with <code>kill</code>:</p>
<pre><code class="language-hydre">bg hello = sleep 5 -x { i -&gt; echo &quot;Counter: ${i}&quot; }

sleep 3
kill hello
echo &quot;Killed.&quot;

### Output:
Counter: 1
Counter: 2
Counter: 3
Killed.
&lt;Program stops&gt;###
</code></pre>
<h2><a class="header" href="#environment-variables" id="environment-variables">Environment variables</a></h2>
<p>While traditional variables are always <a href="specs/shell-scripting.html#variables-scoping">scoped</a>, <em>environment variables</em> are variables that are provided to the script when it starts, and are forwarded to all scripts the main scripts calls, recursively.</p>
<p>They are mostly used to share configuration between programs.</p>
<p>They are usually set:</p>
<ul>
<li>Globally, using <a href="specs/../applications/Central.html">Central</a></li>
<li>For the terminal, using the terminal application's settings</li>
<li>For the current script, by providing them when running the script</li>
</ul>
<p>The third case is the most common, here is what it looks like:</p>
<pre><code class="language-hydre"># Without environment variables
./myscript.ns

# With environment variables
with MESSAGE=&quot;Hello world!&quot; run ./myscript.ns
</code></pre>
<p>The environment variable will then be provided to <code>./myscript.ns</code>, and will also be available in all scripts this script calls.</p>
<h3><a class="header" href="#reading-an-environment-variable" id="reading-an-environment-variable">Reading an environment variable</a></h3>
<p>Environment variables cannot be accessed like traditional variables, they must be retrieved through the <code>env</code> builtin function:</p>
<pre><code class="language-hydre"># In &quot;myscript.ns&quot;

var message = env(&quot;MESSAGE&quot;) # any?
</code></pre>
<p>As the variable may not be defined, the function returns a nullable value, so we must check if the variable is indeed defined:</p>
<pre><code class="language-hydre">var message = env(&quot;MESSAGE&quot;)

if none message
  fail &quot;MESSAGE environment variable was not provided&quot;
end
</code></pre>
<p>Now we are sure that <code>message</code> is defined, we get an <code>any</code> value, because we don't know the type of the environment variable. So we must use <a href="specs/shell-scripting.html#data-validation">type assertions</a> for that:</p>
<pre><code class="language-hydre">var message = env(&quot;MESSAGE&quot;)

if none message
  fail &quot;MESSAGE environment variable was not provided&quot;
end

if message isnt string
  fail &quot;MESSAGE environment variable is not a string&quot;
end

# Here, &quot;message&quot; is a string
</code></pre>
<p>Perfect! Note that, if you want to check if the environment variable exists <em>and</em> is of a specific type at the same time, you can skip the first checking, which is only here to perform specific actions in case the environment variable isn't even defined:</p>
<pre><code class="language-hydre">var message = env(&quot;MESSAGE&quot;)

if message isnt string
  fail &quot;MESSAGE environment variable was not provided or is not a string&quot;
end

# Here, &quot;message&quot; is a string
</code></pre>
<h2><a class="header" href="#commands-typing" id="commands-typing">Commands typing</a></h2>
<p>For script files to be called as commands, they must define a <code>main</code> function and declare a <em>command description</em>.</p>
<p>Here is an example of command description:</p>
<pre><code class="language-hydre">cmd
  author &quot;Me &lt;my@email&gt;&quot; # Optional
  license &quot;MIT&quot; # Optional
  help &quot;A program that repeats the name of a list of person&quot;
  return void
  args
    # Declare a positional argument named 'names' with a help text
    pos &quot;names&quot;
      type list[string]
      help &quot;List of names to display&quot;
      optional

      # If this argument is omitted, the command will expect the list of names to be provided through CMDIN
      if absent
        cmdin list[string]
      end

    # Declare a dash argument named 'repeat'
    dash &quot;repeat&quot;
      type int
      short &quot;r&quot;
      long &quot;repeat&quot;
      optional

    # Get the time this command took to complete
    flag &quot;duration&quot;
      short &quot;d&quot;
      long &quot;duration&quot;

      # Conditional return type
      # 'present()' also accepts an optional argument name to check if another argument is present
      if present
        return int
      end
end
</code></pre>
<h3><a class="header" href="#arguments-type" id="arguments-type">Arguments type</a></h3>
<p>Arguments type can be any existing type, or:</p>
<ul>
<li><code>anystr</code>: accepts any type of argument except <code>stream</code>, which will be converted to a <code>string</code> when the command is called (which means the argument will be a <code>string</code> from the command's point of view)</li>
</ul>
<h3><a class="header" href="#enumerations" id="enumerations">Enumerations</a></h3>
<p>The <code>enum</code> type for arguments indicate the argument only accepts a subset of values (whose type is inferred), which must be specified as a constant. This means the caller cannot use a variable as this argument's value, because the return type may depend on it.</p>
<p>It may also be used as a list of custom values by wrapping the enumeration into a <code>list[...]</code>.</p>
<h3><a class="header" href="#return-type" id="return-type">Return type</a></h3>
<p>The command's return type can be any existing type.</p>
<p>The options for each argument are:</p>
<ul>
<li><code>type</code>: Required, the type of the argument (nullable types are forbidden)</li>
<li><code>help</code>: A help message indicating what the argument does</li>
<li><code>short</code>: Short name for a dash argument</li>
<li><code>long</code>: Long name for a dash argument</li>
<li><code>optional</code>: Indicate the optional can be omitted (the type will be converted to a nullable one)</li>
<li><code>default</code>: Make the value optional, but with a default value (so the type will not be nullable)</li>
<li><code>requires</code>: Indicate one or several other arguments are required to use this dash one</li>
<li><code>conflicts</code>: Indicate this dash argument cannot be used when one or several other specific arguments are already in use</li>
<li><code>enum</code>: Allow only a subset of values</li>
</ul>
<p>For dash arguments, at least <code>short</code> or <code>long</code> must be provided. Also, <code>optional</code> and <code>default</code> cannot be provided at the same time.
For flag arguments, at least <code>short</code> or <code>long</code> must be provided. Also, <code>type</code>, <code>optional</code>, <code>default</code> and <code>enum</code> are not accepted.</p>
<h3><a class="header" href="#conditionals-1" id="conditionals-1">Conditionals</a></h3>
<p>Conditions can also use the <code>elif</code> and <code>else</code> keywords, and use the <code>present()</code> and <code>absent()</code> operators as well as usual relational operators like <code>==</code> or <code>&lt;</code> for constant values like enums.</p>
<h3><a class="header" href="#example" id="example">Example</a></h3>
<p>Here is an example that uses all these options:</p>
<pre><code class="language-hydre">cmd
  args
    # ...
    dash &quot;repeat&quot;
      type int
      help &quot;How many times to repeat the names&quot;
      short &quot;r&quot;
      long &quot;repeat&quot;
      default 1
      requires &quot;arg1&quot;
      conflicts &quot;arg2&quot; &quot;arg3&quot;
      enum list[1, 2, 3, 4]
    end
  end
  # ...
end
</code></pre>
<p>The <code>main</code> function takes arguments with the same name as described in the <code>cmd</code> block, and in the same order:</p>
<pre><code class="language-hydre">fn main(names: list[string], repeat: int?)
  for i in 0..=repeat.default(1)
    echo ${names.join(&quot;, &quot;)}
  end
end
</code></pre>
<p>The script can then be called like any command, with the default <code>$(...)</code> operator returning the script's return value:</p>
<pre><code class="language-hydre">./myscript.ns [&quot;Jack&quot;, &quot;John&quot;] -r 1
# or
var result = $(./myscript.ns [&quot;Jack&quot;, &quot;John&quot;] -r 1)
</code></pre>
<p>Also, know that scripts can <code>fail</code> too. This allows errors to be handled when the script is run as a function:</p>
<pre><code class="language-hydre"># main(names: list[string], repeat: int?) -&gt; fallible

catch $(myscript [&quot;Jack&quot;, &quot;John&quot;])
  ok  _ =&gt; echo &quot;Everything went fine :)&quot;
  err _ =&gt; echo &quot;Something went wrong :(&quot;
end
</code></pre>
<h2><a class="header" href="#native-library" id="native-library">Native library</a></h2>
<p>The native library is a list of functions that are provided by the shell.</p>
<p>All types have <em>extensions</em>, which are functions that can be called using the <code>.</code> symbol, like <code>my_list.extension()</code>.</p>
<h3><a class="header" href="#utilities" id="utilities">Utilities</a></h3>
<h4><a class="header" href="#envvarname-string---any" id="envvarname-string---any"><code>env(varname: string) -&gt; any?</code></a></h4>
<p>Get an <a href="specs/shell-scripting.html#environment-variables">environment variable</a>.<br />
Returns <code>null</code> if the environment variable cannot be found.</p>
<h4><a class="header" href="#promptmessage-string---string" id="promptmessage-string---string"><code>prompt(message: string) -&gt; string</code></a></h4>
<p>Ask the user a string.</p>
<h4><a class="header" href="#prompt_intmessage-string---fallible-int" id="prompt_intmessage-string---fallible-int"><code>prompt_int(message: string) -&gt; fallible int</code></a></h4>
<p>Ask the user an integer number.
Fails if the provided input is not a number.
Fails if the shell is not interactive.</p>
<h4><a class="header" href="#prompt_floatmessage-string---fallible-float" id="prompt_floatmessage-string---fallible-float"><code>prompt_float(message: string) -&gt; fallible float</code></a></h4>
<p>Ask the user a floating-point number.
Fails if the provided input is not a floating-point number.
Fails if the shell is not interactive.</p>
<h4><a class="header" href="#confirmmessage-string---fallible-bool" id="confirmmessage-string---fallible-bool"><code>confirm(message: string) -&gt; fallible bool</code></a></h4>
<p>Ask the user to confirm a message using an <code>[Y/n]</code> prompt.
Fails if the shell is not interactive.</p>
<h4><a class="header" href="#chooseoptions-liststring---fallible-int" id="chooseoptions-liststring---fallible-int"><code>choose(options: list[string]) -&gt; fallible int</code></a></h4>
<p>Ask the user to pick a value from a list and get the index of the chosen value.
Fails if the shell is not interactive.</p>
<h4><a class="header" href="#retry_cmdcmd-command-retries-int---fallible" id="retry_cmdcmd-command-retries-int---fallible"><code>retry_cmd(cmd: command, retries: int) -&gt; fallible</code></a></h4>
<p>Run a command and retry it a given number of times if it fails.
Fails if the command still fails after all allowed tries.</p>
<h4><a class="header" href="#exit" id="exit"><code>exit()</code></a></h4>
<p>Make the program exit.</p>
<h4><a class="header" href="#last_failed---bool" id="last_failed---bool"><code>last_failed() -&gt; bool</code></a></h4>
<p>Check if the previous command failed.<br />
Returns <code>0</code> if no command was ran since the beginning of the script.</p>
<h4><a class="header" href="#rand---float" id="rand---float"><code>rand() -&gt; float</code></a></h4>
<p>Generate a random floating-point number between 0 and 1.</p>
<h4><a class="header" href="#rand_intlow-int-up-int---fallible-int" id="rand_intlow-int-up-int---fallible-int"><code>rand_int(low: int, up: int) -&gt; fallible int</code></a></h4>
<p>Generate a random integer between <code>low</code> and <code>up</code>.
Fails if <code>low</code> is not strictly less than <code>up</code>.</p>
<h4><a class="header" href="#rand_floatlow-float-up-float---fallible-float" id="rand_floatlow-float-up-float---fallible-float"><code>rand_float(low: float, up: float) -&gt; fallible float</code></a></h4>
<p>Generate a floating-point number between <code>low</code> and <code>up</code>.
Fails if <code>low</code> is not strictly less than <code>up</code>.</p>
<h3><a class="header" href="#all-types" id="all-types">All types</a></h3>
<h4><a class="header" href="#anystr---string" id="anystr---string"><code>any.str() -&gt; string</code></a></h4>
<p>Turns the provided value into a string, depending on the value's type:</p>
<pre><code class="language-hydre">_ = (true).str()    # true
_ = (3).str(3)      # 3
_ = (3.14).str()    # 3.14
_ = ('B').str()     # B
_ = (&quot;Yoh&quot;).str()   # Yoh
_ = @{ command --arg1 -c 2 -d=4 }.str() # command --arg1 -c 2 -d 4

_ = [&quot;a&quot;,&quot;b&quot;].str() # [ &quot;a&quot;, &quot;b&quot; ]
_ = @{ streamify &quot;Hello world!&quot; }.str() # &quot;&lt;stream&gt;&quot;
</code></pre>
<h3><a class="header" href="#nullable-types-1" id="nullable-types-1">Nullable types</a></h3>
<h4><a class="header" href="#tisnull---t" id="tisnull---t"><code>T?.isNull() -&gt; T</code></a></h4>
<p>Check if the value is <code>null</code>.</p>
<pre><code class="language-hydre">var a: int? = 1
var b: int? = null

echo ${a.isNull()} # false
echo ${b.isNull()} # true
</code></pre>
<h4><a class="header" href="#tdefaultfallback-t---t" id="tdefaultfallback-t---t"><code>T?.default(fallback: T) -&gt; T</code></a></h4>
<p>Use a fallback value in case of <code>null</code>:</p>
<pre><code class="language-hydre">var a: int? = 1
var b: int? = null

echo ${a.default(3)} # 1
echo ${b.default(3)}
</code></pre>
<h4><a class="header" href="#tunwrap---t" id="tunwrap---t"><code>T?.unwrap() -&gt; T</code></a></h4>
<p>Make the program exit with an error message if the value is null.</p>
<pre><code class="language-hydre">var a = ?(0) # int?
var b = a.unwrap() # int
</code></pre>
<h4><a class="header" href="#texpectmessage-string---t" id="texpectmessage-string---t"><code>T?.expect(message: string) -&gt; T</code></a></h4>
<p>Make the program exit with a custom error message if 'a' is null</p>
<pre><code class="language-hydre">var a = ?(0) # INt?
var b = a.expect(&quot;'a' should not be null :(&quot;) # int
</code></pre>
<h3><a class="header" href="#characters" id="characters">Characters</a></h3>
<h4><a class="header" href="#charsingle---bool" id="charsingle---bool"><code>char.single() -&gt; bool</code></a></h4>
<p>Indicate if a character is made of a single codepoint.</p>
<h4><a class="header" href="#charcodepoints---listint" id="charcodepoints---listint"><code>char.codepoints() -&gt; list[int]</code></a></h4>
<p>Get the codepoints composing a character.</p>
<h4><a class="header" href="#charlen---int" id="charlen---int"><code>char.len() -&gt; int</code></a></h4>
<p>Get the number of codepoints composing a character.</p>
<h4><a class="header" href="#charbytes---int" id="charbytes---int"><code>char.bytes() -&gt; int</code></a></h4>
<p>Get the size of a character, in bytes.</p>
<h3><a class="header" href="#strings" id="strings">Strings</a></h3>
<h4><a class="header" href="#stringchars---listchar" id="stringchars---listchar"><code>string.chars() -&gt; list[char]</code></a></h4>
<p>Get the characters composing a string.</p>
<h4><a class="header" href="#stringcodepoints---listint" id="stringcodepoints---listint"><code>string.codepoints() -&gt; list[int]</code></a></h4>
<p>Get the codepoints composing a string.</p>
<h4><a class="header" href="#stringlen---int" id="stringlen---int"><code>string.len() -&gt; int</code></a></h4>
<p>Get the number of codepoints composing a string.</p>
<h4><a class="header" href="#stringbytes---int" id="stringbytes---int"><code>string.bytes() -&gt; int</code></a></h4>
<p>Get the size of a string, in bytes.</p>
<h4><a class="header" href="#stringparse_intbase--10---fallible-int" id="stringparse_intbase--10---fallible-int"><code>string.parse_int(base = 10) -&gt; fallible int</code></a></h4>
<p>Tries to parse the provided string as a number in the provided base.
Leading zeroes are accepted.
<code>0</code> symbol followed by <code>b</code>, <code>o</code>, <code>d</code> or <code>x</code> is accepted for bases 2, 8, 10 and 16 respectively.
Fails if the string does not represent a number in this base.</p>
<pre><code class="language-hydre">_ = (&quot;2&quot;).parse_int()   # 2
_ = (&quot;A&quot;).parse_int()   # &lt;FAIL&gt;
_ = (&quot;A&quot;).parse_int(16) # 11
</code></pre>
<h4><a class="header" href="#stringparse_floatbase--10---fallible-float" id="stringparse_floatbase--10---fallible-float"><code>string.parse_float(base = 10) -&gt; fallible float</code></a></h4>
<p>Identical to <code>string.parse_int(base)</code> but with floats.</p>
<h4><a class="header" href="#stringupper_case---string" id="stringupper_case---string"><code>string.upper_case() -&gt; string</code></a></h4>
<p>Convert a string to uppercase.</p>
<pre><code class="language-hydre">_ = (&quot;aBc&quot;).upper_case() # &quot;ABC&quot;
</code></pre>
<h4><a class="header" href="#stringlower_case---string" id="stringlower_case---string"><code>string.lower_case() -&gt; string</code></a></h4>
<p>Convert a string to lowercase.</p>
<pre><code class="language-hydre">_ = (&quot;aBc&quot;).lower_case() # &quot;abc&quot;
</code></pre>
<h4><a class="header" href="#stringreverse---string" id="stringreverse---string"><code>string.reverse() -&gt; string</code></a></h4>
<p>Reverse a string.</p>
<pre><code class="language-hydre">_ = (&quot;abc&quot;).reverse() # &quot;cba&quot;
</code></pre>
<h4><a class="header" href="#stringconcatright-string---string" id="stringconcatright-string---string"><code>string.concat(right: string) -&gt; string</code></a></h4>
<p>Concatenate two strings (equivalent to <code>&quot;${left}${right}&quot;</code>).</p>
<pre><code class="language-hydre">_ = (&quot;a&quot;).concat(&quot;b&quot;) # &quot;ab&quot;
</code></pre>
<h4><a class="header" href="#stringsplitstr-string-sep-string---string" id="stringsplitstr-string-sep-string---string"><code>string.split(str: string, sep: string) -&gt; string</code></a></h4>
<p>Split a string into a list.</p>
<pre><code class="language-hydre">split(&quot;ab&quot;, &quot;&quot;)  # [ &quot;a&quot;, &quot;b&quot; ]
split(&quot;a b&quot;, &quot; &quot;) # [ &quot;a&quot;, &quot;b&quot; ]
</code></pre>
<h3><a class="header" href="#lists" id="lists">Lists</a></h3>
<h4><a class="header" href="#listcharstringify---str" id="listcharstringify---str"><code>list[char].stringify() -&gt; str</code></a></h4>
<p>Turns a list of characters to a string.</p>
<pre><code class="language-hydre">_ = ([ 'a', 'b', 'c' ].str() == &quot;abc&quot;) # true
</code></pre>
<h4><a class="header" href="#listtgetindex-int---t" id="listtgetindex-int---t"><code>list[T].get(index: int) -&gt; T?</code></a></h4>
<p>Try to get an item from the list, without panicking if the index is out-of-bounds.</p>
<pre><code class="language-hydre">var names = [ &quot;Jack&quot;, &quot;John&quot; ]

names.get(0) # &quot;Jack&quot;
names.get(1) # &quot;John&quot;
names.get(2) # null
</code></pre>
<h4><a class="header" href="#listtexpectindex-number-message-string---t" id="listtexpectindex-number-message-string---t"><code>list[T].expect(index: number, message: string) -&gt; T</code></a></h4>
<p>Get an item from the list, and panic with a custom error message if the index is out-of-bounds.</p>
<pre><code class="language-hydre">var names = [ &quot;Jack&quot;, &quot;John&quot; ]

names.get(2, &quot;Third item was not found&quot;)
</code></pre>
<h4><a class="header" href="#listtunshiftvalue-t" id="listtunshiftvalue-t"><code>list[T].unshift(value: T)</code></a></h4>
<p>Insert a new value at the beginning of the list.</p>
<h4><a class="header" href="#listtpushvalue-t" id="listtpushvalue-t"><code>list[T].push(value: T)</code></a></h4>
<p>Push a new value at the end of the list.</p>
<h4><a class="header" href="#listtunshift---t" id="listtunshift---t"><code>list[T].unshift() -&gt; T?</code></a></h4>
<p>Remove the first value from the list and return it.</p>
<h4><a class="header" href="#listtpop---t" id="listtpop---t"><code>list[T].pop() -&gt; T?</code></a></h4>
<p>Remove the last value from the list and return it.</p>
<h4><a class="header" href="#listtsortasc--true---listt" id="listtsortasc--true---listt"><code>list[T].sort(asc = true) -&gt; list[T]</code></a></h4>
<p>Sorts a list.</p>
<pre><code class="language-hydre">_ = [ 2, 8, 4 ].sort()      # [ 2, 4, 8 ]
_ = [ 2, 8, 4 ].sort(false) # [ 8, 4, 2 ]
</code></pre>
<h4><a class="header" href="#listtreverse---listt" id="listtreverse---listt"><code>list[T].reverse() -&gt; list[T]</code></a></h4>
<p>Reverse a list.</p>
<pre><code class="language-hydre">_ = [ 2, 8, 4 ].reverse() # [ 4, 8, 2 ]
</code></pre>
<h4><a class="header" href="#listtlen---int" id="listtlen---int"><code>list[T].len() -&gt; int</code></a></h4>
<p>Count the number of entries in a list.</p>
<pre><code class="language-hydre">_ = [ 2, 8, 4 ].len() # 3
</code></pre>
<h4><a class="header" href="#liststringjoinsep-----string" id="liststringjoinsep-----string"><code>list[string].join(sep = &quot;,&quot;) -&gt; string</code></a></h4>
<p>Join a list of strings with a separator.</p>
<pre><code class="language-hydre">join([ &quot;a&quot;, &quot;b&quot; ])       # &quot;a,b&quot;
join([ &quot;a&quot;, &quot;b&quot; ], &quot;; &quot;) # &quot;a; b&quot;
</code></pre>
<h4><a class="header" href="#listtconcatanother-listt---listt" id="listtconcatanother-listt---listt"><code>list[T].concat(another: list[T]) -&gt; list[T]</code></a></h4>
<p>Concatenate two lists.</p>
<pre><code class="language-hydre">_ = [ 1, 2 ].concat([ 3, 4 ]) # [ 1, 2, 3, 4 ]
</code></pre>
<h4><a class="header" href="#listtconcatlists-listlistt---listt" id="listtconcatlists-listlistt---listt"><code>list[T].concat(lists: list[list[T]]) -&gt; list[T]</code></a></h4>
<p>Concatenate multiple lists.</p>
<pre><code class="language-hydre">_ = [ 1, 2 ].concat([ [ 3, 4 ], [ 5, 6 ] ]) # [ 1, 2, 3, 4, 5, 6 ]
</code></pre>
<h3><a class="header" href="#commands-2" id="commands-2">Commands</a></h3>
<h4><a class="header" href="#commandrun---int" id="commandrun---int"><code>command.run() -&gt; int</code></a></h4>
<p>Run the command and gets its status code after exit.</p>
<h4><a class="header" href="#commandfallible" id="commandfallible"><code>command.fallible()</code></a></h4>
<p>Run the command and fail if the status code after exit is not 0.<br />
Equivalent to calling the command with simple parenthesis like <code>cmd()</code>.</p>
<h4><a class="header" href="#commandret_str---string" id="commandret_str---string"><code>command.ret_str() -&gt; string</code></a></h4>
<p>Run the command and get its stringified return value.</p>
<h4><a class="header" href="#commandcmdraw---stream" id="commandcmdraw---stream"><code>command.cmdraw() -&gt; stream</code></a></h4>
<p>Run the command and get its CMDRAW output.</p>
<h4><a class="header" href="#commandcmdmsg---liststring" id="commandcmdmsg---liststring"><code>command.cmdmsg() -&gt; list[string]</code></a></h4>
<p>Run the command and get its CMDMSG output.</p>
<h4><a class="header" href="#commandcmderr---liststring" id="commandcmderr---liststring"><code>command.cmderr() -&gt; list[string]</code></a></h4>
<p>Run the command and get its CMDERR output.</p>
<h4><a class="header" href="#commandoutput---liststring" id="commandoutput---liststring"><code>command.output() -&gt; list[string]</code></a></h4>
<p>Run the command and get its CMDOUT and CMDERR outputs combined.</p>
<h3><a class="header" href="#streams-1" id="streams-1">Streams</a></h3>
<h4><a class="header" href="#streampending---bool" id="streampending---bool"><code>stream.pending() -&gt; bool</code></a></h4>
<p>Check if the stream is still pending. If the pipe is complete (which means if its pipe is closed), <code>false</code> will be returned.</p>
<h4><a class="header" href="#streamsize_hint---int" id="streamsize_hint---int"><code>stream.size_hint() -&gt; int?</code></a></h4>
<p>Get the stream's size hint. If no size hint was provided for this stream, <code>null</code> will be returned.</p>
<h2><a class="header" href="#examples" id="examples">Examples</a></h2>
<h3><a class="header" href="#guess-the-number" id="guess-the-number">Guess The Number</a></h3>
<pre><code class="language-hydre">while true
  var won = false
  var secret = rand_int(0, 100)

  echo &quot;Secret number between 0 and 100 has been chosen.&quot;

  while !won
    var user_input = retry prompt_int(&quot;Please input your guess: &quot;)

    if user_input &lt; secret
      echo &quot;It's higher!&quot;
    elif user_input &gt; secret
      echo &quot;It's lower!&quot;
    else
      echo &quot;You guessed the number \\o/!&quot;
      won = true
    end
  end

  tries = retry(5) confirm(&quot;Do you want to play again?&quot;)

  if !(retry(5) confirm(&quot;Do you want to play again?&quot;))
    echo &quot;Goodbye!&quot;
    break
  end
end
</code></pre>
<h2><a class="header" href="#native-commands" id="native-commands">Native commands</a></h2>
<p>The native commands are commands that are available in every program without import.</p>
<h3><a class="header" href="#echo-display-a-value" id="echo-display-a-value"><code>echo</code>: display a value</a></h3>
<p>Display a value to CMDOUT.</p>
<pre><code class="language-hydre"># echo [-n] { &lt;anystr&gt; | -b &lt;stream&gt;}
#
# &quot;-b&quot;: print a stream as UTF-8
# &quot;-n&quot;: don't put a newline break at the end of the content

echo &quot;Hello world&quot;
echo -n &quot;Hello world!&quot;
echo -b $(streamify &quot;Hello world!&quot;)
</code></pre>
<h3><a class="header" href="#wt-write-a-file" id="wt-write-a-file"><code>wt</code>: write a file</a></h3>
<p>Write a content to a file.</p>
<pre><code class="language-hydre"># wt [-a] [-n] [-c] &lt;path&gt; &lt;anystr&gt;
#
# &quot;-a&quot;: append to the end of the file
# &quot;-n&quot;: don't append a newline symbol at the end of the content
# &quot;-c&quot;: fail if the file doesn't exist instead of creating it
</code></pre>
<p>Note that sometimes it can be clearer to use a redirection pipe:</p>
<pre><code class="language-hydre"># Overwrite file
echo &quot;Hello world!&quot; &gt; ./test.txt

# Append to file
echo &quot;Hello world!&quot; &gt;&gt; ./test.txt
</code></pre>
<h3><a class="header" href="#rd-read-a-file" id="rd-read-a-file"><code>rd</code>: read a file</a></h3>
<p>Read a file as a <code>string</code> value.</p>
<pre><code class="language-hydre"># rd [-s] [--stream-size &lt;int&gt;] &lt;path&gt;
#
# &quot;-s&quot;: read a stream instead of reading the full content
# &quot;--stream-size&quot;: specify the size of the stream when &quot;-s&quot; is provided (rounded to higher pipe buffer multiplier)
</code></pre>
<h3><a class="header" href="#mkdir-create-a-directory" id="mkdir-create-a-directory"><code>mkdir</code>: create a directory</a></h3>
<p>Create a new directory.</p>
<pre><code class="language-hydre"># mkd [-s] &lt;path&gt;
#
# &quot;-s&quot;: fail if the directory already exists
</code></pre>
<h3><a class="header" href="#ren-rename-a-filesystem-item" id="ren-rename-a-filesystem-item"><code>ren</code>: rename a filesystem item</a></h3>
<p>Rename a filesystem item.</p>
<pre><code class="language-hydre"># re [-m] &lt;oldname: path&gt; &lt;newname: path&gt;
#
# &quot;-m&quot;: move if the 'newname' is located inside another directory
</code></pre>
<h3><a class="header" href="#mv-move-a-filesystem-item" id="mv-move-a-filesystem-item"><code>mv</code>: move a filesystem item</a></h3>
<pre><code class="language-hydre"># mv [-n] &lt;file: path&gt; &lt;dest_dir: path&gt;
#
# &quot;-n&quot;: create the target directory if it does not exist
</code></pre>
<h3><a class="header" href="#rm-remove-a-filesystem-item" id="rm-remove-a-filesystem-item"><code>rm</code>: remove a filesystem item</a></h3>
<p>Remove a filesystem item.</p>
<pre><code class="language-hydre"># rm [-r | --recursive] [-n | --non-empty] [-t | --trash] {&lt;path&gt; | -l &lt;list[path]&gt;}
#
# &quot;-r&quot;: allow removing empty directory
# &quot;-n&quot;: allow removing even non-empty directories
# &quot;-l&quot;: remove a list of paths
# &quot;-t&quot;: move the item to the user's trash
</code></pre>
<h3><a class="header" href="#ls-list-filesystem-items" id="ls-list-filesystem-items"><code>ls</code>: list filesystem items</a></h3>
<p>List filesystem items.</p>
<pre><code class="language-hydre"># ls [-t | --tree] [-r | --recursive] [-h | --hidden] [--file-only | --dir-only] [&lt;path&gt;]
#
# &quot;-t&quot;: display as a tree (implies &quot;-r&quot;)
# &quot;-r&quot;: list recursively
# &quot;-h&quot;: list hidden files
# &quot;--file-only&quot;: only display files
# &quot;--dir-only&quot;: only display directories
</code></pre>
<h3><a class="header" href="#fd-find-filesystem-items" id="fd-find-filesystem-items"><code>fd</code>: find filesystem items</a></h3>
<p>Find filesystem items matching provided criterias.</p>
<pre><code class="language-hydre"># fd [-t | --types list[&quot;dir&quot; | &quot;file&quot; | &quot;symlink&quot; | &quot;device&quot;]]
#    [-a | --absolute]
#    [-L | --follow]
#    [-e | --extension &lt;string&gt;]
#    [-n | --name &lt;string&gt;]
#    [-r | --regex &lt;string&gt;]
#    [-i | --ignore-case]
#    [-x | --exec &lt;command&gt;] &lt;path&gt;
#
# &quot;-t&quot;: only list items of a given type (by default, only files and symlinks are shown)
# &quot;-a&quot;: list absolute file paths instead of relative ones
# &quot;-L&quot;: follow symbolic links
# &quot;-e&quot;: only list files with the provided extension (directory will be excluded)
# &quot;-n&quot;: only list items whose name contain the provided string (`^` and `$` can be used for indicating items must start or end by it)
# &quot;-r&quot;: only list items matching a provided POSIX regex
# &quot;-i&quot;: ignore case (requires &quot;-n&quot; or &quot;-r&quot;)
# &quot;-x&quot;: execute a command for each found item
</code></pre>
<h3><a class="header" href="#syml-manage-symlinks" id="syml-manage-symlinks"><code>syml</code>: manage symlinks</a></h3>
<p>Manage symbolic links.</p>
<pre><code class="language-hydre"># sl {-r | --read} &lt;path&gt;: check a symlink's target
#
# sl [-u | --update] &lt;srcpath&gt; &lt;targetpath&gt;: create a symlink
#
# &quot;-u&quot;: update the symlink to the new target path if it already exists instead of failing
</code></pre>
<h1><a class="header" href="#services-2" id="services-2">Services</a></h1>
<p>This document describes the architecture of <a href="specs/../technical/services.html">services</a>, as well as the list of all system services and their main features.</p>
<ul>
<li><a href="specs/services.html#architecture-of-a-service">Architecture of a service</a>
<ul>
<li><a href="specs/services.html#connections">Connections</a></li>
<li><a href="specs/services.html#communication">Communication</a></li>
<li><a href="specs/services.html#thread-types">Thread types</a></li>
<li><a href="specs/services.html#closing-a-connection">Closing a connection</a></li>
</ul>
</li>
<li><a href="specs/services.html#system-services">System services</a></li>
</ul>
<h2><a class="header" href="#architecture-of-a-service" id="architecture-of-a-service">Architecture of a service</a></h2>
<p>Application services have exactly one running instance per active user, to prevent a user to connect to the service of a user with more privileges than itself. System services, on their side, only have one global instance.</p>
<p>An application process can tell if it was started as a service or not by looking at its <a href="specs/applications/context.html#execution-context">execution context</a>.</p>
<p>Once a service process indicates it's ready using the <a href="specs/kernel/syscalls.html#0x04-ready"><code>READY</code></a> syscall, other processes will be able to <em>connect</em> to this service.</p>
<h3><a class="header" href="#connections" id="connections">Connections</a></h3>
<p>A <em>connection</em> essentially consists of a <a href="specs/kernel/ipc.html#service-sockets">service socket</a> between a service and another process called its <em>client</em>.</p>
<p>When a process wants to connect to a service, it uses the <a href="specs/kernel/syscalls.html#0x2a-connect_service"><code>CONNECT_SERVICE</code></a> to send a <em>connection request</em> to this service.</p>
<p>The service process then receives the request through the <a href="specs/kernel/signals.html#0x2a-service_conn_request"><code>SERVICE_CONN_REQUEST</code></a>.</p>
<p>It is expected to answer under a short delay specified in the <a href="specs/registry.html">registry</a>'s <code>system.signals.service_answer_delay</code> key (1000 ms by default).</p>
<p>If the service refuses the connection, it provides its answer through the <a href="specs/kernel/syscalls.html#0x2d-reject_service_conn"><code>REJECT_SERVICE_CONN</code></a> syscall, and the procedure stops here.</p>
<p>Else, it accepts it through the <a href="specs/kernel/syscalls.html#0x2c-accept_service_conn"><code>ACCEPT_SERVICE_CONN</code></a> syscall. A new thread is then created in the service's process, and the signal returns with a code indicating if the current thread is the one that was just created.</p>
<h3><a class="header" href="#communication" id="communication">Communication</a></h3>
<p>The service and its client(s) communicate through the service socket created during the connection.</p>
<p>The different message formats a client can send to a service are a called the service's <em>methods</em>, while the different message formats the service may send to a client are called the service's <em>notifications</em>.</p>
<h3><a class="header" href="#thread-types" id="thread-types">Thread types</a></h3>
<p>A service process' main thread is called its <em>dispatcher threads</em>, while threads created using the <a href="specs/kernel/syscalls.html#0x2c-accept_service_conn"><code>ACCEPT_SERVICE_CONN</code></a> syscall are called <em>client threads</em>.</p>
<h3><a class="header" href="#closing-a-connection" id="closing-a-connection">Closing a connection</a></h3>
<p>The service cannot terminate a connection by itself.
If a client thread terminates brutally, the <a href="specs/kernel/signals.html#0x2d-service_server_quitted"><code>SERVICE_SERVER_QUITTED</code></a> signal will be sent to its client.</p>
<p>Only clients can properly close a connection to a service, using the <a href="specs/kernel/syscalls.html#0x2b-end_service_conn"><code>END_SERVICE_CONN</code></a> syscall. The service socket is then immediatly closed (on both the client and the thread's side).</p>
<p>The service then receives the <a href="specs/kernel/signals.html#0x2c-service_client_quitted"><code>SERVICE_CLIENT_QUITTED</code></a> signal.</p>
<p>If the client terminates brutally (before the connection was properly ended), the client thread receives the <a href="specs/kernel/signals.html#0x2b-service_client_closed"><code>SERVICE_CLIENT_CLOSED</code></a> signal.</p>
<p>When a client thread receives on these two signals, it is expected to end as soon as possible (though there is no time limit).</p>
<h2><a class="header" href="#system-services-1" id="system-services-1">System services</a></h2>
<p>You can find the list of all system services in the <a href="specs/services/README.html">related directory</a>.</p>
<h1><a class="header" href="#kernel" id="kernel">Kernel</a></h1>
<p>NightOS' kernel is named <em>Cosmos</em>. It is a micro-kernel which tries to be as simple and straightforward as possible, delegating all non-trivial tasks such as filesystem access or permissions management to <a href="specs/kernel/../../technical/services.html">services</a>.</p>
<p><strong>NOTE: This document is in its <em>very early stages</em>, and so is far from being complete. Major changes may and will be made to related documents.</strong></p>
<h2><a class="header" href="#documents" id="documents">Documents</a></h2>
<ul>
<li><a href="specs/kernel/hardware.html">Hardware</a> - how the kernel interacts with hardware</li>
<li><a href="specs/kernel/memory.html">Memory</a> - memory organization and management</li>
<li><a href="specs/kernel/processes.html">Processes</a> - processes concept and management</li>
<li><a href="specs/kernel/data-structures.html">Data structures</a> - data structures used by the kernel to represent things in memory</li>
<li><a href="specs/kernel/kpc.html">Kernel-process communication</a> - how the kernel communicate with processes and vice-versa</li>
<li><a href="specs/kernel/ipc.html">Inter-process communication</a> - communication between processes</li>
<li><a href="specs/kernel/signals.html">Signals</a> - complete specification of <a href="specs/kernel/kpc.html">signals</a></li>
<li><a href="specs/kernel/syscalls.html">System calls</a> - complete specification of <a href="specs/kernel/kpc.html">system calls</a></li>
</ul>
<h1><a class="header" href="#hardware-management" id="hardware-management">Hardware management</a></h1>
<p>This document describes how the kernel interacts with hardware.</p>
<ul>
<li><a href="specs/kernel/hardware.html#hardware-detection">Hardware detection</a></li>
<li><a href="specs/kernel/hardware.html#connection-specific-device-descriptor">Connection-specific device descriptor</a></li>
<li><a href="specs/kernel/hardware.html#connection-interface-identifier">Connection interface identifier</a></li>
<li><a href="specs/kernel/hardware.html#session-device-identifier">Session device identifier</a></li>
<li><a href="specs/kernel/hardware.html#raw-device-descriptor">Raw device descriptor</a></li>
<li><a href="specs/kernel/hardware.html#drivers">Drivers</a></li>
</ul>
<h2><a class="header" href="#hardware-detection" id="hardware-detection">Hardware detection</a></h2>
<p>Devices are detected during the boot process and then periodically after startup. This allows to hotplug some additional components afterwards.</p>
<p>As all components do not use the same connection protocols, the detection process depends on the connection:</p>
<ul>
<li>PCI-Express components are detected through their Configuration Space</li>
<li>IDE/SATA components are detected through the IDE/SATA controller</li>
<li>USB components are enumerated through the USB protocol stack</li>
</ul>
<p>Some components may not be detected through these though, such as some legacy ISA devices, which will be detected through a set of methods like ACPI enumeration or simply checking UART serial ports.</p>
<h2><a class="header" href="#connection-specific-device-descriptor" id="connection-specific-device-descriptor">Connection-specific device descriptor</a></h2>
<p>All hardware components (devices) expose a normalized identifier whose format depends on the connection type (PCI-Express, SATA, ...). This identifier is called the <em>connection-specific device descriptor</em> (CSDD).</p>
<p>Its size can vary up to 256 bytes.</p>
<h2><a class="header" href="#connection-interface-identifier" id="connection-interface-identifier">Connection interface identifier</a></h2>
<p>The <em>connection interface identifier</em> (CII) is a 4-byte number describing what a component is connected to:</p>
<ul>
<li>Connection type (1 byte):
<ul>
<li><code>0x01</code>: PCI-Express</li>
<li><code>0x02</code>: IDE</li>
<li><code>0x03</code>: SATA</li>
<li><code>0x04</code>: M.2</li>
<li><code>0x05</code>: USB</li>
<li><code>0x06</code>: RGB</li>
</ul>
</li>
<li>Bus number (1 byte)</li>
<li>Port number (2 bytes)</li>
</ul>
<p>For instance, the seventh USB port on the second bus will have the <code>0x05010006</code> CII.</p>
<h2><a class="header" href="#session-device-identifier" id="session-device-identifier">Session device identifier</a></h2>
<p>The kernel generates for each device a <em>session device identifier</em> (SDI), which is a random 4-byte number specific to the current session, allowing to plug up to 4 billion devices in a single session.</p>
<h2><a class="header" href="#raw-device-descriptor" id="raw-device-descriptor">Raw device descriptor</a></h2>
<p>The <em>raw device descriptor</em> (RDD) is a data structure (up to 264 bytes) made of the followings:</p>
<ul>
<li><a href="specs/kernel/hardware.html#session-device-identifier">SDI</a> (4 bytes)</li>
<li><a href="specs/kernel/hardware.html#connection-interface-identifier">CII</a> (4 bytes)</li>
<li><a href="specs/kernel/hardware.html#connection-specific-device-descriptor">CSDD</a> (up to 256 bytes)</li>
</ul>
<p>This descriptor is then used by the <a href="specs/kernel/../services/hw.html"><code>sys::hw</code></a> service to expose the device to the rest of the operating system.</p>
<h2><a class="header" href="#drivers" id="drivers">Drivers</a></h2>
<p>Drivers and software &lt;-&gt; hardware devices communications are handled by the <a href="specs/kernel/../services/hw.html"><code>sys::hw</code></a> system service.</p>
<p>You can find more about how drivers work in <a href="specs/kernel/../services/hw.html#drivers">this section</a>.</p>
<h1><a class="header" href="#memory" id="memory">Memory</a></h1>
<p>This document describes how the kernel organizes and manages the memory.</p>
<h2><a class="header" href="#pages" id="pages">Pages</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#isolation" id="isolation">Isolation</a></h2>
<p>Each <a href="specs/kernel/processes.html">process</a> has its own 64-bit address space, preventing it from accessing other processes' data. The memory is made of pages, which must be either be <a href="specs/kernel/syscalls.html#0x30-mem_alloc">allocated</a> or mapped using <a href="specs/kernel/memory.html#abstract-memory-segments">virtual memory segments</a>.</p>
<h2><a class="header" href="#abstract-memory-segments" id="abstract-memory-segments">Abstract memory segments</a></h2>
<p>An <em>abstract memory segment</em> (AMS) is an identifier which refers to a segment of memory which doesn't actually exist. To be used, they must be <em>mapped</em> in a process' memory to be accessed like regular memory. The kernel then intercepts all memory accesses to these mappings and handle them, depending on their nature which cover three cases:</p>
<ul>
<li><a href="specs/kernel/syscalls.html#0x32-virt_mem_ams">Mapping existing memory pages to others, or sharing them with other processes</a> ;</li>
<li><a href="specs/kernel/syscalls.html#0x34-device_ams">Mapping a device's memory into the process' own memory space</a> ;</li>
<li><a href="specs/kernel/syscalls.html#0x33-backed_ams">Making a virtual memory space handled by signals</a></li>
</ul>
<p>An AMS can then be mapped at multiple places in a process' memory, or shared with other processes. The kernel handles mappings to get optimal performances and reduce the number of memory accesses as much as possible.</p>
<h1><a class="header" href="#processes-1" id="processes-1">Processes</a></h1>
<p>Apart from the kernel itself, all programs run in <em>processes</em>.</p>
<ul>
<li><a href="specs/kernel/processes.html#why-processes">Why processes</a></li>
<li><a href="specs/kernel/processes.html#switching-and-cycles">Switching and cycles</a></li>
<li><a href="specs/kernel/processes.html#process-attributes">Process attributes</a></li>
<li><a href="specs/kernel/processes.html#performance-balancing">Performance balancing</a>
<ul>
<li><a href="specs/kernel/processes.html#automatic-priority-attribution">Automatic priority attribution</a></li>
</ul>
</li>
<li><a href="specs/kernel/processes.html#drivable-devices">Drivable devices</a></li>
</ul>
<h2><a class="header" href="#why-processes" id="why-processes">Why processes</a></h2>
<p>Separating programs in threads presents several advantages:</p>
<ol>
<li>This allows to take advantage of multi-core architectures by running multiple programs in parallel</li>
<li>Each program has its own data space and does not share its data with other programs</li>
<li>Each process has its own permissions and thus cannot bypass what the user chosen</li>
</ol>
<h2><a class="header" href="#switching-and-cycles" id="switching-and-cycles">Switching and cycles</a></h2>
<p>To run processes, the kernel simply iterates over the list of existing processes, and allow them to run a given number of instructions. Then, the control is taken back by the kernel which runs the next process, and so goes on.</p>
<p>This happens as follows:</p>
<ol>
<li>A process is selected</li>
<li>If the process is currently suspended, it is ignored</li>
<li>Its registers are restored by the kernel (if any)</li>
<li>The process runs a given number of instructions</li>
<li>The kernel takes back the control of the CPU</li>
<li>The process' registers are saved</li>
<li>Go to step 1</li>
</ol>
<p>These steps are known as a <em>cycle</em>.</p>
<h2><a class="header" href="#process-attributes" id="process-attributes">Process attributes</a></h2>
<p>Each process has a set of <em>attributes</em> which contains critical informations on it (lists are usually <a href="specs/kernel/data-structures.html#packed-linked-lists">PLL</a>):</p>
<ul>
<li>PID (8 bytes)</li>
<li>Priority (1 byte)</li>
<li>Running user's ID (8 bytes)</li>
<li>Parent application ID (8 bytes) - <code>0</code> for system services</li>
<li>Pointer to the <a href="specs/kernel/../applications/context.html">execution context</a> (8 bytes) - <code>0</code> for system services</li>
<li><code>PLL(e=32)</code> for memory mappings</li>
<li><code>PLL(e=32)</code> for <a href="specs/kernel/processes.html#raw-permissions">raw permissions</a></li>
<li><code>PLL(e=32)</code> for <a href="specs/kernel/processes.html#drivable-devices">drivable devices</a></li>
</ul>
<h2><a class="header" href="#performance-balancing" id="performance-balancing">Performance balancing</a></h2>
<p>Each process has a <em>priority</em> number, between 1 and 20, which indicates how much its performances must be prioritized compare to other processes.</p>
<p>The basics can be found <a href="specs/kernel/../../features/balancer.html">here</a>.</p>
<p>More specifically, the higher the priority of a process is, the faster it will run. Here are the priority-dependant aspects of a process:</p>
<ul>
<li>Number of instructions run per cycle</li>
<li>Priority when accessing I/O through services</li>
</ul>
<p>Comparatively, when a process has a high priority, other processes will run a tad slower.</p>
<h3><a class="header" href="#automatic-priority-attribution" id="automatic-priority-attribution">Automatic priority attribution</a></h3>
<p>Processes' priority is automatically adjusted by the kernel, unless it is manually assigned through the <a href="specs/kernel/syscalls.html#0xd1-set_priority"><code>SET_PRIORITY</code></a> syscall.</p>
<p>The priority is determined based on multiple factors:</p>
<ul>
<li>Does the process have a fullscreen window?</li>
<li>Does the process owns the active window?</li>
<li>Does the process owns a visible window?</li>
<li>Is the process a driver or service? If so, how much is it used?</li>
</ul>
<h2><a class="header" href="#drivable-devices" id="drivable-devices">Drivable devices</a></h2>
<p>The drivable devices attribute contains the list of all devices' <a href="specs/kernel/hardware.html#session-device-identifier">SDI</a> the current process can drive.</p>
<p>The goal of this attribute is to determine if the process is allowed to map a device's memory by creating an <a href="specs/kernel/memory.html#abstract-memory-segments">AMS</a> from it using the <a href="specs/kernel/syscalls.html#0x34-device_ams"><code>DEVICE_AMS</code></a> syscall, as well as using DMA-related instructions in the CPU.</p>
<p>This attribute is managed by the <a href="specs/kernel/../services/hw.html"><code>sys::hw</code></a> service and can only be updated by this service.</p>
<h1><a class="header" href="#raw-permissions" id="raw-permissions">Raw permissions</a></h1>
<p><em>Raw permissions</em> are used by system services to determine the permissions of a process without <a href="specs/kernel/ipc.html#exchanges-and-messages">sending a message</a> to the <a href="specs/kernel/../services/perm.html"><code>sys::perm</code></a> service and waiting for its answer, which would be costly in terms of performance.</p>
<p>These permissions use a specific structure, specified in the <a href="specs/kernel/../services/perm.html#list-of-permissions">related service's specifications document</a>.</p>
<p>Permissions can be managed using the <a href="specs/kernel/../services/perm.html"><code>sys::perm</code></a> service.</p>
<h1><a class="header" href="#data-structures" id="data-structures">Data structures</a></h1>
<p>This documents describes the structures used by the kernel to represent the data it uses in memory.</p>
<h2><a class="header" href="#packed-linked-lists" id="packed-linked-lists">Packed linked lists</a></h2>
<p><em>Packed linked lists</em> (PLL) are linked lists used for items whose size is both small (usually &lt;= 32 bytes) and fixed for all items.</p>
<p>It uses a system of same-size entries, each containing a micro bump allocator.</p>
<p>The goal of a PLL is to provide a blazing fast read and iteration speed, while compromising on insertion and deletion speeds.</p>
<h3><a class="header" href="#caracteristics" id="caracteristics">Caracteristics</a></h3>
<p>A PLL is caracterized by its <em>item size</em>, <em>length</em> (the number of items in the list) and the <em>number of items per entry</em> (NIE) (up to 255), which is the number of items which can be stored per entry. It is noted <code>PLL(e=&lt;number of items per entry&gt;[, s=&lt;item size in bytes&gt;][, l=&lt;number of elements currently in the list&gt;])</code>.</p>
<h3><a class="header" href="#structure-in-memory" id="structure-in-memory">Structure in memory</a></h3>
<p>Each entry is a contiguous suite of bytes which can store up to <code>NIE</code> items contiguously. It starts by either a pointer to the next entry (on 8 bytes), or the number of items actually initialized in the current entry (pre-filled with zeros to be stored on 8 bytes).</p>
<p>For instance, let's take a <code>PLL(e=3, s=2, l=4)</code>. Its content is the four following items:</p>
<ul>
<li><code>0xDEADBEEF</code></li>
<li><code>0x01234567</code></li>
<li><code>0x89ABCDEF</code></li>
<li><code>0xBEEFDEAD</code></li>
</ul>
<p>If the first entry is located at address <code>0x00001000</code> and the second at address <code>0x00002000</code>, here is the PLL's representation in memory with big-endian representation (with <code>_</code> representing garbade data):</p>
<pre><code>0x0000000000001000: 00 00 20 00 DE AD BE EF 01 23 45 67 89 AB CD EF
0x0000000000002000: 00 00 00 01 BE EF DE AD __ __ __ __ __ __ __ __
</code></pre>
<p>As you can see, the first entry contains the address to the next entry, followed by the content of the first three items (contiguously).<br />
The second entry is the last one and so simply contains the number of initialized items, followed by the last item's content, and then garbage as this memory zone is not initialized yet.</p>
<h3><a class="header" href="#checking-an-entrys-type" id="checking-an-entrys-type">Checking an entry's type</a></h3>
<p>To check if the first byte of an entry is the next entry's address or the number of initialized items, we simply have to perform a simple comparison: if the byte is greater than <code>0xFF</code> (255 in decimal, which is the maximum allowed number of items per entry), then it's an address, else it's a number of initialized elements.</p>
<h3><a class="header" href="#the-ratio" id="the-ratio">The ratio</a></h3>
<p>A PLL also has a <em>ratio</em>, which is the number of bytes reserved for items in each entry, divided by the total number of bytes. So, in our example, 3 items per entry * 4 bytes = 12 bytes, while the total number of bytes per entry also takes into account the address itself, so 12 bytes + 8 bytes = 20 : our PLL's ratio is <code>0.6</code>.</p>
<p>This is quite a low ratio, meaning we waste a lot of space. The ratio must be kept as near as <code>1.0</code> as possible, while maintaining a reasonable memory footprint for each entry.</p>
<h3><a class="header" href="#performances-bottlenecks" id="performances-bottlenecks">Performances bottlenecks</a></h3>
<p>A thing to keep in mind is that PLL have a considerable performances bottleneck: when an entry is filled, the next must be allocated with a size that's a lot larger than a single item's size. That's why, when an entry is full, it should be allocated on the moment time is the less critical.</p>
<p>Performances are especially bad when inserting new items in the list or when removing ones, as many data needs to be moved around.</p>
<p>Regarding updating elements, this requires to write both the item itself. Inserting elements in a not-yet full entry requires to write the element itself as well as incrementing the entry's counter.</p>
<h3><a class="header" href="#performance-advantages" id="performance-advantages">Performance advantages</a></h3>
<p>As you can see in the above bottlenecks, PLL are not meant to be performant on writings. They are meant to be fast for reads, especially sequential reads. The higher the <code>NIE</code> of the list, the fastest it will be to find an element in it, or to read every element of the list one by one (iteration).</p>
<p>Also, as the counter is packed with the other data of each entry, it presents a reduced risk of cache miss.</p>
<p>Computing the length is reasonably fast.</p>
<h3><a class="header" href="#length-first-variant" id="length-first-variant">Length-first variant</a></h3>
<p>There is a variant of the PLL that stores the total length of the list somewhere in the memory. In that case, the first byte of the last entry does not need to store the number of items in the entry.</p>
<p>This variant is interesting being we can instantly get the number of items in the list, but the downside is that reading sequentially the list will also incur an additional reading to know where the last entry ends, and updating the total length incur a high risk of cache fault as the chances of the memory area where the length is as well as the entry itself be in the cache at the same time are pretty low.</p>
<p>The length-first variant should only be used when accessing the length instantly is critical.</p>
<h3><a class="header" href="#tricking-the-nie" id="tricking-the-nie">Tricking the <code>NIE</code></a></h3>
<p>Increasing the NIE will:</p>
<ul>
<li>Reduce the needs of allocating</li>
<li>Fasten iteration times</li>
<li>Fasten insertion times (when the last entry isn't full)</li>
</ul>
<p>But also:</p>
<ul>
<li>Increase the memory cost (of the last entry)</li>
<li>Worsen allocation performances (as the entries are larger)</li>
</ul>
<h1><a class="header" href="#kernel-process-communication" id="kernel-process-communication">Kernel-Process Communication</a></h1>
<p>The <em>Kernel-Process Communication</em> (KPC) describes how a process can interact with the kernel, and vice-versa.</p>
<p>There are two types of KPC:</p>
<ul>
<li><a href="specs/kernel/syscalls.html">System calls</a>, which are used by a process to ask the kernel to perform an action ;</li>
<li><a href="specs/kernel/signals.html">Signals</a>, which are used by the kernel to send informations about an event to a process</li>
</ul>
<p>Note that, unlike many operating systems like Linux, it's not possible for a process to send a signal to another. Only the kernel is allowed to emit signals.</p>
<p>For more advanced features, like permissions management or filesystem, check <a href="specs/kernel/../../technical/ipc.html">IPC</a>.</p>
<h1><a class="header" href="#inter-process-communication" id="inter-process-communication">Inter-Process Communication</a></h1>
<p>This document describes the way <a href="specs/kernel/../../technical/ipc.html">Inter-Process Communication (IPC)</a> works.</p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipes</a>
<ul>
<li><a href="specs/kernel/ipc.html#opening-pipes">Opening pipes</a></li>
<li><a href="specs/kernel/ipc.html#pipes-pending-data">Pipes' pending data</a></li>
<li><a href="specs/kernel/ipc.html#pipes-locking">Pipes locking</a></li>
<li><a href="specs/kernel/ipc.html#closing-pipes">Closing pipes</a></li>
<li><a href="specs/kernel/ipc.html#message-pipes">Message pipes</a></li>
<li><a href="specs/kernel/ipc.html#interactive-usage">Interactive usage</a></li>
</ul>
</li>
<li><a href="specs/kernel/ipc.html#service-sockets">Service sockets</a>
<ul>
<li><a href="specs/kernel/ipc.html#opening">Opening</a></li>
<li><a href="specs/kernel/ipc.html#exchanges-and-messages">Exchanges and messages</a></li>
<li><a href="specs/kernel/ipc.html#concluding-exchanges">Concluding exchanges</a></li>
<li><a href="specs/kernel/ipc.html#methods-and-notifications">Methods and notifications</a></li>
<li><a href="specs/kernel/ipc.html#closing-service-sockets">Closing service sockets</a></li>
</ul>
</li>
<li><a href="specs/kernel/ipc.html#shared-memory">Shared Memory</a></li>
</ul>
<h2><a class="header" href="#pipes-1" id="pipes-1">Pipes</a></h2>
<p><em>Inter-process Uni-directional Channels</em> (IUC), also called <em>pipes</em>, allow two distinct processes to communicate.</p>
<p>Pipes are made of two uni-directional parts:</p>
<ul>
<li>A <em>sender channel</em> (SC) which can only be written to (write-only)</li>
<li>A <em>receiver channel</em> (RC), which can only be read from (read-only)</li>
</ul>
<p>The two processes sharing a pipes are:</p>
<ul>
<li>The <em>sender process</em>, which uses the SC to send data to the other process</li>
<li>The <em>receiver process</em>, which uses the RC to retrieve data sent by the other process</li>
</ul>
<p>The process that creates the pipe gets both the SC and the RC, and is expected to provide one of them to another process.</p>
<p>Each SC and RC has a unique identifier, which is binded to the process that created it.<br />
The process receiving an SC or RC receives another identifier for it, unique to that process, which prevents IDs collisions.</p>
<h3><a class="header" href="#opening-pipes" id="opening-pipes">Opening pipes</a></h3>
<p>A process can open a pipe with another process using the <a href="specs/kernel/syscalls.html#0x20-open_pipe"><code>OPEN_PIPE</code></a> syscall.</p>
<p>The other process will then receive the <a href="specs/kernel/signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal. If no handler is set when the signal is sent, the opening syscall fails.</p>
<h3><a class="header" href="#pipes-pending-data" id="pipes-pending-data">Pipes' pending data</a></h3>
<p>When a pipe is written to, the data is written to a memory zone. This zone is called the <em>pipe's buffer</em> and it's content is called the <em>pending data</em>.<br />
When a pipe is read from, the pending data is progressively retrieved, erased as the read progresses.</p>
<p>The default size of the pipe's buffer is 64 KB, but this can be extended to up to 16 MB during its creation.
When it is reached, no data can be written to the pipe anymore, meaning the other process must read data from it in order to free space to write it.</p>
<h3><a class="header" href="#pipes-locking" id="pipes-locking">Pipes locking</a></h3>
<p>When a pipe is being written to or read from, it is <em>locked</em>, which means no other writing or reading can happen during this time. This prevents data races which are a common source of bugs which are complex to debug, while not compromising performances.</p>
<h3><a class="header" href="#closing-pipes" id="closing-pipes">Closing pipes</a></h3>
<p>Any of the two processes (be it the receiver or the sender) can close a pipe using the <a href="specs/kernel/syscalls.html#0x25-close_pipe"><code>CLOSE_PIPE</code></a> syscall, providing its SC or RC identifier. The pipe is immediatly closed on both sides, and the other process receives the <a href="specs/kernel/signals.html#0x21-pipe_closed"><code>PIPE_CLOSED</code></a> signal.</p>
<h3><a class="header" href="#message-pipes" id="message-pipes">Message pipes</a></h3>
<p>Pipes are designed to transmit streams of data, but sometimes we need to use them to transmit messages. This is why there are specific <a href="specs/kernel/syscalls.html">syscalls</a> and <a href="specs/kernel/signals.html">signals</a> to deal with this problem.</p>
<p>A <em>message pipe</em> is a pipe that only sends and receives dynamic-sized messages instead of a stream of bytes.<br />
They have a maximum length of 64 KB, which is the pipes' buffer's minimal capacity. Messages must always be sent at once and cannot be sent partially.<br />
Their length is determined when the message is sent which, coupled to <a href="specs/kernel/ipc.html#pipes-locking">pipes locking</a>, allows to retrieve complete messages directly.</p>
<p>It's not possible to send &quot;non-message&quot; data through a message pipe, as the action of writing to a pipe will automatically check if it's a message pipe and ensure the size and &quot;send at once&quot; requirement are met.</p>
<h3><a class="header" href="#interactive-usage" id="interactive-usage">Interactive usage</a></h3>
<p>You can find more informations on interactive usage in the <a href="specs/kernel/../shell.html#interactivity">shell specifications</a>.</p>
<h2><a class="header" href="#service-sockets" id="service-sockets">Service sockets</a></h2>
<p>The downside of message pipes is that they are not designed to handle responses from the receiver process, and they also don't have built-in errors handling.</p>
<p>To solve this, it's possible to use <em>service sockets</em>, which as their name indicate are mainly used to communicate with <a href="specs/kernel/../services.html">services</a>. A socket is caracterized by the process opening it, called the <em>service</em>, and the process receiving it, the <em>client</em>.</p>
<h3><a class="header" href="#opening" id="opening">Opening</a></h3>
<p>Sockets are opened with the <a href="specs/kernel/syscalls.html#0x26-open_serv_sock"><code>OPEN_SERV_SOCK</code></a> syscall. The other process receives the <a href="specs/kernel/signals.html#0x26-recv_serv_sock"><code>RECV_SERV_SOCK</code></a> signal on its side.</p>
<h3><a class="header" href="#exchanges-and-messages" id="exchanges-and-messages">Exchanges and messages</a></h3>
<p>Service sockets are based on <em>exchanges</em>, which are sets of messages. An exchange is described by a structure made of the following:</p>
<ul>
<li>Identifier (8 bytes)</li>
<li>Method or notification code (1 byte)</li>
<li>Status: is the exchange closed, and if so what is the error code (on 2 bytes)</li>
<li>Message counter for this exchange (4 bytes)</li>
</ul>
<p>This structure is handled by the kernel itself and can be managed using a set of system calls and signals.</p>
<p>Messages can then be sent using the <a href="specs/kernel/syscalls.html#0x27-send_sock_msg"><code>SEND_SOCK_MSG</code></a> syscall and received through the <a href="specs/kernel/signals.html#0x27-recv_sock_msg"><code>RECV_SOCK_MSG</code></a> signal. To be read, the receiver process must use the <a href="specs/kernel/syscalls.html#0x28-read_sock_msg"><code>READ_SOCK_MSG</code></a> syscall.</p>
<p>They must be sent at once, like in message pipes. The maximum size is 4 KB by default, but can be extended through the opening syscall up to 256 MB.</p>
<p>A message can either <em>initiate</em> an exchange or <em>answer</em> to an existing one: in the first case, an identifier will be generated by the kernel and returned by the sending syscall, and in the latter the message will receive an incremented identifier that allows to track where in the exchange the message is. This also prevents a process to send two messages before the other one answers.</p>
<h3><a class="header" href="#concluding-exchanges" id="concluding-exchanges">Concluding exchanges</a></h3>
<p>Exchanges can be either be <em>concluded</em> either by sending an error message or by sending a message with a close indicator to indicate this message will be the last one in the socket and no answer will be accepted.</p>
<p>Sending a message in a concluded exchange will result in a syscall error.</p>
<h3><a class="header" href="#methods-and-notifications" id="methods-and-notifications">Methods and notifications</a></h3>
<p>An exchange can be opened by a client to request something to the service, it is then called a <em>method</em>. In that case, the message's body is called the <em>arguments</em>.</p>
<p>When the server opens itself an exchange with the client, it's called a <em>notification</em>. A notification message's body is called its <em>data</em>.</p>
<h3><a class="header" href="#closing-service-sockets" id="closing-service-sockets">Closing service sockets</a></h3>
<p>Service sockets can be closed with the <a href="specs/kernel/syscalls.html#0x29-close_serv_sock"><code>CLOSE_SERV_SOCK</code></a> syscall, which triggers the <a href="specs/kernel/signals.html#0x29-serv_sock_closed"><code>SERV_SOCK_CLOSED</code></a> signal on the other process' side.</p>
<p>Although exchanges are based on signals which are asynchronous by design, the answer mechanism and messages tracking which ensures the receiver process answers before sending another message allows for simplier communications and synchronization between the two processes.</p>
<h2><a class="header" href="#shared-memory" id="shared-memory">Shared Memory</a></h2>
<p>Shared memory allows a process to share a part of its memory with another process. It has multiple advantages over pipes:</p>
<ul>
<li>Data is not copied twice, as the sender process directly shares a part of its own memory</li>
<li>There is no pipe management, which results in saving operations and less memory accesses</li>
<li>There is no pipe buffer to manage which means all the data can be sent at once</li>
</ul>
<p>Its main disadvantage being that all data is shared at once, so there is no synchronization or &quot;asynchronous sending&quot; mechanism, which is the purpose of pipes.</p>
<p>It works by asking the kernel to share the memory through the <a href="specs/kernel/syscalls.html#0x35-share_ams"><code>SHARE_AMS</code></a> syscall, the target process receiving the <a href="specs/kernel/signals.html#0x35-recv_shared_ams"><code>RECV_SHARED_AMS</code></a> signal.</p>
<p>There are two types of sharing:</p>
<ul>
<li><em>Mutual</em> sharing allows both the sharer and the receiver processes to access the shared memory ;</li>
<li><em>Exclusive</em> sharing unmaps the shared memory from the sharer and only allows the receiver process to access it</li>
</ul>
<p>Exclusive mode has several advantages: the sender process to not have to care about managing this memory and avoid overwriting it by accident, but it also ensures the receiving process that the sender will not perform malicious modifications on the shared buffer while the data is processed on its side.</p>
<p>Mutual memory sharing can be stopped using the <a href="specs/kernel/syscalls.html#0x37-unshare_ams"><code>UNSHARE_AMS</code></a> syscall, while exclusive sharing are left to the receiver process.</p>
<h1><a class="header" href="#signals" id="signals">Signals</a></h1>
<p><em>Signals</em> are a type of <a href="specs/kernel/kpc.html">KPC</a>. They are used by the kernel to send informations to processes about a specific event.</p>
<ul>
<li><a href="specs/kernel/signals.html#technical-overview">Technical overview</a></li>
<li><a href="specs/kernel/signals.html#list-of-signals">List of signals</a>
<ul>
<li><a href="specs/kernel/signals.html#0x01-handler_fault"><code>0x01</code> HANDLER_FAULT</a></li>
<li><a href="specs/kernel/signals.html#0x02-mem_fault"><code>0x02</code> MEM_FAULT</a></li>
<li><a href="specs/kernel/signals.html#0x10-suspend"><code>0x10</code> SUSPEND</a></li>
<li><a href="specs/kernel/signals.html#0x11-will_suspend"><code>0x11</code> WILL_SUSPEND</a></li>
<li><a href="specs/kernel/signals.html#0x12-terminate"><code>0x12</code> TERMINATE</a></li>
<li><a href="specs/kernel/signals.html#0x13-will_terminate"><code>0x13</code> WILL_TERMINATE</a></li>
<li><a href="specs/kernel/signals.html#0x20-recv_pipe"><code>0x20</code> RECV_PIPE</a></li>
<li><a href="specs/kernel/signals.html#0x21-pipe_closed"><code>0x21</code> PIPE_CLOSED</a></li>
<li><a href="specs/kernel/signals.html#0x26-recv_serv_sock"><code>0x26</code> RECV_SERV_SOCK</a></li>
<li><a href="specs/kernel/signals.html#0x27-recv_sock_msg"><code>0x27</code> RECV_SOCK_MSG</a></li>
<li><a href="specs/kernel/signals.html#0x29-serv_sock_closed"><code>0x29</code> SERV_SOCK_CLOSED</a></li>
<li><a href="specs/kernel/signals.html#0x2a-service_conn_request"><code>0x2A</code> SERVICE_CONN_REQUEST</a></li>
<li><a href="specs/kernel/signals.html#0x2b-service_client_closed"><code>0x2B</code> SERVICE_CLIENT_CLOSED</a></li>
<li><a href="specs/kernel/signals.html#0x2c-service_client_quitted"><code>0x2C</code> SERVICE_CLIENT_QUITTED</a></li>
<li><a href="specs/kernel/signals.html#0x2d-service_server_quitted"><code>0x2D</code> SERVICE_SERVER_QUITTED</a></li>
<li><a href="specs/kernel/signals.html#0x33-read_backed_ams"><code>0x33</code> READ_BACKED_AMS</a></li>
<li><a href="specs/kernel/signals.html#0x34-write_backed_ams"><code>0x34</code> WRITE_BACKED_AMS</a></li>
<li><a href="specs/kernel/signals.html#0x35-recv_shared_ams"><code>0x35</code> RECV_SHARED_AMS</a></li>
<li><a href="specs/kernel/signals.html#0x37-unshared_ams"><code>0x37</code> UNSHARED_AMS</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#technical-overview" id="technical-overview">Technical overview</a></h2>
<p>When a process is created, the kernel associates it:</p>
<ul>
<li>A <em>signals handler table</em> (SHT) ;</li>
<li>A <em>signals queue</em> ;</li>
<li>A <em>readiness indicator</em></li>
</ul>
<p>Each signal has a 8-bit code that identifies it, as well as a 32 bytes <em>datafield</em> which is used to attach additional informations about the signal.</p>
<p>When the kernel sends a signal to a process, it first checks if an handler is already running. If so, it simply pushes the signal to the queue.</p>
<p>Else, it checks the readiness indicator. If it is <code>false</code> (so if the process did not sent the <a href="specs/kernel/syscalls.html#0x04-ready"><code>READY</code></a> syscall yet), the signal is pushed to the queue.</p>
<p>Else, it checks in the SHT if the signal has a handler. If there is no handler, depending on the specific signal, it may either be ignored or use a default behaviour (this is documented for each signal).</p>
<p>If a handler is found, the kernel checks if the pointer points to a memory area that is executable by the current process. If it isn't, the signal is converted to an <a href="specs/kernel/signals.html#0x01-handler_fault"><code>HANDLER_FAULT</code></a> one. If the signal that was being sent was already an <code>HANDLER_FAULT</code>, the process is killed.</p>
<p>The kernel then switches the process to its <a href="specs/kernel/../../technical/processes.html#main-thread">main thread</a> and makes it jump to the handler's address, then resumes it.</p>
<p>When the handler returns (or the default behaviour completes), if the signal was expecting an answer, the kernel reads it from specific registries and does whatever it needs to do. Then, itchecks if the signals queue is empty. If it is, the kernel simply makes the process jump back to the address it was to before the signal was emitted, and switch to the original thread.</p>
<p>Else, it interrupts the process again and proceeds to treat the first signal on the queue after removing it.</p>
<p>On the performances side, signals use interrupts, meaning the process' current tasks are instantly interrupted to let it handle the signal without delay. Also, the datafield and answer are provided through CPU registers, avoiding memory accesses.</p>
<h2><a class="header" href="#list-of-signals" id="list-of-signals">List of signals</a></h2>
<p>You can find below the exhaustive list of signals.</p>
<h3><a class="header" href="#0x01-handler_fault" id="0x01-handler_fault"><code>0x01</code> HANDLER_FAULT</a></h3>
<p>Sent when a signal is sent to a process but the registered handler points to a memory zone that is not executable by the current process.
If the sending of this signal to the process results to another fault, it's called a <em>double handler fault</em> and the process is immediatly killed.</p>
<p>If no handler is registered for this signal, it will kill the process when received.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Faulty signal ID (8 bytes)</li>
</ul>
<h3><a class="header" href="#0x02-mem_fault" id="0x02-mem_fault"><code>0x02</code> MEM_FAULT</a></h3>
<p>Sent when the process tried to perform an unauthorized access on a memory address.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Faulty address (8 bytes)</li>
<li>Access error (1 byte):
<ul>
<li><code>0x01</code>: tried to read memory</li>
<li><code>0x02</code>: tried to write memory</li>
<li><code>0x03</code>: tried to execute memory</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#0x10-suspend" id="0x10-suspend"><code>0x10</code> SUSPEND</a></h3>
<p>Sent when the process is asked to suspend. It's up to the process to either ignore this signal or suspend itself using the <a href="specs/kernel/syscalls.html#0x12-suspend"><code>SUSPEND</code></a> syscall.</p>
<h3><a class="header" href="#0x11-will_suspend" id="0x11-will_suspend"><code>0x11</code> WILL_SUSPEND</a></h3>
<p>Sent when the process is asked to suspend. If it is not suspended after the provided delay, the process is suspended.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li><a href="specs/kernel/../registry.html">Registry</a>'s <code>system.signals.suspend_delay</code> key (default: 500ms) (2 bytes)</li>
</ul>
<h3><a class="header" href="#0x12-terminate" id="0x12-terminate"><code>0x12</code> TERMINATE</a></h3>
<p>Sent when the process is asked to terminate. It's up to the process to either ignore this signal or terminate itself (preferably by using the <a href="specs/kernel/syscalls.html#0x13-exit"><code>EXIT</code></a> syscall).</p>
<h3><a class="header" href="#0x13-will_terminate" id="0x13-will_terminate"><code>0x13</code> WILL_TERMINATE</a></h3>
<p>Sent when the process is asked to terminate. If it does not terminate by itself before the provided delay, the process is killed.</p>
<p>If no handler is registered for this signal, it will kill the process when received.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li><a href="specs/kernel/../registry.html">Registry</a>'s <code>system.signals.terminate_delay</code> key (default: 2s) (2 bytes)</li>
</ul>
<h3><a class="header" href="#0x20-recv_pipe" id="0x20-recv_pipe"><code>0x20</code> RECV_PIPE</a></h3>
<p>Sent to a process when another process of the same application and running under the same user opened an pipe with this process, giving it the other part.<br />
The command code can be used to determine what the other process is expecting this one to do. This code does not follow any specific format.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Pipe creator's PID (8 bytes)</li>
<li>Pipe creator's application's <a href="specs/kernel/../../concepts/applications.html#application-identifier">ANID</a> (4 bytes)</li>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> SC or RC identifier (8 bytes)</li>
<li>Command code (2 bytes)</li>
<li>Pipe identifier type (1 byte): <code>0x00</code> if the pipe identifier is an RC, <code>0x01</code> if it's an SC</li>
<li>Mode (1 byte): <code>0x00</code> if it's a raw pipe, <code>0x01</code> if it's a message pipe</li>
<li>Size hint in bytes (8 bytes), with <code>0</code> being the 'no size hint' value</li>
</ul>
<h3><a class="header" href="#0x21-pipe_closed" id="0x21-pipe_closed"><code>0x21</code> PIPE_CLOSED</a></h3>
<p>Sent to a process when a <a href="specs/kernel/ipc.html#pipes">pipe</a> shared with another process is closed.</p>
<p><strong>NOTE:</strong> This does not apply to service pipes.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Closing type (1 byte):
<ul>
<li><code>0x00</code> if the pipe was closed properly using the <a href="specs/kernel/syscalls.html#0x25-close_pipe">CLOSE_PIPE</a> syscall</li>
<li><code>0x01</code> if the other process brutally terminated |</li>
</ul>
</li>
<li>Pipe identity (1 byte): <code>0x00</code> if this process contained the RC part, <code>0x01</code> if it contained the SC part (1 byte)</li>
<li>RC or SC identifier (8 bytes)</li>
</ul>
<h3><a class="header" href="#0x26-recv_serv_sock" id="0x26-recv_serv_sock"><code>0x26</code> RECV_SERV_SOCK</a></h3>
<p>Sent to a process when another process opened a <a href="specs/kernel/ipc.html#service-sockets">service socket</a> with this one.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Service socket creator's PID (8 bytes)</li>
<li>Service socket creator's application's <a href="specs/kernel/../../concepts/applications.html#application-identifier">ANID</a> (4 bytes)</li>
<li>Service socket identifier (8 bytes)</li>
<li>Size of the buffer, multiplied by 4KB (2 bytes)</li>
</ul>
<h3><a class="header" href="#0x27-recv_sock_msg" id="0x27-recv_sock_msg"><code>0x27</code> RECV_SOCK_MSG</a></h3>
<p>Sent to a process when a message has been sent through a <a href="specs/kernel/ipc.html#service-sockets">service socket</a>.<br />
To read the message, the process must use the <a href="specs/kernel/syscalls.html#0x28-read_sock_msg"><code>READ_SOCK_MSG</code></a> syscall.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Servive socket identifier (8 bytes)</li>
<li>Exchange identifier (8 bytes)</li>
<li>Exchange method (1 byte)</li>
<li>Size of the message (4 bytes)</li>
<li>Status (1 byte):
<ul>
<li>Bit 0: set if this message did create a new exchange</li>
<li>Bit 1: set if this message is an error message</li>
<li>Bit 2: set if this message closed the socket</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#0x29-serv_sock_closed" id="0x29-serv_sock_closed"><code>0x29</code> SERV_SOCK_CLOSED</a></h3>
<p>(was there a message sent before that closed the socket)</p>
<p>Sent to a process when a <a href="specs/kernel/ipc.html#pipes">pipe</a> shared with another process is closed.</p>
<p><strong>NOTE:</strong> This does not apply to service pipes.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Closing type (1 byte):
<ul>
<li><code>0x00</code> if the pipe was closed properly using the <a href="specs/kernel/syscalls.html#0x25-close_pipe">CLOSE_PIPE</a> syscall</li>
<li><code>0x01</code> if the other process brutally terminated |</li>
</ul>
</li>
<li>Pipe identity (1 byte): <code>0x00</code> if this process contained the RC part, <code>0x01</code> if it contained the SC part (1 byte)</li>
<li>RC or SC identifier (8 bytes)</li>
</ul>
<h3><a class="header" href="#0x2a-service_conn_request" id="0x2a-service_conn_request"><code>0x2A</code> SERVICE_CONN_REQUEST</a></h3>
<p>Sent to a service process' <a href="specs/kernel/../services.html#thread-types">dispatcher thread</a> when another process tries to etablish a connection through the <a href="specs/kernel/syscalls.html#0x2a-connect_service"><code>CONNECT_SERVICE</code></a> syscall.</p>
<p>The process is expected to answer using the <a href="specs/kernel/syscalls.html#0x2c-accept_service_conn"><code>ACCEPT_SERVICE_CONNECTION</code></a> under the provided delay, else it's considered as a rejection.</p>
<p>If no handler is registered for this signal, it will kill the process when received.</p>
<p><strong>NOTE:</strong> This signal cannot be received if the application does not <a href="specs/kernel/../../concepts/applications.html#services">expose a service</a>.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Callee process' ID (8 bytes)</li>
<li>Connection's unique request ID (8 bytes)</li>
<li>Command code (2 bytes)</li>
<li><a href="specs/kernel/../registry.html">Registry</a>'s <code>system.signals.service_answer_delay</code> key (default: 1000ms) (2 bytes)</li>
</ul>
<h3><a class="header" href="#0x2b-service_client_closed" id="0x2b-service_client_closed"><code>0x2B</code> SERVICE_CLIENT_CLOSED</a></h3>
<p>Sent to a <a href="specs/kernel/../services.html#thread-types">client thread</a> to indicate its client closed before the connection was properly terminated.
The thread is expected to terminate as soon as possible (there is no time limit though).</p>
<h3><a class="header" href="#0x2c-service_client_quitted" id="0x2c-service_client_quitted"><code>0x2C</code> SERVICE_CLIENT_QUITTED</a></h3>
<p>Sent to a <a href="specs/kernel/../services.html#thread-types">client thread</a> to indicate its client asked to close the connection.
The associated RC and SC are immediatly closed.</p>
<h3><a class="header" href="#0x2d-service_server_quitted" id="0x2d-service_server_quitted"><code>0x2D</code> SERVICE_SERVER_QUITTED</a></h3>
<p>Sent to a process that previously established a connection with a service, to indicate the associated service thread closed before the connection was properly terminated.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Connection's unique request ID (8 bytes)</li>
</ul>
<h3><a class="header" href="#0x33-read_backed_ams" id="0x33-read_backed_ams"><code>0x33</code> READ_BACKED_AMS</a></h3>
<p>Sent to a process when a <a href="specs/kernel/syscalls.html#0x33-backed_ams">signal-backed</a> <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> is accessed in read mode.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
<li>Relative address accessed in the segment (8 bytes)</li>
<li>Access mode (1 byte): <code>0x00</code> for read, <code>0x01</code> for execution</li>
</ul>
<p><strong>Expected answer:</strong></p>
<ul>
<li>Associated data for this file (4 bytes)</li>
<li>Page fault (1 byte):
<ul>
<li><code>0x00</code>: no page fault</li>
<li><code>0x01</code>: address is out-of-range</li>
<li><code>0x02</code>: hardware fault</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#0x34-write_backed_ams" id="0x34-write_backed_ams"><code>0x34</code> WRITE_BACKED_AMS</a></h3>
<p>Sent to a process when a <a href="specs/kernel/syscalls.html#0x33-backed_ams">signal-backed</a> <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> is accessed in write mode.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
<li>Relative address accessed in the segment (8 bytes)</li>
<li>Data to write (4 bytes)</li>
</ul>
<p><strong>Expected answer:</strong></p>
<ul>
<li>Page fault (1 byte):
<ul>
<li><code>0x00</code>: no page fault</li>
<li><code>0x01</code>: address is out-of-range</li>
<li><code>0x02</code>: hardware fault</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#0x35-recv_shared_ams" id="0x35-recv_shared_ams"><code>0x35</code> RECV_SHARED_AMS</a></h3>
<p>Sent to a process when an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> is <a href="specs/kernel/ipc.html#shared-memory">shared</a> by another process.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Sender PID (8 bytes)</li>
<li>Command code (2 bytes)</li>
<li>AMS ID (8 bytes)</li>
<li>Sharing mode (1 byte): <code>0x00</code> for mutual sharing, <code>0x01</code> for exclusive sharing</li>
<li>Access permissions (1 byte):
<ul>
<li>For mutual sharings: strongest bit for read, next for write, next for exec</li>
<li>For exclusive sharings: <code>0b11100000</code></li>
</ul>
</li>
</ul>
<h3><a class="header" href="#0x37-unshared_ams" id="0x37-unshared_ams"><code>0x37</code> UNSHARED_AMS</a></h3>
<p>Sent to a process when an<a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> is unshared by the sharer process.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Unsharing type (1 byte):
<ul>
<li><code>0x00</code> if the shared memory was unshared properly using the <a href="specs/kernel/syscalls.html#0x37-unshare_ams">UNSHARE_AMS</a> syscall</li>
<li><code>0x01</code> if the other process brutally terminated</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#system-calls" id="system-calls">System calls</a></h1>
<p><em>System calls</em>, abbreviated <em>syscalls</em>, are a type of <a href="specs/kernel/kpc.html">KPC</a>. They allow a process to ask the kernel to perform an action.</p>
<ul>
<li><a href="specs/kernel/syscalls.html#technical-overview">Technical overview</a></li>
<li><a href="specs/kernel/syscalls.html#list-of-syscalls">List of syscalls</a>
<ul>
<li><a href="specs/kernel/syscalls.html#0x01-handle_signal"><code>0x01</code> HANDLE_SIGNAL</a></li>
<li><a href="specs/kernel/syscalls.html#0x02-unhandle_signal"><code>0x02</code> UNHANDLE_SIGNAL</a></li>
<li><a href="specs/kernel/syscalls.html#0x03-is_signal_handled"><code>0x03</code> IS_SIGNAL_HANDLED</a></li>
<li><a href="specs/kernel/syscalls.html#0x04-ready"><code>0x04</code> READY</a></li>
<li><a href="specs/kernel/syscalls.html#0x10-get_pid"><code>0x10</code> GET_PID</a></li>
<li><a href="specs/kernel/syscalls.html#0x12-suspend"><code>0x12</code> SUSPEND</a></li>
<li><a href="specs/kernel/syscalls.html#0x13-exit"><code>0x13</code> EXIT</a></li>
<li><a href="specs/kernel/syscalls.html#0x20-open_pipe"><code>0x20</code> OPEN_PIPE</a></li>
<li><a href="specs/kernel/syscalls.html#0x21-send_pipe"><code>0x21</code> SEND_PIPE</a></li>
<li><a href="specs/kernel/syscalls.html#0x22-pipe_write"><code>0x22</code> PIPE_WRITE</a></li>
<li><a href="specs/kernel/syscalls.html#0x23-pipe_read"><code>0x23</code> PIPE_READ</a></li>
<li><a href="specs/kernel/syscalls.html#0x24-pipe_info"><code>0x24</code> PIPE_INFO</a></li>
<li><a href="specs/kernel/syscalls.html#0x25-close_pipe"><code>0x25</code> CLOSE_PIPE</a></li>
<li><a href="specs/kernel/syscalls.html#0x26-open_serv_sock"><code>0x26</code> OPEN_SERV_SOCK</a></li>
<li><a href="specs/kernel/syscalls.html#0x27-send_sock_msg"><code>0x27</code> SEND_SOCK_MSG</a></li>
<li><a href="specs/kernel/syscalls.html#0x28-read_sock_msg"><code>0x28</code> READ_SOCK_MSG</a></li>
<li><a href="specs/kernel/syscalls.html#0x29-close_serv_sock"><code>0x29</code> CLOSE_SERV_SOCK</a></li>
<li><a href="specs/kernel/syscalls.html#0x2a-connect_service"><code>0x2A</code> CONNECT_SERVICE</a></li>
<li><a href="specs/kernel/syscalls.html#0x2b-end_service_conn"><code>0x2B</code> END_SERVICE_CONN</a></li>
<li><a href="specs/kernel/syscalls.html#0x2c-accept_service_conn"><code>0x2C</code> ACCEPT_SERVICE_CONN</a></li>
<li><a href="specs/kernel/syscalls.html#0x2d-reject_service_conn"><code>0x2D</code> REJECT_SERVICE_CONN</a></li>
<li><a href="specs/kernel/syscalls.html#0x30-mem_alloc"><code>0x30</code> MEM_ALLOC</a></li>
<li><a href="specs/kernel/syscalls.html#0x31-mem_free"><code>0x31</code> MEM_FREE</a></li>
<li><a href="specs/kernel/syscalls.html#0x32-virt_mem_ams"><code>0x32</code> VIRT_MEM_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x33-backed_ams"><code>0x33</code> BACKED_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x34-device_ams"><code>0x34</code> DEVICE_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x35-share_ams"><code>0x35</code> SHARE_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x36-ams_sharing_info"><code>0x36</code> AMS_SHARING_INFO</a></li>
<li><a href="specs/kernel/syscalls.html#0x37-unshare_ams"><code>0x37</code> UNSHARE_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x38-map_ams"><code>0x38</code> MAP_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x39-unmap_ams"><code>0x39</code> UNMAP_AMS</a></li>
<li><a href="specs/kernel/syscalls.html#0x3a-set_dma_mem_access"><code>0x3A</code> SET_DMA_MEM_ACCESS</a></li>
<li><a href="specs/kernel/syscalls.html#0xa0-execution_context"><code>0xA0</code> EXECUTION_CONTEXT</a></li>
<li><a href="specs/kernel/syscalls.html#0xd0-process_attributes"><code>0xD0</code> PROCESS_ATTRIBUTES</a></li>
<li><a href="specs/kernel/syscalls.html#0xd1-set_priority"><code>0xD1</code> SET_PRIORITY</a></li>
<li><a href="specs/kernel/syscalls.html#0xd2-enum_devices"><code>0xD2</code> ENUM_DEVICES</a></li>
<li><a href="specs/kernel/syscalls.html#0xd3-device_infos"><code>0xD3</code> DEVICE_INFOS</a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#technical-overview-1" id="technical-overview-1">Technical overview</a></h2>
<p>Syscalls are performed using CPU interruptions to notify the kernel.</p>
<p>A syscall is made of a 8-bit code, as well as up to 8 arguments with up to 64-bit value each.<br />
When performing a syscall, the process will put in a specific CPU register an address poiting to a memory address containing in a row the syscall's code and its arguments. For most syscalls, code and arguments will be not be longer than 128 bits, but some may use larger arguments.</p>
<p>Some syscalls require the process to send a buffer of data. In such case, the process simply provides a pointer to the said buffer - so the argument's size will vary depending on the length of memory addresses.</p>
<p>After preparing the syscall's code and arguments, the process raises a specific exception that is caught by the kernel. When the syscall is complete, the kernel puts the result values in specific registers and resumes the process. This means that <strong>all syscalls are synchronous</strong>.</p>
<p>System calls always return two numbers: a 8-bit one (errcode) and a 8 bytes one (return value). If the errcode is not null, then an error occured during the syscall. The specific value indicate the encountered type of error:</p>
<ul>
<li><code>0x00</code>: cannot read syscall's code or arguments (error while reading memory)</li>
<li><code>0x01</code>: the requested syscall does not exist</li>
<li><code>0x02</code>: at least one argument is invalid (e.g. providing a pointer to the <code>0</code> address)</li>
<li><code>0x03</code>: unmapped memory pointer (e.g. provided a pointer to a memory location that is not mapped yet)</li>
<li><code>0x04</code>: memory permission error (e.g. provided a writable buffer to an allocated but non-writable memory address)</li>
</ul>
<p>Errors are encoded this way:</p>
<ul>
<li><code>0x00</code> to <code>0x0F</code>: generic errors (see above)</li>
<li><code>0x10</code> to <code>0x1F</code>: invalid arguments provided (e.g. value is too high)</li>
<li><code>0x20</code> to <code>0x2F</code>: arguments are not valid in the current context (e.g. provided ID does not exist)</li>
<li><code>0x30</code> to <code>0x3F</code>: resource errors (e.g. file not found)</li>
<li><code>0x40</code> to <code>0xFF</code>: other types of errors</li>
</ul>
<p>System calls' code are categorized as follows:</p>
<ul>
<li><code>0x00</code> to <code>0x0F</code>: signal handling</li>
<li><code>0x10</code> to <code>0x1F</code>: process management</li>
<li><code>0x20</code> to <code>0x29</code>: pipes</li>
<li><code>0x2A</code> to <code>0x2F</code>: services communication</li>
<li><code>0x30</code> to <code>0x3F</code>: memory management</li>
<li><code>0xA0</code> to <code>0xAF</code>: applications-related syscalls</li>
<li><code>0xD0</code> to <code>0xDF</code>: reserved to system services</li>
</ul>
<p>Note that advanced actions like permissions management or filesystem access are achieved through the use of <a href="specs/kernel/ipc.html">IPC</a>.</p>
<h2><a class="header" href="#list-of-syscalls" id="list-of-syscalls">List of syscalls</a></h2>
<p>You can find below the exhaustive list of system calls.</p>
<h3><a class="header" href="#0x01-handle_signal" id="0x01-handle_signal"><code>0x01</code> HANDLE_SIGNAL</a></h3>
<p>Register a <a href="specs/kernel/signals.html">signal handler</a>.<br />
If the address pointed by this syscall's is not executable by the current process when this signal is sent to the process, the signal will be converted to an <a href="specs/kernel/signals.html#0x01-handler_fault"><code>HANDLER_FAULT</code></a> signal instead.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Code of the signal to handle (1 byte)</li>
<li>Pointer to the handler function (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>Empty</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The requested signal does not exist</li>
</ul>
<h3><a class="header" href="#0x02-unhandle_signal" id="0x02-unhandle_signal"><code>0x02</code> UNHANDLE_SIGNAL</a></h3>
<p>Unregister a signal handler, falling back to the default signal reception behaviour if this signal is sent to the process.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Code of the signal to stop handling (1 byte)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>Empty</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The requested signal does not exist</li>
<li><code>0x20</code>: The requested signal does not have an handler</li>
</ul>
<h3><a class="header" href="#0x03-is_signal_handled" id="0x03-is_signal_handled"><code>0x03</code> IS_SIGNAL_HANDLED</a></h3>
<p>Check if a signal has a registered handler.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Code of the signal (1 byte)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li><code>0</code> if the signal is not handled, <code>1</code> if it is (1 byte)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The requested signal does not exist</li>
</ul>
<h3><a class="header" href="#0x04-ready" id="0x04-ready"><code>0x04</code> READY</a></h3>
<p>Indicate the system this process has set up all its event listeners, so it can start dequeuing <a href="specs/kernel/signals.html">signals</a>.</p>
<p><strong>NOTE:</strong> When this signal is sent, all queued signals will be treated at once, so the instructions following the sending of this signal may not be ran until quite a bit of time in the worst scenario.</p>
<p><strong>WARNING:</strong> Signals will not be treated until this syscall is sent by the process!</p>
<p><strong>Arguments:</strong></p>
<p><em>None</em></p>
<p><strong>Return value:</strong></p>
<p><em>Empty</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: The process already told it was ready</li>
</ul>
<h3><a class="header" href="#0x10-get_pid" id="0x10-get_pid"><code>0x10</code> GET_PID</a></h3>
<p>Get the current process' PID.</p>
<p><strong>Arguments:</strong></p>
<p><em>None</em></p>
<p><strong>Return value:</strong></p>
<ul>
<li>Current process' PID (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<p><em>None</em></p>
<h3><a class="header" href="#0x12-suspend" id="0x12-suspend"><code>0x12</code> SUSPEND</a></h3>
<p><a href="specs/kernel/../../features/balancer.html#application-processes-suspension">Suspend</a> the current process.</p>
<p><strong>Arguments:</strong></p>
<p><em>None</em></p>
<p><strong>Return value:</strong></p>
<ul>
<li>Amount of time the process was suspended, in milliseconds (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: the current process is not an application process</li>
</ul>
<h3><a class="header" href="#0x13-exit" id="0x13-exit"><code>0x13</code> EXIT</a></h3>
<p>Kill the current process.</p>
<p>A <a href="specs/kernel/signals.html#0x2b-service_client_closed"><code>SERVICE_CLIENT_CLOSED</code></a> signal is sent to all services connection the process has.<br />
If the current process is a service, a <a href="specs/kernel/signals.html#0x2d-service_server_quitted"><code>SERVICE_SERVER_QUITTED</code></a> signal is sent to all active clients.</p>
<p><strong>Arguments:</strong></p>
<p><em>None</em></p>
<p><strong>Return value:</strong></p>
<p><em>None</em> (never returns)</p>
<p><strong>Errors:</strong></p>
<p><em>None</em></p>
<h3><a class="header" href="#0x20-open_pipe" id="0x20-open_pipe"><code>0x20</code> OPEN_PIPE</a></h3>
<p>Open a pipe with a process of the same application and running under the same user and get its SC.<br />
The buffer size multiplier indicates the size of the pipe's buffer, multiplied by 64 KB. The default (<code>0</code>) falls back to a size of 64 KB.<br />
The command code can be used to indicate to the target process which action is expected from it. It does not follow any specific format.<br />
The target process will receive the SC/RC's counterpart through the <a href="specs/kernel/signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal, unless notification mode states otherwise.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Target process' PID (8 bytes)</li>
<li>Command code (2 bytes)</li>
<li>Pipe type (1 byte): <code>0x00</code> to create a write pipe, <code>0x01</code> to create a read pipe</li>
<li>Buffer size multiplier (1 byte)</li>
<li>Transmission mode (1 byte): <code>0x00</code> to create a raw pipe, <code>0x01</code> to create a message pipe</li>
<li>Notification mode (1 byte): <code>0x00</code> to notify the process with the <a href="specs/kernel/signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal, <code>0x01</code> to skip it</li>
<li>Size hint in bytes (8 bytes), with <code>0</code> being the 'no size hint' value</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> SC identifier (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid transmission mode provided</li>
<li><code>0x11</code>: Invalid notification mode provided</li>
<li><code>0x20</code>: The provided PID does not exist</li>
<li><code>0x21</code>: The target process is not part of this application</li>
<li><code>0x22</code>: The target process runs under another user</li>
<li><code>0x23</code>: Notification mode is enabled but the target process does not have a handler registered for the <a href="specs/kernel/signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal</li>
</ul>
<h3><a class="header" href="#0x21-send_pipe" id="0x21-send_pipe"><code>0x21</code> SEND_PIPE</a></h3>
<p>Share an RC or SC identifier with another process.<br />
This will trigger in the target process the <a href="specs/kernel/signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal, unless the notification mode tells otherwise.</p>
<p>When the target process writes through the received SC or read from the received RC, the performance will be equal to writing or reading through the original RC/SC identifier.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> RC or SC identifier (8 bytes)</li>
<li>Target PID (8 bytes)</li>
<li>Notification mode (1 byte): <code>0x00</code> to notify the process with a pipe reception signal, <code>0x01</code> to skip the signal</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Notification mode is enabled but the target process does not have a handler registered for the <a href="specs/kernel/signals.html#0x20-recv_pipe"><code>RECV_PIPE</code></a> signal</li>
</ul>
<h3><a class="header" href="#0x22-pipe_write" id="0x22-pipe_write"><code>0x22</code> PIPE_WRITE</a></h3>
<p>Write data through a pipe.<br />
Messages will always be sent at once when writing to message pipes.<br />
If the data is 0-byte long, this pipe will return successfully without waiting, even if the target pipe's buffer is full or locked.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> SC identifier (8 bytes)</li>
<li>Number of bytes to write (4 bytes)</li>
<li>Pointer to a readable buffer (8 bytes)</li>
<li>Mode (1 byte): <code>0x00</code> = block until there is enough space to write, <code>0x01</code> = fail if there is not enough space to write or if the pipe is locked, <code>0x02</code> = write as much as possible</li>
</ul>
<p><strong>Return value:</strong></p>
<p>Encoded on 4 bytes:</p>
<ul>
<li>If mode is <code>0x00</code>: remaining capacity of the pipe</li>
<li>If mode is <code>0x01</code>: <code>0x00</code> if the cause of failure was because the pipe was locked, <code>0x01</code> if it was because of of a lack of space in the target buffer</li>
<li>If mode is <code>0x02</code>: number of bytes written</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid mode provided</li>
<li><code>0x20</code>: The provided SC identifier does not exist</li>
<li><code>0x21</code>: The provided SC was already closed</li>
<li><code>0x22</code>: The provided SC refers to a message pipe but the provided size is larger than 64 KB</li>
<li><code>0x23</code>: The provided SC refers to a message pipe but the <code>0x02</code> mode was provided</li>
<li><code>0x30</code>: There is not enough space in the pipe to write all the provided data and the mode argument was set to <code>0x01</code></li>
</ul>
<h3><a class="header" href="#0x23-pipe_read" id="0x23-pipe_read"><code>0x23</code> PIPE_READ</a></h3>
<p>Read pending data or message from a pipe.<br />
If the pipe was closed while the buffer was not empty, this syscall will still be able to read the remaining buffer's data - but the pipe will not be able to receive any additional data. Then, once the buffer is empty, the pipe will be made unavailable.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> RC identifier (8 byte)</li>
<li>Mode (1 byte): <code>0x00</code> = block until there are enough data to read, <code>0x01</code> = fail if there is not enough data to read or if the pipe is locked, <code>0x02</code> = read as much as possible</li>
<li>Number of bytes to read (4 bytes): <code>0</code> = read as much data as possible</li>
<li>Pointer to a writable buffer (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p>Encoded on 4 bytes:</p>
<ul>
<li>If mode is <code>0x00</code>: remaining bytes in the buffer</li>
<li>If mode is <code>0x01</code>: <code>0x00</code> if the cause of failure was because the pipe was locked, <code>0x01</code> if it was because of of a lack of space in the target buffer</li>
<li>If mode is <code>0x02</code>: number of read bytes</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid mode provided</li>
<li><code>0x20</code>: The provided RC identifier does not exist</li>
<li><code>0x21</code>: The provided RC was already closed</li>
<li><code>0x22</code>: There is no pending data in the pipe and the mode argument was set to <code>0x01</code></li>
<li><code>0x23</code>: The provided RC refers to a message pipe but the <code>0x02</code> mode was provided</li>
</ul>
<h3><a class="header" href="#0x24-pipe_info" id="0x24-pipe_info"><code>0x24</code> PIPE_INFO</a></h3>
<p>Get informations on a pipe from its RC or SC identifier.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> RC or SC identifier (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Status (1 byte):
<ul>
<li>Bit 0 (strongest): indicates if the pipe is opened</li>
<li>Bit 1: indicates if the pipe is a message pipe</li>
<li>Bit 2: indicates if the pipe's buffer is full</li>
<li>Bit 3: indicates if the pipe is locked</li>
<li>Bit 4: indicates if a writing request is pending (waiting for the pipe to be unlocked)</li>
<li>Bit 5: indicates if a reading request is pending (waiting for the pipe to be unlocked)</li>
<li>Bit 6: indicates if the provided identifier is an SC</li>
</ul>
</li>
<li>Pipe's buffer's capacity (8 bytes)</li>
<li>Remaining data before the pipe's buffer is full (8 bytes)</li>
<li>Pipe's creator's PID (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<p><em>None</em></p>
<h3><a class="header" href="#0x25-close_pipe" id="0x25-close_pipe"><code>0x25</code> CLOSE_PIPE</a></h3>
<p>Close a pipe properly. The RC and SC parts will be immediatly closed.<br />
The other process this pipe was shared with will receive the <a href="specs/kernel/signals.html#0x21-pipe_closed"><code>PIPE_CLOSED</code></a> signal unless this pipe was created during a <a href="specs/kernel/syscalls.html#0x2c-accept_service_conn">service connection</a>.<br />
If this syscall is not performed on a pipe before the process exits, the other process will receive the same signal with a specific argument to indicate the communication was brutally interrupted.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> RC or SC identifier (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The provided RC/SC identifier does not exist</li>
<li><code>0x11</code>: The target process already terminated</li>
<li><code>0x20</code>: The provided RC/SC identifier is part of a service pipe</li>
</ul>
<h3><a class="header" href="#0x26-open_serv_sock" id="0x26-open_serv_sock"><code>0x26</code> OPEN_SERV_SOCK</a></h3>
<p>Open a <a href="specs/kernel/ipc.html#service-sockets">service socket</a>.<br />
Triggers the <a href="specs/kernel/signals.html#0x26-recv_serv_sock"><code>RECV_SERV_SOCK</code></a> signal on the receiver process' side.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Client process PID (8 bytes)</li>
<li>Buffer size multiplier by 4 KB (2 bytes) - <code>0</code> fall backs to 4KB</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Socket identifier (8 bytes)</li>
</ul>
<h3><a class="header" href="#0x27-send_sock_msg" id="0x27-send_sock_msg"><code>0x27</code> SEND_SOCK_MSG</a></h3>
<p>Send a message through a <a href="specs/kernel/ipc.html#exchanges-and-messages">service socket exchange</a>.<br />
This syscall can also be used to create a new exchange.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Socket identifier (8 bytes)</li>
<li>Exchange identifier (8 bytes) - <code>0</code> creates a new exchange</li>
<li>Method or notification code (1 byte) - non-zero value if not creating an exchange to close it with a non-error message</li>
<li>Error code (2 bytes)</li>
<li>Number of bytes to write (4 bytes)</li>
<li>Pointer to the message's content (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Exchange identifier (8 bytes)</li>
<li>Message counter for this exchange (4 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Unknown socket identifier</li>
<li><code>0x21</code>: Socket is already closed</li>
<li><code>0x22</code>: Unknown exchange identifier</li>
<li><code>0x23</code>: Exchange has already been concluded</li>
</ul>
<h3><a class="header" href="#0x28-read_sock_msg" id="0x28-read_sock_msg"><code>0x28</code> READ_SOCK_MSG</a></h3>
<p>Read the pending message of a <a href="specs/kernel/ipc.html#service-sockets">service socket</a>.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Socket identifier (8 bytes)</li>
<li>Address of a writable buffer (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Number of written bytes (4 bytes)</li>
<li><code>0x01</code> if a message was retrieved, <code>0x00</code> if none was pending (1 byte)</li>
<li>Status (1 byte):
<ul>
<li>Bit 0: set if this message did create a new exchange</li>
<li>Bit 1: set if this message is an error message</li>
<li>Bit 2: set if this message closed the socket</li>
</ul>
</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Unknown socket identifier</li>
<li><code>0x21</code>: Socket is already closed</li>
<li><code>0x22</code>: Unknown exchange identifier</li>
<li><code>0x23</code>: Exchange has already been concluded</li>
</ul>
<h3><a class="header" href="#0x29-close_serv_sock" id="0x29-close_serv_sock"><code>0x29</code> CLOSE_SERV_SOCK</a></h3>
<p>Close a <a href="specs/kernel/ipc.html#service-sockets">service socket</a>.<br />
Triggers the <a href="specs/kernel/signals.html#0x29-serv_sock_closed"><code>SERV_SOCK_CLOSED</code></a> signal on the receiver process' side.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Socket identifier (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Unknown socket identifier</li>
<li><code>0x21</code>: Socket is already closed</li>
</ul>
<h3><a class="header" href="#0x2a-connect_service" id="0x2a-connect_service"><code>0x2A</code> CONNECT_SERVICE</a></h3>
<p>Ask a service to etablish connection. The current process is called the service's <em>client</em>.</p>
<p>If the current process already has an active connection (a connection that hasn't been closed) to the target service, it will fail unless the flexible mode argument is set.</p>
<p><strong>NOTE:</strong> When this signal is sent, the service's answer will be waited, so the instructions following the sending of this signal may not be ran until several seconds in the worst scenario.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Target application's <a href="specs/kernel/../../concepts/applications.html#application-identifier">ANID</a> (4 bytes)</li>
<li>Command code (2 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Unique connection ID (8 bytes)</li>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> SC identifier (8 bytes)</li>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> RC identifier (8 bytes)</li>
<li>Flexible mode (1 byte): <code>0x00</code> by default, <code>0x01</code> returns the existing connection ID an active connection is already in place with the service</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid flexible mode provided</li>
<li><code>0x20</code>: The provided ANID does not exist</li>
<li><code>0x21</code>: Target application does not <a href="specs/kernel/../../concepts/applications.html#services">expose a service</a></li>
<li><code>0x22</code>: Current process already has an active connection to the target service and flexible mode is not set</li>
<li><code>0x30</code>: Failed to send the <a href="specs/kernel/signals.html#0x2a-service_conn_request"><code>SERVICE_CONN_REQUEST</code></a> due to a <a href="specs/kernel/signals.html#0x01-handler_fault">double handler fault</a></li>
<li><code>0x31</code>: Service rejected the connection request</li>
</ul>
<h3><a class="header" href="#0x2b-end_service_conn" id="0x2b-end_service_conn"><code>0x2B</code> END_SERVICE_CONN</a></h3>
<p>Tell a service to properly close the connection. The associated <a href="specs/kernel/ipc.html#pipes">pipe</a> SC and RC channels will immediatly be closed.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Unique connection ID (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The provided connection ID does not exist</li>
<li><code>0x20</code>: This connection was already closed</li>
<li><code>0x21</code>: The associated service thread already terminated</li>
</ul>
<h3><a class="header" href="#0x2c-accept_service_conn" id="0x2c-accept_service_conn"><code>0x2C</code> ACCEPT_SERVICE_CONN</a></h3>
<p>Confirm the current service accepts the connection with a client.<br />
A dedicated message pipe's SC and another's RC will be provided to communicate with the client.</p>
<p>This will create a new <a href="specs/kernel/../services.html#thread-types">client thread</a> in the current process, which is meant to be dedicated to this specific client.<br />
The client thread will not receive any <a href="specs/kernel/signals.html#0x2a-service_conn_request"><code>SERVICE_CONN_REQUEST</code></a> signal, only <a href="specs/kernel/../services.html#thread-types">dispatcher thread</a> will.</p>
<p>When the associated client terminates, the <a href="specs/kernel/signals.html#0x2b-service_client_closed"><code>SERVICE_CLIENT_CLOSED</code></a> signal is sent to this thread.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Connection's unique request ID (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li><code>0x00</code> if the current process is now the associated client's thread, <code>0x01</code> else</li>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> RC identifier (8 bytes)</li>
<li><a href="specs/kernel/ipc.html#pipes">Pipe</a> SC identifier (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: This request ID does not exist</li>
<li><code>0x20</code>: The process which requested the connection already terminated</li>
<li><code>0x30</code>: Answer was given after the delay set in the <a href="specs/kernel/../registry.html">registry</a>'s <code>system.signals.service_answer_delay</code> key (default: 1000ms)</li>
</ul>
<h3><a class="header" href="#0x2d-reject_service_conn" id="0x2d-reject_service_conn"><code>0x2D</code> REJECT_SERVICE_CONN</a></h3>
<p>Reject a connection request to the current service.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Connection's unique request ID (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: This request ID does not exist</li>
<li><code>0x20</code>: The process which requested the connection already terminated</li>
<li><code>0x30</code>: Answer was given after the delay set in the <a href="specs/kernel/../registry.html">registry</a>'s <code>system.signals.service_answer_delay</code> key (default: 1000ms)</li>
</ul>
<h3><a class="header" href="#0x30-mem_alloc" id="0x30-mem_alloc"><code>0x30</code> MEM_ALLOC</a></h3>
<p>Allocate a linear block of memory.</p>
<p><strong>WARNING:</strong> Allocated memory will not be rewritten, thus it may contain non-zero data. Therefore the caller process shall ensure memory is used correctly.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>The number of <a href="specs/kernel/memory.html#pages">pages</a> to allocate (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Pointer to the newly-allocated block of memory (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x30</code>: The kernel could not find a linear block of memory of the requested size</li>
</ul>
<h3><a class="header" href="#0x31-mem_free" id="0x31-mem_free"><code>0x31</code> MEM_FREE</a></h3>
<p>Unallocate a linear block of memory.</p>
<p>Shared memory pages must first be unshared through the <a href="specs/kernel/syscalls.html#0x37-unshare_ams"><code>UNSHARE_AMS</code></a> syscall.<br />
Mapped memory pages must be unmapped through the <a href="specs/kernel/syscalls.html#0x39-unmap_ams"><code>UNMAP_AMS</code></a> syscall.</p>
<p><strong>WARNING:</strong> Memory will not be zeroed, therefore the caller process shall ensure critical informations are zeroed or randomized before freeing the memory.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Pointer to the start address to unallocate the memory from (8 bytes)</li>
<li>The number of <a href="specs/kernel/memory.html#pages">pages</a> to unallocate (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The provided start address it not aligned with a page</li>
<li><code>0x20</code>: The provided start address is out of the process' range</li>
<li><code>0x21</code>: The provided size, added to the start address, would exceed the process' range</li>
<li><code>0x22</code>: One or more of the provided pages was not allocated (e.g. unmapped page or memory-mapped page)</li>
<li><code>0x23</code>: One or more of the provided pages are shared with another process</li>
</ul>
<h3><a class="header" href="#0x32-virt_mem_ams" id="0x32-virt_mem_ams"><code>0x32</code> VIRT_MEM_AMS</a></h3>
<p>Create an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> from a part of the current process' address space.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Address of the first page to register in the AMS (8 bytes)</li>
<li>Number of bytes to register (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>AMS ID (4 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Start address is unaligned</li>
<li><code>0x11</code>: Number of bytes is unaligned</li>
<li><code>0x22</code>: Address is out of range</li>
</ul>
<h3><a class="header" href="#0x33-backed_ams" id="0x33-backed_ams"><code>0x33</code> BACKED_AMS</a></h3>
<p>Create an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> backed by the <a href="specs/kernel/signals.html#0x33-read_backed_ams"><code>READ_BACKED_AMS</code></a> and <a href="specs/kernel/signals.html#0x34-write_backed_ams"><code>WRITE_BACKED_AMS</code></a> signals.</p>
<p>Copy-on-write support can be enabled to allow the receiver process to write data in its own memory space. Written pages will be allocated by the kernel and won't be backed anymore by the <a href="specs/kernel/signals.html#0x33-read_backed_ams"><code>READ_BACKED_AMS</code></a> signal. The backer process won't be able to see these changes, and the <a href="specs/kernel/signals.html#0x34-write_backed_ams"><code>WRITE_BACKEND_AMS</code></a> signal won't be trigerred on its side.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Length of the AMS (8 bytes)</li>
<li>Copy-on-write mode (1 byte): <code>0x00</code> to disable, <code>0x01</code> to enable</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid COW mode provided</li>
<li><code>0x11</code>: Provided length is unaligned</li>
</ul>
<h3><a class="header" href="#0x34-device_ams" id="0x34-device_ams"><code>0x34</code> DEVICE_AMS</a></h3>
<p>Create an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> from a device's memory through <em>Mapped Memory Input/Output</em> (MMIO).</p>
<p>Requires the current process to have the device in its <a href="specs/kernel/processes.html#drivable-devices">drivable devices attribute</a>.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/hardware.html#session-device-identifier">SDI</a> of the device to map in memory (4 bytes)</li>
<li>Start address in the device's memory (8 bytes)</li>
<li>Number of bytes to map (8 bytes)</li>
<li>Start address to map in this process' memory (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The mapping's start address is not aligned with a page</li>
<li><code>0x11</code>: The mapping's length is not a multiple of a page's size</li>
<li><code>0x12</code>: The mapping's size is null (0 bytes)</li>
<li><code>0x20</code>: The provided device SDI was not found</li>
<li><code>0x21</code>: The provided device is not compatible with MMIO</li>
<li><code>0x22</code>: This device is not registered in this process' <a href="specs/kernel/processes.html#drivable-devices">drivable devices attribute</a></li>
</ul>
<h3><a class="header" href="#0x35-share_ams" id="0x35-share_ams"><code>0x35</code> SHARE_AMS</a></h3>
<p>Share an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> with another process.</p>
<p>This will trigger in the target process the <a href="specs/kernel/signals.html#0x35-recv_shared_ams"><code>RECV_SHARED_MEM</code></a> with the provided command code, unless the notification mode states otherwise.</p>
<p>The <em>mutual mode</em> allows both processes to access the memory, with the sharer setting the permissions for the receiver to limit its access. Copy-on-write can also be enabled to allow the receiver process to write data without affecting the sharer process' memory.</p>
<p>The <em>exclusive mode</em> allows, only when sharing AMS <a href="specs/kernel/syscalls.html#0x32-virt_mem_ams">made from existing memory pages</a> from its original process, to unmap the original pages from the said process to let the exclusive access to the target process. This is useful when transferring temporarily large chunks of data to another process. Also, access permissions are ignored when using exclusive mode.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Target process' PID (8 bytes)</li>
<li>Command code (2 bytes)</li>
<li>Notification mode (1 byte): <code>0x00</code> to notify the process with the <a href="specs/kernel/signals.html#0x35-recv_shared_ams"><code>RECV_SHARED_AMS</code></a> signal, <code>0x01</code> to skip it</li>
<li>Mode (1 byte):
<ul>
<li>Mutual: <code>0 b 0 0 0 0 &lt;1 to enable copy-on-write&gt; &lt;1 to enable read&gt; &lt;1 to enable write&gt; &lt;1 to enable exec&gt;</code></li>
<li>Exclusive: <code>0 b 0 0 0 0 1 0 0 &lt;1 to unmap original pages&gt;</code></li>
</ul>
</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid notification mode provided</li>
<li><code>0x11</code>: Invalid mode provided</li>
<li><code>0x12</code>: Access permissions were not set but the sharing mode is set to mutual</li>
<li><code>0x13</code>: Access permissions were provided but the sharing mode is set to exclusive</li>
<li><code>0x14</code>: Invalid exclusive mode provided</li>
<li><code>0x30</code>: There is not enough contiguous space in the receiver process' memory space to map the shared memory</li>
</ul>
<h3><a class="header" href="#0x36-ams_sharing_info" id="0x36-ams_sharing_info"><code>0x36</code> AMS_SHARING_INFO</a></h3>
<p>Get informations about a <a href="specs/kernel/syscalls.html#0x35-share_ams">shared</a> <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a>.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Sharer process' PID (8 bytes)</li>
<li>Receiver process' PID (8 bytes)</li>
<li>Sharing mode (1 byte): <code>0x00</code> for mutual mode, <code>0x01</code> for exclusive mode</li>
<li>Shared buffer's start address (8 bytes)</li>
<li>Sharer buffer's length (8 bytes)</li>
<li>Command code (2 bytes)</li>
<li>Access permissions (1 byte): for mutual sharings, strongest bit for read, next for write, next for exec ; for exclusive sharings, <code>0x00</code></li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Unknwon AMS ID provided</li>
</ul>
<h3><a class="header" href="#0x37-unshare_ams" id="0x37-unshare_ams"><code>0x37</code> UNSHARE_AMS</a></h3>
<p>Stop sharing an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> started by <a href="specs/kernel/syscalls.html#0x35-share_ams"><code>SHARE_AMS</code></a>. Note that exlusive sharings cannot be unmapped.</p>
<p>This will trigger in the target process the <a href="specs/kernel/signals.html#0x37-unshared_ams"><code>UNSHARED_AMS</code></a> signal.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
<li>PID to stop sharing with (8 bytes) - <code>0</code> to stop sharing with all processes</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Unknown AMS ID provided</li>
<li><code>0x20</code>: Provided AMS ID is exclusive</li>
<li><code>0x21</code>: Provided AMS was not shared with the provided process</li>
</ul>
<h3><a class="header" href="#0x38-map_ams" id="0x38-map_ams"><code>0x38</code> MAP_AMS</a></h3>
<p>Map an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> in the current process' address space.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
<li>Start mapping address in the AMS (8 bytes)</li>
<li>Address to map the AMS (8 bytes)</li>
<li>Number of bytes to map (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Unknown AMS ID provided</li>
<li><code>0x20</code>: Provided mapping address or address+length is out-of-range in the AMS</li>
<li><code>0x21</code>: Provided address to map or address+length is out-of-orange in this process' address space</li>
</ul>
<h3><a class="header" href="#0x39-unmap_ams" id="0x39-unmap_ams"><code>0x39</code> UNMAP_AMS</a></h3>
<p>Unmap an <a href="specs/kernel/memory.html#abstract-memory-segments">abstract memory segment (AMS)</a> from the current process' address space.<br />
If the AMS is mapped at multiple addresses of this process, only one of the mappings will be unmapped by default.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>AMS ID (8 bytes)</li>
<li>Mapping address (8 bytes) - <code>0</code> to unmap from all addresses</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>Empty</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Unknown AMS ID provided</li>
<li><code>0x20</code>: Provided AMS it not mapped at this address</li>
</ul>
<h3><a class="header" href="#0x3a-set_dma_mem_access" id="0x3a-set_dma_mem_access"><code>0x3A</code> SET_DMA_MEM_ACCESS</a></h3>
<p>Allow or disallow a device to access a range of addresses through <em>Direct Memory Access</em> (DMA) in the current process' address space.</p>
<p>Requires the current process to have the device in its <a href="specs/kernel/processes.html#drivable-devices">drivable devices attribute</a>.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/hardware.html#session-device-identifier">SDI</a> of the device to map in memory (4 bytes)</li>
<li>Start address in the current process' address space (8 bytes)</li>
<li>Length (8 bytes)</li>
<li>Authorization (1 byte): <code>0x00</code> to allow the device to use this range, <code>0x01</code> to cancel an authorization</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: The range's start address is not aligned with a page</li>
<li><code>0x11</code>: The range's length is not a multiple of a page's size</li>
<li><code>0x12</code>: The range's size is null (0 bytes)</li>
<li><code>0x20</code>: The provided device SDI was not found</li>
<li><code>0x21</code>: The provided device is not compatible with DMA</li>
<li><code>0x22</code>: This device is not registered in this process' <a href="specs/kernel/processes.html#drivable-devices">drivable devices attribute</a></li>
</ul>
<h3><a class="header" href="#0xa0-execution_context" id="0xa0-execution_context"><code>0xA0</code> EXECUTION_CONTEXT</a></h3>
<p>Get informations from the application's <a href="specs/kernel/../applications/context.html">execution context</a>.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>
<p>Information to get (1 byte):</p>
<ul>
<li><code>0x00</code>: all the context</li>
<li><code>0x01</code>: startup reason</li>
<li><code>0x02</code>: context header</li>
<li><code>0x03</code>: command-line arguments</li>
</ul>
</li>
<li>
<p>Pointer to a writable buffer (8 bytes)</p>
</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Number of written bytes (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: invalid information number provided</li>
<li><code>0x20</code>: caller process is a system service</li>
</ul>
<h3><a class="header" href="#0xd0-process_attributes" id="0xd0-process_attributes"><code>0xD0</code> PROCESS_ATTRIBUTES</a></h3>
<p>System service-only syscall.<br />
Get a process' <a href="specs/kernel/processes.html#process-attributes">attributes</a>.</p>
<p><strong>Arguments:</strong></p>
<p><em>For value-based attributes:</em></p>
<ul>
<li>
<p>Attribute code (1 byte):</p>
<ul>
<li><code>0x00</code>: PID</li>
<li><code>0x01</code>: Process' priority</li>
<li><code>0x02</code>: Running user's ID</li>
<li><code>0x03</code>: Parent application ID</li>
<li><code>0x04</code>: Execution context (startup reason)</li>
<li><code>0x05</code>: Execution context (header)</li>
<li><code>0x06</code>: Execution context (arguments)</li>
</ul>
</li>
<li>
<p>Action code:</p>
<ul>
<li><code>0x00</code>: Read the information (followed by a writable address on 8 bytes)</li>
<li><code>0x01</code>: Write the information (followed by the value to write)</li>
</ul>
</li>
</ul>
<p><em>For list-based attributes:</em></p>
<ul>
<li>
<p>Attribute code (1 byte):</p>
<ul>
<li><code>0x00</code>: Memory mappings</li>
<li><code>0x01</code>: Permissions</li>
<li><code>0x02</code>: Drivable devices</li>
</ul>
</li>
<li>
<p>Action code (1 byte) followed by its optional arguments:</p>
<ul>
<li><code>0x00</code>: Get the number of elements</li>
<li><code>0x01</code>: Get the value at a given index =&gt; index (4 bytes)</li>
<li><code>0x02</code>: Update the value at a given index =&gt; index (4 bytes) + value (? bytes)</li>
<li><code>0x03</code>: Insert a value at a given index =&gt; index (4 bytes) + value (? bytes)</li>
<li><code>0x04</code>: Push a value at the end of the list =&gt; value (? bytes)</li>
<li><code>0x05</code>: Remove a value from the list =&gt; index (4 bytes)</li>
<li><code>0x06</code>: Remove the last value from the list</li>
<li><code>0x10</code>: Check if the list contains a given item =&gt; value to look for (? bytes)</li>
</ul>
</li>
<li>
<p>Address to a writable buffer (8 bytes)</p>
</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Number of written bytes (if applies) (8 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid action code provided</li>
<li><code>0x11</code>: Invalid attribute number provided</li>
<li><code>0x20</code>: Caller process is not a system service</li>
<li><code>0x21</code>: This system service is not allowed to access or edit this attribute</li>
<li><code>0x22</code>: Provided index is out-of-bounds</li>
</ul>
<h3><a class="header" href="#0xd1-set_priority" id="0xd1-set_priority"><code>0xD1</code> SET_PRIORITY</a></h3>
<p>System service-only syscall.<br />
Set the priority of a process.<br />
If the set priority is different than <code>0</code>, the kernel won't adjust the priority automatically anymore.<br />
Setting it to <code>0</code> will reset it to the kernel's choice.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Process PID (8 bytes)</li>
<li>Priority to set (1 byte) with <code>0</code> to let the kernel set it automatically</li>
</ul>
<p><strong>Return value:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Provided priority is higher than <code>20</code></li>
<li><code>0x20</code>: Caller process is not a system service</li>
<li><code>0x21</code>: Provided PID was not found</li>
</ul>
<h3><a class="header" href="#0xd2-enum_devices" id="0xd2-enum_devices"><code>0xD2</code> ENUM_DEVICES</a></h3>
<p>System service-only syscall.<br />
List devices matching a provided CII.</p>
<p>For each device, its SDI (4 bytes) is written to the provided address.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/hardware.html#connection-interface-identifier">CII</a> of the devices to list (4 bytes)
<code>0</code> will list all devices</li>
<li>Address of a writable buffer (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Number of devices found with the provided criterias (4 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Invalid connection type in CII</li>
</ul>
<h3><a class="header" href="#0xd3-device_infos" id="0xd3-device_infos"><code>0xD3</code> DEVICE_INFOS</a></h3>
<p>System service-only syscall.<br />
Get the <a href="specs/kernel/hardware.html#raw-device-descriptor">raw device descriptor</a> of a single device.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/kernel/hardware.html#session-device-identifier">SDI</a> of the device to get informations from (4 bytes)</li>
<li>Address of a writable buffer (8 bytes)</li>
</ul>
<p><strong>Return value:</strong></p>
<ul>
<li>Number of written bytes (1 byte)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: No device was found with this SDI</li>
</ul>
<h1><a class="header" href="#system-services-2" id="system-services-2">System services</a></h1>
<p>As NightOS' <a href="specs/services/../kernel/README.html">kernel</a> is not monolithic but a microkernel, it only handles the most fundamental tasks of the system, like memory and processes management, as well as direct hardware communication.</p>
<p>The vast majority of its features can be found in the <a href="specs/services/../services.html">system service</a>, which special services run by the system itself under the <code>sys</code> <a href="specs/services/../../concepts/applications.html#application-identifier">DID</a>.</p>
<p>This splitting implies that most low-level features of the system are documented in the individual services' specifications documents, which you will find here.</p>
<h2><a class="header" href="#nomenclature" id="nomenclature">Nomenclature</a></h2>
<p>System services are referred to as the <code>sys::</code> services.</p>
<p>All <a href="specs/services/../kernel/ipc.html#methods-and-notifications">methods and notifications</a> describe the required permissions to use them, their arguments.</p>
<p>They also use common error codes:</p>
<ul>
<li><code>0x00</code>: cannot read syscall's code or arguments (error while reading memory)</li>
<li><code>0x01</code>: the requested syscall does not exist</li>
<li><code>0x02</code>: at least one argument is invalid (e.g. providing a pointer to the <code>0</code> address)</li>
<li><code>0x03</code>: unmapped memory pointer (e.g. provided a pointer to a memory location that is not mapped yet)</li>
<li><code>0x04</code>: memory permission error (e.g. provided a writable buffer to an allocated but non-writable memory address)</li>
<li><code>0x05</code>: insufficient permissions</li>
<li><code>0x10</code> to <code>0x1F</code>: invalid arguments provided (e.g. value is too high)</li>
<li><code>0x20</code> to <code>0x2F</code>: arguments are not valid in the current context (e.g. provided ID does not exist)</li>
<li><code>0x30</code> to <code>0x3F</code>: resource errors (e.g. file not found)</li>
<li><code>0x40</code> to <code>0xFF</code>: other types of errors</li>
</ul>
<p>All methods return an answer, though it may be empty (indicated by a <em>None</em>). System services' answers always <a href="specs/services/../kernel/ipc.html#concluding-exchanges">conclude the exchange</a>.</p>
<h2><a class="header" href="#list-of-system-services" id="list-of-system-services">List of system services</a></h2>
<ul>
<li><a href="specs/services/fs.html"><code>sys::fs</code></a>: filesystem management</li>
<li><a href="specs/services/hw.html"><code>sys::hw</code></a>: hardware communication</li>
<li><a href="specs/services/perm.html"><code>sys::perm</code></a>: permissions management</li>
<li><a href="specs/services/net.html"><code>sys::net</code></a>: network communications</li>
<li><a href="specs/services/crypto.html"><code>sys::crypto</code></a>: cryptography utilities</li>
<li><a href="specs/services/crashsave.html"><code>sys::crashsave</code></a>: <a href="specs/services/../../features/crash-saves.html">crash saves</a> management</li>
<li><a href="specs/services/flow.html"><code>sys::flow</code></a>: <a href="specs/services/../../specs/filesystem.html#flows">flows</a> management</li>
<li><a href="specs/services/hydre.html"><code>sys::hydre</code></a>: <a href="specs/services/../shell.html">Hydre</a> shell service</li>
</ul>
<h1><a class="header" href="#sysfs-service" id="sysfs-service"><code>sys::fs</code> service</a></h1>
<h2><a class="header" href="#methods-1" id="methods-1">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications" id="notifications">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#syshw-service" id="syshw-service"><code>sys::hw</code> service</a></h1>
<p>The <code>sys::hw</code> service is in charge of hardware devices. It coordinates and manages communications with the hardware.</p>
<ul>
<li><a href="specs/services/hw.html#hardware-detection">Hardware detection</a></li>
<li><a href="specs/services/hw.html#device-formats">Device formats</a>
<ul>
<li><a href="specs/services/hw.html#device-type-descriptor">Device type descriptor</a></li>
<li><a href="specs/services/hw.html#unique-device-identifier">Unique device identifier</a></li>
<li><a href="specs/services/hw.html#driver-device-descriptor">Driver device descriptor</a></li>
<li><a href="specs/services/hw.html#driven-device-type">Driven device type</a></li>
</ul>
</li>
<li><a href="specs/services/hw.html#normalization">Normalization</a>
<ul>
<li><a href="specs/services/hw.html#normalized-methods">Normalized methods</a></li>
<li><a href="specs/services/hw.html#normalized-interrupts">Normalized interrupts</a></li>
<li><a href="specs/services/hw.html#normalized-notifications">Normalized notifications</a></li>
<li><a href="specs/services/hw.html#patterns">Patterns</a></li>
</ul>
</li>
<li><a href="specs/services/hw.html#drivers">Drivers</a>
<ul>
<li><a href="specs/services/hw.html#a-note-on-performances">A note on performances</a></li>
</ul>
</li>
<li><a href="specs/services/hw.html#methods">Methods</a>
<ul>
<li><a href="specs/services/hw.html#0x01-enum_devices"><code>0x01</code> ENUM_DEVICES</a></li>
<li><a href="specs/services/hw.html#0x02-subscribe_devices"><code>0x02</code> SUBSCRIBE_DEVICES</a></li>
<li><a href="specs/services/hw.html#0x10-register_driver"><code>0x10</code> REGISTER_DRIVER</a></li>
<li><a href="specs/services/hw.html#0x11-unregister_driver"><code>0x11</code> UNREGISTER_DRIVER</a></li>
<li><a href="specs/services/hw.html#0x20-notify_process"><code>0x20</code> NOTIFY_PROCESS</a></li>
<li><a href="specs/services/hw.html#0xa0-ask_driver"><code>0xA0</code> ASK_DRIVER</a></li>
</ul>
</li>
<li><a href="specs/services/hw.html#notifications">Notifications</a>
<ul>
<li><a href="specs/services/hw.html#device_event"><code>DEVICE_EVENT</code></a></li>
<li><a href="specs/services/hw.html#device_interrupt"><code>DEVICE_INTERRUPT</code></a></li>
<li><a href="specs/services/hw.html#driver_method_request"><code>DRIVER_METHOD_REQUEST</code></a></li>
<li><a href="specs/services/hw.html#device_norm_notif"><code>DEVICE_NORM_NOTIF</code></a></li>
</ul>
</li>
</ul>
<h2><a class="header" href="#hardware-detection-1" id="hardware-detection-1">Hardware detection</a></h2>
<p>Hardware detection is handled by <a href="specs/services/../kernel/hardware.html#hardware-detection">the kernel itself</a>, which then exposes a <a href="specs/services/../kernel/hardware.html#raw-device-descriptor"><em>raw device descriptor</em> (RDD)</a> as well as a <a href="specs/services/../kernel/hardware.html#connection-interface-identifier"><em>connection interface identifier</em> (CII)</a> and a <a href="specs/services/../kernel/hardware.html#session-device-identifier"><em>session device identifier</em> (SDI)</a>.</p>
<h2><a class="header" href="#device-formats" id="device-formats">Device formats</a></h2>
<p>This section describes the multiple formats used by this service to deal with devices.</p>
<h3><a class="header" href="#device-type-descriptor" id="device-type-descriptor">Device type descriptor</a></h3>
<p>From the <a href="specs/services/../kernel/hardware.html#raw-device-descriptor">RDD</a> is derived the <em>device type descriptor</em> (DTD), which describes the device's type. Its composition and size depends on the connection type, but it varies from empty (0 byte) if the connection type guarantees no information, up to 256 bytes.</p>
<p><em><strong>The format remains to be determined but should be along the lines of a number-based equivalent of ModAlias, like :</strong></em></p>
<ul>
<li>PCI-Express:
<ul>
<li>Vendor (8 bytes)</li>
<li>Sub-vendor (8 bytes)</li>
<li>Type (8 bytes)</li>
<li>Sub-type (8 bytes)</li>
<li>...</li>
</ul>
</li>
<li>...</li>
</ul>
<h3><a class="header" href="#unique-device-identifier" id="unique-device-identifier">Unique device identifier</a></h3>
<p>It also derives a <em>unique device identifier</em> (UDI) encoded on 265 bytes, which is made of:</p>
<ul>
<li><a href="specs/services/../kernel/hardware.html#session-device-identifier">SDI</a> (4 bytes)</li>
<li><a href="specs/services/../kernel/hardware.html#connection-interface-identifier">CII</a> (4 bytes)</li>
<li>Size of the <a href="specs/services/hw.html#device-type-descriptor">DTD</a> (1 byte)</li>
<li><a href="specs/services/hw.html#device-type-descriptor">DTD</a> (256 bytes, weakest bits filled with zeros)</li>
</ul>
<h3><a class="header" href="#driver-device-descriptor" id="driver-device-descriptor">Driver device descriptor</a></h3>
<p>A <em>driver device descriptor</em> (DDD) is a data structure meant to be used by <a href="specs/services/hw.html#drivers">drivers</a>. It uses the following format:</p>
<ul>
<li>Bytes 000-264: Device's <a href="specs/services/hw.html#unique-device-identifier">UDI</a></li>
<li>Bytes 265-512: <em>Future-proof</em></li>
</ul>
<h3><a class="header" href="#driven-device-type" id="driven-device-type">Driven device type</a></h3>
<p>A <em>driven device type</em> (DDT), usually referred to as the <em>device type</em>, is generated by the <a href="specs/services/hw.html#drivers">driver</a> for each device is drives. This is a normalized value, used by the system to determine which actions can be performed through this device.</p>
<p>It's a 4-byte value, the strongest two bytes describing the <em>category</em> and the weakest two the <em>sub-category</em>.</p>
<p>The following list contains all possible values for DDTs, but is <strong>far from being complete yet</strong>. It will also grow over time as new device types appear on the market.</p>
<ul>
<li><code>0x0001</code>: Storage
<ul>
<li><code>0x0001</code>: Hard drive</li>
<li><code>0x0002</code>: SSD</li>
<li><code>0x0003</code>: USB flash drive</li>
<li><code>0x0004</code>: SD flash memory card</li>
</ul>
</li>
<li>...</li>
</ul>
<h2><a class="header" href="#normalization" id="normalization">Normalization</a></h2>
<h3><a class="header" href="#normalized-methods" id="normalized-methods">Normalized methods</a></h3>
<p>When a device is driven, other processes can ask this service to use <em>normalized methods</em>. These are methods that allow to perform a specific action or to receive <a href="specs/services/hw.html#normalized-notifications"><em>normalized notifications</em></a> about specific events of a specific device.</p>
<p>There are several methods, depending on the <a href="specs/services/hw.html#driven-device-type">device's type (DDT)</a>. Notifications differ as well.</p>
<p>The following list contains all methods and related notifications for all DDTs, but is <strong>far from being complete yet</strong>. It will also grow over time as new device types appear on the market and as existing devices evolve to provide new features.</p>
<p><strong>TODO</strong></p>
<h3><a class="header" href="#normalized-interrupts" id="normalized-interrupts">Normalized interrupts</a></h3>
<p>Some devices use interrupts to notify the system of a particular event. In such case, the interrupt is normalized to a format called the <em>normalized interrupt format</em>, which is then sent to the driver process using the <a href="specs/services/hw.html#device_event"><code>DEVICE_EVENT</code></a> notification.</p>
<p>The normalized interrupt format depends on the <a href="specs/services/hw.html#driven-device-type">device's type (DDT)</a>.</p>
<p>The following list contains all normalized interrupts for all DDTs, but is <strong>far from being complete yet</strong>. It will also grow over time as new device types appear on the market and as existing devices evolve to provide new features.</p>
<p><strong>TODO</strong></p>
<h3><a class="header" href="#normalized-notifications" id="normalized-notifications">Normalized notifications</a></h3>
<p>The <em>normalized notifications</em> are a type of notifications sent by a <a href="specs/services/hw.html#drivers">driver</a> to processes that subscribed to them using <a href="specs/services/hw.html#normalized-methods">normalized methods</a>. They are derived from the device's interrupts and events pulled from its memory, after a translation by the driver itself.</p>
<p>The normalized notification format depends on the <a href="specs/services/hw.html#driven-device-type">device's type (DDT)</a>.</p>
<p>The following list contains all normalized notifications for all DDTs, but is <strong>far from being complete yet</strong>. It will also grow over time as new device types appear on the market and as existing devices evolve to provide new features.</p>
<p><strong>TODO</strong></p>
<h3><a class="header" href="#patterns" id="patterns">Patterns</a></h3>
<p>Several methods of this service use <em>patterns</em>, which allow to match devices depending on several criterias.</p>
<p>A pattern is a data structure whose size varies from 5 to 277 bytes made of the following:</p>
<ul>
<li>Pattern (1 byte)
<ul>
<li>Bit 0: match all connection types</li>
<li>Bit 2: match all buses</li>
<li>Bit 3: match all ports</li>
</ul>
</li>
<li>Connection type (1 byte)</li>
<li>Bus number (1 byte)</li>
<li>Port number (1 byte)</li>
<li>DTD length (1 byte) - <code>0</code> to omit DTD</li>
<li>DTD pattern indicator (16 bytes, only if DTD) - indicates which bytes of the DTD must be used as patterns</li>
<li>DTD (up to 256 bytes)</li>
</ul>
<p>It's possible to match only devices that use a given connection type, and more specifically on a given bus and/or port.</p>
<p>It's also possible to list only devices that match a specific DTD pattern. For that, the bit corresponding to the byte number in the DTD pattern indicator must be set.</p>
<p>For instance, providing the DTD <code>0x0100B2</code> with the DTD pattern indicator set to <code>0b01000000</code>, the second byte will match all devices.</p>
<h2><a class="header" href="#drivers-1" id="drivers-1">Drivers</a></h2>
<p>From a higher level point of view, drivers are <a href="specs/services/../services.html">services</a> that declare themselves as being able to handle certain type of devices through the <a href="specs/services/hw.html#0x10-register_driver"><code>REGISTER_DRIVER</code></a> method, using <a href="specs/services/hw.html#patterns">patterns</a>.</p>
<p>When a device is connected, using multiple criterias <strong>which are yet to be determined</strong>, a driver is selected from the list of drivers able to handle this specific device. This driver process then receives the <a href="specs/services/hw.html#device_event"><code>DEVICE_EVENT</code></a> notification.</p>
<p>From this point, the driver can create an <a href="specs/services/../kernel/memory.html#abstract-memory-segments">AMS</a> from the device's memory using the <a href="specs/services/../kernel/syscalls.html#0x34-device_ams"><code>DEVICE_AMS</code></a> syscall.</p>
<p>It can also get informed of interrupts the device raises through the <a href="specs/services/hw.html#device_interrupt"><code>DEVICE_INTERRUPT</code></a> notification.</p>
<p>Other processes can then ask the driver to perform specific actions depending on the type of device, using <a href="specs/services/hw.html#normalized-methods">normalized methods</a> which can be sent to the driver using the <a href="specs/services/hw.html#0xa0-ask_driver"><code>ASK_DRIVER</code></a> method. The driver receives these informations through the <a href="specs/services/hw.html#driver_method_request"><code>DRIVER_METHOD_REQUEST</code></a> notification.</p>
<p>The driver is also in charge of translating the interrupts of a device as well as eventual events polled from its (mapped) memory to <a href="specs/services/hw.html#normalized-notifications">normalized notifications</a> which can then be sent to processes that subscribed to them using the related <a href="specs/services/hw.html#normalized-methods">normalized methods</a>.</p>
<h3><a class="header" href="#a-note-on-performances" id="a-note-on-performances">A note on performances</a></h3>
<p>Although hardware devices' interrupts are notified to the driver through <a href="specs/services/../kernel/ipc.html#methods-and-notifications">service socket notifications</a>, the latency is still minimal as soon as the driver listens to the <a href="specs/services/../kernel/signals.html#0x27-recv_sock_msg"><code>RECV_SOCK_MSG</code></a> signal, which like all signals uses interrupts and so guarantees a very low latency.</p>
<h2><a class="header" href="#methods-2" id="methods-2">Methods</a></h2>
<h3><a class="header" href="#0x01-enum_devices" id="0x01-enum_devices"><code>0x01</code> ENUM_DEVICES</a></h3>
<p>Enumerate connected devices.</p>
<p>It's also possible to only count the number of devices matching the provided criterias by providing a start index and end index of <code>0</code>.</p>
<p><strong>Required permissions:</strong></p>
<ul>
<li><code>devices.enum</code></li>
</ul>
<p><strong>Arguments:</strong></p>
<ul>
<li>Start index (4 bytes)</li>
<li>End index (4 bytes)</li>
<li><a href="specs/services/hw.html#patterns">Pattern</a> (277 bytes)</li>
</ul>
<p><strong>Answer:</strong></p>
<ul>
<li>Number of found devices globally (4 bytes)</li>
<li>Number of devices listed in this answer (4 bytes)</li>
<li><a href="specs/services/hw.html#driver-device-descriptor">DDD</a> of each device (512 bytes * number of devices)</li>
<li><code>0x01</code> if some devices were masked due to insufficient permissions, <code>0x00</code> else (1 byte)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x10</code>: Start index is lower than the end index</li>
<li><code>0x11</code>: Invalid connection type</li>
<li><code>0x12</code>: Bus number was provided without a connection type</li>
<li><code>0x13</code>: Port number was provided without a connection type</li>
<li><code>0x14</code>: Both bus number and port number were provided</li>
<li><code>0x15</code>: Invalid DTD</li>
<li><code>0x20</code>: Range is greater than the available answer size</li>
<li><code>0x21</code>: Provided bus was not found</li>
<li><code>0x22</code>: Provided port was not found</li>
</ul>
<h3><a class="header" href="#0x02-subscribe_devices" id="0x02-subscribe_devices"><code>0x02</code> SUBSCRIBE_DEVICES</a></h3>
<p>Subscribe to events related to devices matching a patterns.<br />
All current and future devices matching this pattern will cause a <a href="specs/services/hw.html#device_event"><code>DEVICE_EVENT</code></a> notification.</p>
<p><strong>Required permissions:</strong></p>
<ul>
<li><code>devices.subscribe</code></li>
</ul>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>0x00</code> to subscribe, any other value to unsubscribe</li>
<li><a href="specs/services/hw.html#patterns">Pattern</a> (277 bytes)</li>
</ul>
<p><strong>Answer:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Asked to unsubscribe but no subscription is active for this pattern</li>
</ul>
<h3><a class="header" href="#0x10-register_driver" id="0x10-register_driver"><code>0x10</code> REGISTER_DRIVER</a></h3>
<p>Set up a service as a driver for all devices matching a pattern.<br />
If multiple drivers have colliding patterns, the final user will be prompted to choose a driver.</p>
<p>The driver process will receive <a href="specs/services/hw.html#device_event"><code>DEVICE_EVENT</code></a> notifications for drivable devices. This notification will only be sent for devices for which the system chose this driver as the main one.<br />
Notifications are also retroactive, which means they will be sent for already-connected devices.</p>
<p>The driver will also have the device registered in its <a href="specs/services/../kernel/processes.html#drivable-devices">drivable devices attribute</a>, allowing it to use the <a href="specs/services/../kernel/syscalls.html#0x34-device_ams"><code>DEVICE_AMS</code></a> syscall to map the device's memory in its own.</p>
<p><strong>Required permissions:</strong></p>
<ul>
<li><code>devices.register_driver</code></li>
</ul>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/services/hw.html#patterns">Pattern</a> of the devices to drive (277 bytes)</li>
</ul>
<p><strong>Answer:</strong></p>
<p><em>None</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Current process is not a service</li>
<li><code>0x30</code>: Current process is already registered as a driver for this pattern</li>
</ul>
<h3><a class="header" href="#0x11-unregister_driver" id="0x11-unregister_driver"><code>0x11</code> UNREGISTER_DRIVER</a></h3>
<p>Unregister a service <a href="specs/services/hw.html#0x10-register_driver">previously registered as a driver</a>.</p>
<p><strong>Required permissions:</strong></p>
<p><em>None</em></p>
<p><strong>Arguments:</strong></p>
<ul>
<li><a href="specs/services/hw.html#patterns">Pattern</a> to unsubscribe from (277 bytes)</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x30</code>: Current process is not registered as a driver for this pattern</li>
</ul>
<h3><a class="header" href="#0x20-notify_process" id="0x20-notify_process"><code>0x20</code> NOTIFY_PROCESS</a></h3>
<p>Send a notification to a process that registered itself for <a href="specs/services/hw.html#normalized-methods">normalized methods</a> through a <a href="specs/services/hw.html#normalized-methods">normalized method</a>.</p>
<p><strong>Required permissions:</strong></p>
<p><em>None</em></p>
<p><strong>Arguments:</strong></p>
<ul>
<li>Notification ID (8 bytes)</li>
<li><a href="specs/services/hw.html#normalized-notifications"><em>Normalized notification's content</em></a></li>
</ul>
<p><strong>Answer:</strong></p>
<p><em>Expected answer by the notified process for this method if any</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Unknown notification ID</li>
</ul>
<h3><a class="header" href="#0xa0-ask_driver" id="0xa0-ask_driver"><code>0xA0</code> ASK_DRIVER</a></h3>
<p>Ask a <a href="specs/services/hw.html#drivers">driver</a> to use a <a href="specs/services/hw.html#normalized-methods">normalized method</a> on a device it drives.</p>
<p><strong>Required permissions:</strong></p>
<ul>
<li><code>devices.ask_driver</code></li>
</ul>
<p><strong>Arguments:</strong></p>
<ul>
<li>Device's SDI (4 bytes)</li>
<li>Method's code (4 bytes)</li>
<li>Method's arguments (size depends on the method)</li>
</ul>
<p><strong>Answer:</strong></p>
<p><em>Expected answer format for this method</em></p>
<p><strong>Errors:</strong></p>
<ul>
<li><code>0x20</code>: Unknown device SDI provided</li>
<li><code>0x21</code>: Provided method code is invalid for this device</li>
<li><code>0x22</code>: Invalid arguments provided for this method</li>
</ul>
<h2><a class="header" href="#notifications-1" id="notifications-1">Notifications</a></h2>
<h3><a class="header" href="#device_event" id="device_event"><code>DEVICE_EVENT</code></a></h3>
<p>Sent for a specific device to processes that either:</p>
<ul>
<li><a href="specs/services/hw.html#drivers">Drive</a> this specific device</li>
<li>Subscribed to it using the <a href="specs/services/hw.html#0x02-subscribe_devices"><code>SUBSCRIBE_DEVICES</code></a> method</li>
</ul>
<p><strong>Datafield:</strong></p>
<ul>
<li><a href="specs/services/hw.html#driver-device-descriptor">DDD</a> (512 bytes)</li>
<li>Event code (1 byte):
<ul>
<li><code>0x10</code>: device was just connected</li>
<li><code>0x11</code>: a driver was just selected for the device</li>
<li><code>0x12</code>: the device is ready to use</li>
<li><code>0x20</code>: device was disconnected (software)</li>
<li><code>0x21</code>: the device is being disconnected by its driver</li>
<li><code>0x22</code>: the device has been disconnected by the driver</li>
<li><code>0x23</code>: the device was brutally disconnected (hardware)</li>
<li><code>0x30</code>: device was just put to sleep</li>
<li><code>0x31</code>: device was just awoken from sleep</li>
</ul>
</li>
<li>Indicator (1 byte):
<ul>
<li>Bit 0: set if this device is connected for the first time</li>
<li>Bit 1: set if this device was disconnected brutally (not by the system itself)</li>
<li>Bit 2: set if this device is connected for the first time on this specific port</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#device_interrupt" id="device_interrupt"><code>DEVICE_INTERRUPT</code></a></h3>
<p>Sent to a <a href="specs/services/hw.html#drivers">driver</a> after a device it's currently driving raised an interrupt.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Device's SDI (4 bytes)</li>
<li><a href="specs/services/hw.html#normalized-interrupts">Normalized interrupt</a></li>
</ul>
<h3><a class="header" href="#driver_method_request" id="driver_method_request"><code>DRIVER_METHOD_REQUEST</code></a></h3>
<p>Sent to a <a href="specs/services/hw.html#drivers">driver</a> after receiving a valid <a href="specs/services/hw.html#0xa0-ask_driver">normalized method request</a>.</p>
<p>The driver is expected to answer using the relevant answer format for the provided <a href="specs/services/hw.html#normalized-methods">normalized method and arguments</a>.</p>
<p>The <em>notification ID</em> is generated by this service to allow the driver to <a href="specs/services/hw.html#0x20-notify_process">send normalized notifications</a> to a process that registers for it through this method without showing the caller process' PID to the driver process.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li><a href="specs/services/hw.html#driven-device-type">DDT</a> (4 bytes)</li>
<li>Notification ID (8 bytes)</li>
<li>Method's code (4 bytes)</li>
<li>Method's arguments (size depends on the method)</li>
</ul>
<p><strong>Expected answer:</strong></p>
<p><em>Expected answer format for this method if any</em></p>
<h3><a class="header" href="#device_norm_notif" id="device_norm_notif"><code>DEVICE_NORM_NOTIF</code></a></h3>
<p>Sent to a process that subscribed to <a href="specs/services/hw.html#normalized-methods">normalized notifications</a> of a device.<br />
This notification is transferred by the <code>sys::hw</code> service after the driver sent it its content through the <a href="specs/services/hw.html#0x20-notify_process"><code>NOTIFY_PROCESS</code></a> method.</p>
<p><strong>Datafield:</strong></p>
<ul>
<li>Device's SDI (4 bytes)</li>
<li><a href="specs/services/hw.html#normalized-notifications"><em>Normalized notification's content</em></a></li>
</ul>
<h1><a class="header" href="#sysperm-service" id="sysperm-service"><code>sys::perm</code> service</a></h1>
<p>The <code>sys::perm</code> service is used to manage the <a href="specs/services/../../concepts/users.html#user-privileges">privileges</a> of <a href="specs/services/../../concepts/users.html">users</a> and the <a href="specs/services/../../features/permissions.html">permissions</a> of <a href="specs/services/../kernel/processes.html">processes</a>.</p>
<h2><a class="header" href="#the-purpose-of-user-privileges" id="the-purpose-of-user-privileges">The purpose of user privileges</a></h2>
<p>In NightOS, executable instructions can run in three different contexts:</p>
<ul>
<li>In <a href="specs/services/../../concepts/applications.html">applications</a></li>
<li>In <a href="specs/services/../README.html">system services</a></li>
<li>In <a href="specs/services/../kernel/README.html">the kernel itself</a></li>
</ul>
<p>The kernel doesn't have any limitation on what tasks it is allowed to perform, of course, as it is the one to decide.<br />
System services communicate directly with the kernel and are trusted processes so they can do anything <em>in their domain</em>, which means for instance the <a href="specs/services/net.html"><code>sys::net</code></a> cannot ask to manipulate the filesystem, as it's the role of <a href="specs/services/fs.html"><code>sys::fs</code></a>.</p>
<p>But applications, who run <a href="specs/services/../kernel/processes.html"><em>userland processes</em></a> <strong>TODO</strong></p>
<h2><a class="header" href="#list-of-permissions" id="list-of-permissions">List of permissions</a></h2>
<p>The list of permissions can be found in the <a href="specs/services/../permissions.html">dedicated specifications document</a>.</p>
<h2><a class="header" href="#methods-3" id="methods-3">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications-2" id="notifications-2">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#sysnet-service" id="sysnet-service"><code>sys::net</code> service</a></h1>
<h2><a class="header" href="#methods-4" id="methods-4">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications-3" id="notifications-3">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#syscrypto-service" id="syscrypto-service"><code>sys::crypto</code> service</a></h1>
<h2><a class="header" href="#methods-5" id="methods-5">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications-4" id="notifications-4">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#syscrashsave-service" id="syscrashsave-service"><code>sys::crashsave</code> service</a></h1>
<h2><a class="header" href="#methods-6" id="methods-6">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications-5" id="notifications-5">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#sysflow-service" id="sysflow-service"><code>sys::flow</code> service</a></h1>
<h2><a class="header" href="#methods-7" id="methods-7">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications-6" id="notifications-6">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#syshydre-service" id="syshydre-service"><code>sys::hydre</code> service</a></h1>
<h2><a class="header" href="#methods-8" id="methods-8">Methods</a></h2>
<p><strong>TODO</strong></p>
<h2><a class="header" href="#notifications-7" id="notifications-7">Notifications</a></h2>
<p><strong>TODO</strong></p>
<h1><a class="header" href="#native-applications" id="native-applications">Native applications</a></h1>
<p>This folder contains documentation for each native application.</p>
<p><strong>NOTE:</strong> Some documents may not be available at the moment.</p>
<p>Below is the list of applications that are installed (by default) during the installation process.</p>
<h2><a class="header" href="#userland-interactive-applications" id="userland-interactive-applications">Userland interactive applications</a></h2>
<h3><a class="header" href="#basics" id="basics">Basics</a></h3>
<ul>
<li><a href="applications/Nova.html"><em>Nova</em></a> : Desktop environment</li>
<li><a href="applications/BareEnv.html"><em>BareEnv</em></a> : Text-based desktop environment</li>
<li><a href="applications/Comet.html"><em>Comet</em></a> : File manager</li>
<li><a href="applications/Stellar.html"><em>Stellar</em></a> : Application store</li>
<li><a href="applications/Rocket.html"><em>Rocket</em></a> : Web browser</li>
<li><a href="applications/Pluton.html"><em>Pluton</em></a> : Terminal</li>
<li><a href="applications/TimeTravel.html"><em>TimeTravel</em></a> : Backup and versioning program</li>
</ul>
<h3><a class="header" href="#system-utilities" id="system-utilities">System utilities</a></h3>
<ul>
<li><a href="applications/Central.html"><em>Central</em></a> : Settings</li>
<li><a href="applications/Monitor.html"><em>Monitor</em></a> : Monitor opened applications, processes, CPU/RAM usage, etc.</li>
<li><a href="applications/Registry.html"><em>Registry</em></a> : View and edit the registry (for advanced users)</li>
<li><a href="applications/Skyer.html"><em>Skyer</em></a> : Applications manager</li>
<li><a href="applications/Cloudy.html"><em>Cloudy</em></a> : Backup &amp; Sync manager</li>
</ul>
<h3><a class="header" href="#utilities-1" id="utilities-1">Utilities</a></h3>
<ul>
<li><a href="applications/Gravity.html"><em>Gravity</em></a> : Text editor</li>
<li><a href="applications/Thinker.html"><em>Thinker</em></a> : Notes and task lists manager</li>
<li><a href="applications/ShootingStar.html"><em>ShootingStar</em></a> : Pictures viewer and simple editor</li>
<li><a href="applications/Sonata.html"><em>Sonata</em></a> : Music player (with Hi-Res support and options)</li>
<li><a href="applications/Milkshake.html"><em>Milkshake</em></a> : Video player</li>
<li><a href="applications/Blackhole.html"><em>Blackhole</em></a> : Archives manager</li>
<li><a href="applications/Reader.html"><em>Reader</em></a> : A complete e-book reader with many supported formats and options</li>
<li><a href="applications/Postal.html"><em>Postal</em></a> : An e-mail client</li>
</ul>
<h3><a class="header" href="#suites" id="suites">Suites</a></h3>
<ul>
<li><a href="applications/Particle.html"><em>Particle</em></a> : A complete IDE to make applications</li>
<li><a href="applications/Astral.html"><em>Astral</em></a> : The complete toolchain allowing to build applications</li>
</ul>
<h3><a class="header" href="#security" id="security">Security</a></h3>
<ul>
<li><a href="applications/Vortex.html"><em>Vortex</em></a> : Firewall</li>
<li><a href="applications/Locky.html"><em>Locky</em></a> : System's encryption tool, with the ability to manage encrypted archives and volumes</li>
</ul>
<h2><a class="header" href="#system-services-3" id="system-services-3">System services</a></h2>
<p>System services are listed in their own <a href="applications/../specs/services/">specifications directory</a>.</p>
<h1><a class="header" href="#astral" id="astral">Astral</a></h1>
<p>Astral is the toolchain required to build NightOS applications.</p>
<h1><a class="header" href="#bareenv" id="bareenv">BareEnv</a></h1>
<p><em>BareEnv</em>, for <em>bare environment</em>, is text-based desktop environment meant for servers as well as fallback when no graphical output is available or when the primary desktop environment does not work for any reason.</p>
<h1><a class="header" href="#blackhole" id="blackhole">Blackhole</a></h1>
<p>Blackhole is the default archive manager of NightOS. It supports many different archives types (zip, 7z, gzip, etc.).</p>
<h1><a class="header" href="#central" id="central">Central</a></h1>
<p>The <em>Central</em> application delivers the <em>Control Center</em> which allows to configure how the system behaves. It is split into three distinct categories.</p>
<pre><code>&gt; Current user settings
    &gt; User Account
        &gt; Set profile picture
        &gt; Set nickname

    &gt; Change security level
        | Basic
        | Standard
        | Restricted
        | Extreme
        | Total
            ! Only available in developer mode

&gt; Applications management
    &gt; Sideloading
        &gt; Change sideloading mode
            | Disabled
            | Secure
            | Unsecure

&gt; Global settings
    &gt; Date &amp; Time
        &gt; Set date
        &gt; Set time
        &gt; Change timezone
        &gt; Synchronize time

    &gt; Encryption
        &gt; Manage storage encryption
            | Enable
            | Disable

        &gt; Change encryption password
            ! Disabled if storage is not encrypted yet

        &gt; Manage per-user encryption
            | Enable
            | Disable

&gt; Users
    &gt; Create new user
    &gt; Create new administrator user
    &gt; Create new supervised user
</code></pre>
<h2><a class="header" href="#development-related-options" id="development-related-options">Development-related options</a></h2>
<p>This part show settings that are only available in <a href="applications/../technical/dev-mode.html">developer mode</a>.</p>
<pre><code>&gt; Applications
    &gt; Set application proxies
        | Enable
        | Disable
</code></pre>
<h1><a class="header" href="#cloudy" id="cloudy">Cloudy</a></h1>
<p>While the system and main data can be backed up using <a href="applications/TimeTravel.html">TimeTravel</a>, it's not always handy to manage backups on an external hard drive and keep it safe.</p>
<p>This is where Cloudy comes: it allows to synchronize data on the cloud, using a master password which is stored nowhere but in the user's mind.</p>
<h2><a class="header" href="#how-it-works-2" id="how-it-works-2">How it works</a></h2>
<p>In order to work, Cloudy needs a storage account where it can store its data. Multiple providers are supported: Dropbox, Google Drive, Amazon AWS, SFTP storages, etc.</p>
<p>It will then store all data on this account, in a dedicated folder (the path can be customized). All data will be encrypted by a <em>master password</em> prompted when the application is opened for the first time, so no one will be able to access these date except the user who set it up itself.</p>
<h2><a class="header" href="#integration-1" id="integration-1">Integration</a></h2>
<p>Applications can ask to store and synchronize their own data through Cloudy. They will not be able to access any other application's data, though.</p>
<h2><a class="header" href="#collected-data" id="collected-data">Collected data</a></h2>
<p>The data that can be backup-ed and synchronized by Cloudy are:</p>
<ul>
<li>User's settings, computer's settings if the user is administrator</li>
<li>Installed applications and their data</li>
<li>Applications can ask to store additional custom data (e.g. a password manager)</li>
</ul>
<h2><a class="header" href="#synchronization-1" id="synchronization-1">Synchronization</a></h2>
<p>The synchronization process has two parts:</p>
<ul>
<li>The <strong>up-sync</strong> process, which sends new data to the cloud ;</li>
<li>The <strong>down-sync</strong> process, which reflects these changes on the local computer</li>
</ul>
<p>Up-sync can be performed manually at anytime, or scheduled to be performed frequently. It's also possible to ask, for instance, to update the list of applications when a new one is installed or removed, while only backuping applications' data once a day.</p>
<p>Down-sync can be performed anytime, and a preview will show which items will be restored and what will be overridden. It's possible to only restore a few items. By default, down-sync will be performed in real-time: as soon as an up-sync process is performed, down-sync will happen on every other computer of the synchronization chain.</p>
<h2><a class="header" href="#synchronization-chain" id="synchronization-chain">Synchronization chain</a></h2>
<p>Data are synchronized through all computers of a single <em>synchronization chain</em>, which is simply a set of computers. Synchronization happens per user, which is why Cloudy doesn't backup every user of the computer, but only the one synchronization is enabled on. Of course, every user can enable synchronization for its account.</p>
<p>When a user enabled Cloudy for its account, it must connect with a NightOS account, and it is then added to the synchronization chain consisting of every computer having Cloudy enabled with this NightOS account.</p>
<p>For down-sync to happen, the username must be on the receiving computers than on the upload computer, else a specific setting will need to be changed in Cloudy.</p>
<h1><a class="header" href="#comet" id="comet">Comet</a></h1>
<p>Comet is the default file manager of NightOS.</p>
<h1><a class="header" href="#gravity" id="gravity">Gravity</a></h1>
<p>Gravity is a text editor featuring syntax highlighting for code.</p>
<h1><a class="header" href="#locky" id="locky">Locky</a></h1>
<p>Locky is NightOS' encryption tool. It is used to <a href="applications/../features/encryption.html#global-encryption">encrypt the whole storage</a> and <a href="applications/../features/encryption.html#per-user-encryption">encrypt individual users' data</a>.</p>
<h1><a class="header" href="#milkshake" id="milkshake">Milkshake</a></h1>
<p>Milkshake is the default video player of NightOS.</p>
<h1><a class="header" href="#monitor" id="monitor">Monitor</a></h1>
<p>Monitor allows to see and manage running applications and processes, as well as to watch resources usage like CPU percentage or used RAM.</p>
<h1><a class="header" href="#nova" id="nova">Nova</a></h1>
<p>Nova is the desktop environment of NightOS.</p>
<h1><a class="header" href="#particle" id="particle">Particle</a></h1>
<p>Particle is a complete IDE for making NightOS applications. It uses the <a href="applications/Astral.html">Astral</a> toolchain.</p>
<h1><a class="header" href="#pluton" id="pluton">Pluton</a></h1>
<p>Pluton is the default terminal of NightOS. It features a strong integration of <a href="applications/../technical/shell.html">Hydre</a>.</p>
<h1><a class="header" href="#postal" id="postal">Postal</a></h1>
<p>Postal is the default e-mail client of NightOS.</p>
<h1><a class="header" href="#reader" id="reader">Reader</a></h1>
<p>Reader is an e-book reader with supports for comics. It can also manage libraries of books.</p>
<h1><a class="header" href="#registry-2" id="registry-2">Registry</a></h1>
<p>Registry allows to view and edit the <a href="applications/../technical/registry.html">registry</a>. It is reserved to advanced users.</p>
<h1><a class="header" href="#rocket" id="rocket">Rocket</a></h1>
<p>Rocket is the default web browser of NightOS.</p>
<h1><a class="header" href="#shootingstar" id="shootingstar">ShootingStar</a></h1>
<p>ShootingStar is the default pictures viewer and editor of NightOS. Edition is limited to simple manipulations such as cropping and resizing.</p>
<h1><a class="header" href="#skyer" id="skyer">Skyer</a></h1>
<p>Skyer is the applications manager of NightOS. It allows to install and remove applications, as well as to manage their permissions and enable <a href="applications/../technical/dev-mode.html#application-proxies">application proxies</a> in developer mode.</p>
<h1><a class="header" href="#sonata" id="sonata">Sonata</a></h1>
<p>Sonata is the default music player of NightOS. It features support for Hi-Res audio files and can play many different formats (e.g. 32 bits / 384 kHz FLAC, DSD, ...). It also supports bit-to-bit playing to USB DACs.</p>
<h1><a class="header" href="#stellar" id="stellar">Stellar</a></h1>
<h1><a class="header" href="#thinker" id="thinker">Thinker</a></h1>
<p>Thinker is a simple notes application.</p>
<h1><a class="header" href="#timetravel" id="timetravel">TimeTravel</a></h1>
<p>TimeTravel is the backup and versioning program of NightOS.</p>
<h1><a class="header" href="#vortex" id="vortex">Vortex</a></h1>
<p>Vortex is NightOS' built-in firewall. It can also be used in combination with <a href="applications/../features/parental-control.html#restrict-access-to-websites">parental control</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
